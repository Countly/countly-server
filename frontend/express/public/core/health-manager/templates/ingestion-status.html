<div v-bind:class="[componentId]" class="ingestion-status-view">
    <cly-main>
        <!-- Loading state -->
        <div v-if="isLoading && !hasFetched" v-loading="true" class="bu-p-5" style="min-height: 200px;">
        </div>

        <!-- Error state -->
        <cly-notification
            v-if="hasError && hasFetched"
            :text="i18n('health-manager.error.fetch-failed')"
            color="light-destructive"
            :closable="false"
            class="bu-mb-4"
        >
        </cly-notification>

        <!-- ClickHouse Consumer Section -->
        <template v-if="hasFetched">
            <!-- Connect monitoring not enabled -->
            <cly-section v-if="!connectEnabled && sinkConsumers.length === 0" :title="i18n('ingestion-status.clickhouse-consumer.title')" :tooltip="i18n('ingestion-status.clickhouse-consumer.tooltip')">
                <div class="bu-has-text-centered bu-p-5 color-cool-gray-50">
                    <i class="el-icon-warning-outline bu-mr-2"></i>
                    <span>{{ i18n('ingestion-status.not-enabled') }}</span>
                </div>
            </cly-section>

            <!-- Connect Summary Cards (only if enabled) -->
            <template v-if="connectEnabled">
                <cly-section :title="i18n('ingestion-status.clickhouse-consumer.title')" :tooltip="i18n('ingestion-status.clickhouse-consumer.tooltip')">
                    <cly-metric-cards :multiline="true">
                        <cly-metric-card
                            v-for="card in connectSummaryCards"
                            :key="card.title"
                            color="#097EFF">
                            <template v-slot:default>
                                {{ card.title }}
                                <cly-tooltip-icon v-if="card.tooltip" class="bu-ml-1" :tooltip="card.tooltip"></cly-tooltip-icon>
                            </template>
                            <template v-slot:number>
                                <span :class="card.numberClass || ''">{{ card.value }}</span>
                            </template>
                            <template v-slot:description>
                                <span class="text-small color-cool-gray-100">{{ card.detail }}</span>
                            </template>
                        </cly-metric-card>
                    </cly-metric-cards>
                </cly-section>

                <!-- Sink Lag History Chart -->
                <cly-section v-if="throughputHistory.length > 0" :title="i18n('ingestion-status.lag-history.title')" :tooltip="i18n('ingestion-status.lag-history.tooltip')">
                    <cly-chart-line
                        :option="throughputChartOption"
                        :height="300"
                        :show-zoom="true"
                        :show-download="true">
                    </cly-chart-line>
                </cly-section>

                <!-- Connectors Table -->
                <cly-section v-if="hasConnectorData" :title="i18n('ingestion-status.connectors.title')" :tooltip="i18n('ingestion-status.connectors.tooltip')">
                    <cly-datatable-n :rows="connectors" :resizable="true" :force-loading="isLoading">
                        <template v-slot="scope">
                            <el-table-column column-key="connectorName" prop="connectorName" sortable="custom" :label="i18n('ingestion-status.table.connector')" min-width="200">
                                <template v-slot="rowScope">
                                    <span class="text-medium font-weight-bold">{{ rowScope.row.connectorName }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="connectorState" prop="connectorState" sortable="custom" :label="i18n('ingestion-status.table.state')" min-width="100">
                                <template v-slot="rowScope">
                                    <span :class="getConnectorStateClass(rowScope.row.connectorState)">
                                        {{ rowScope.row.connectorState }}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="connectorType" prop="connectorType" sortable="custom" :label="i18n('ingestion-status.table.type')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ rowScope.row.connectorType }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="tasks" prop="tasksRunning" sortable="custom" :label="i18n('ingestion-status.table.tasks')" min-width="100">
                                <template v-slot="rowScope">
                                    <span :class="rowScope.row.tasksRunning === rowScope.row.tasksTotal ? 'color-green-100' : 'color-yellow-100'">
                                        {{ rowScope.row.tasksRunning }} / {{ rowScope.row.tasksTotal }}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="workerId" prop="workerId" :label="i18n('ingestion-status.table.worker')" min-width="200">
                                <template v-slot="rowScope">
                                    <span class="text-small">{{ rowScope.row.workerId || '-' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="updatedAt" prop="updatedAt" sortable="custom" :label="i18n('ingestion-status.table.last-update')" min-width="160">
                                <template v-slot="rowScope">
                                    <span>{{ formatDate(rowScope.row.updatedAt) }}</span>
                                </template>
                            </el-table-column>
                        </template>
                    </cly-datatable-n>
                </cly-section>

                <!-- No Connector data message (enabled but no data yet) -->
                <cly-section v-if="!hasConnectorData" :title="i18n('ingestion-status.connectors.title')">
                    <div class="bu-has-text-centered bu-p-5 color-cool-gray-50">
                        <i class="el-icon-info bu-mr-2"></i>
                        <span>{{ i18n('ingestion-status.connectors.no-data') }}</span>
                    </div>
                </cly-section>

                <!-- Sink Consumer Group Details -->
                <cly-section v-if="sinkConsumers.length > 0" :title="i18n('ingestion-status.consumer-group.title')" :tooltip="i18n('ingestion-status.consumer-group.tooltip')">
                    <cly-datatable-n :rows="sinkConsumers" :resizable="true" :force-loading="isLoading">
                        <template v-slot="scope">
                            <el-table-column column-key="groupId" prop="groupId" sortable="custom" :label="i18n('aggregator-status.table.group-id')" min-width="180">
                                <template v-slot="rowScope">
                                    <span class="text-medium font-weight-bold">{{ rowScope.row.groupId }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="totalLag" prop="totalLag" sortable="custom" :label="i18n('aggregator-status.table.total-lag')" min-width="100">
                                <template v-slot="rowScope">
                                    <span :class="getLagClass(rowScope.row.totalLag)">{{ formatNumber(rowScope.row.totalLag) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="rebalanceCount" prop="rebalanceCount" sortable="custom" :label="i18n('aggregator-status.table.rebalances')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ rowScope.row.rebalanceCount || 0 }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lastRebalanceAt" prop="lastRebalanceAt" sortable="custom" :label="i18n('aggregator-status.table.last-rebalance')" min-width="160">
                                <template v-slot="rowScope">
                                    <span>{{ formatDate(rowScope.row.lastRebalanceAt) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="commitCount" prop="commitCount" sortable="custom" :label="i18n('aggregator-status.table.commits')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ formatNumber(rowScope.row.commitCount || 0) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lastCommitAt" prop="lastCommitAt" sortable="custom" :label="i18n('aggregator-status.table.last-commit')" min-width="160">
                                <template v-slot="rowScope">
                                    <span>{{ formatDate(rowScope.row.lastCommitAt) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="errorCount" prop="errorCount" sortable="custom" :label="i18n('aggregator-status.table.errors')" min-width="80">
                                <template v-slot="rowScope">
                                    <span :class="getErrorClass(rowScope.row.errorCount)">{{ rowScope.row.errorCount || 0 }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lastErrorMessage" prop="lastErrorMessage" :label="i18n('aggregator-status.table.last-error')" min-width="200">
                                <template v-slot="rowScope">
                                    <div v-if="rowScope.row.lastErrorMessage" class="has-ellipsis" v-tooltip="{content: rowScope.row.lastErrorMessage}">
                                        <span class="text-small color-red-100">{{ rowScope.row.lastErrorMessage }}</span>
                                    </div>
                                    <span v-else class="color-cool-gray-50">-</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lagUpdatedAt" prop="lagUpdatedAt" sortable="custom" :label="i18n('aggregator-status.table.lag-updated')" min-width="160">
                                <template v-slot="rowScope">
                                    <span>{{ formatDate(rowScope.row.lagUpdatedAt) }}</span>
                                </template>
                            </el-table-column>
                        </template>
                    </cly-datatable-n>
                </cly-section>

                <!-- Sink Processing Stats -->
                <cly-section v-if="sinkPartitions.length > 0" :title="i18n('ingestion-status.processing-stats.title')" :tooltip="i18n('ingestion-status.processing-stats.tooltip')">
                    <cly-datatable-n :rows="sinkPartitions" :resizable="true" :force-loading="isLoading">
                        <template v-slot="scope">
                            <el-table-column column-key="consumerGroup" prop="consumerGroup" sortable="custom" :label="i18n('aggregator-status.table.consumer-group')" min-width="150">
                            </el-table-column>
                            <el-table-column column-key="topic" prop="topic" sortable="custom" :label="i18n('aggregator-status.table.topic')" min-width="180">
                            </el-table-column>
                            <el-table-column column-key="partitionCount" prop="partitionCount" sortable="custom" :label="i18n('aggregator-status.table.partitions')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ rowScope.row.activePartitions || 0 }} / {{ rowScope.row.partitionCount || 0 }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="batchCount" prop="batchCount" sortable="custom" :label="i18n('aggregator-status.table.batches')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ formatNumber(rowScope.row.batchCount) }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="duplicatesSkipped" prop="duplicatesSkipped" sortable="custom" :label="i18n('aggregator-status.table.dedup')" min-width="80">
                                <template v-slot="rowScope">
                                    <span :class="rowScope.row.duplicatesSkipped > 0 ? 'color-yellow-100' : ''">{{ rowScope.row.duplicatesSkipped || 0 }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="avgBatchSize" prop="avgBatchSize" sortable="custom" :label="i18n('aggregator-status.table.avg-batch')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ rowScope.row.avgBatchSize || '-' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lastBatchSize" prop="lastBatchSize" sortable="custom" :label="i18n('aggregator-status.table.last-batch')" min-width="100">
                                <template v-slot="rowScope">
                                    <span>{{ rowScope.row.lastBatchSize || '-' }}</span>
                                </template>
                            </el-table-column>
                            <el-table-column column-key="lastProcessedAt" prop="lastProcessedAt" sortable="custom" :label="i18n('aggregator-status.table.last-processed')" min-width="160">
                                <template v-slot="rowScope">
                                    <span>{{ formatDate(rowScope.row.lastProcessedAt) }}</span>
                                </template>
                            </el-table-column>
                        </template>
                    </cly-datatable-n>
                </cly-section>
            </template>
        </template>
    </cly-main>
</div>
