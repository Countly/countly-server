<div v-bind:class="[componentId]" class="mutation-status-view">
    <cly-main>
        <div class="bu-mb-4">
            <cly-notification
                v-if="hasError"
                :text="i18n('health-manager.error.fetch-failed')"
                color="light-destructive"
                :closable="false"
            >
            </cly-notification>
            <cly-notification
                v-if="!clickhouseHealthy && showClickhouseMetrics"
                :text="i18n('mutation-status.alert.clickhouse-unhealthy')"
                color="light-warning"
                :closable="false"
            >
            </cly-notification>
            <cly-notification
                v-if="(mutationSummary.failed || 0) > 0"
                :text="i18n('mutation-status.alert.failed-tasks')"
                color="light-destructive"
                :closable="false"
            >
            </cly-notification>
        </div>
        <cly-section v-if="showClickhouseMetrics" :title="i18n('mutation-status.metrics.title')" :tooltip="i18n('mutation-status.metrics.tooltip')">
            <cly-metric-cards :multiline="true">
                <cly-metric-card
                    v-for="card in systemCards"
                    :key="card.title"
                    color="#097EFF">
                    <template v-slot:default>
                        {{ card.title }}
                        <cly-tooltip-icon v-if="card.tooltip" class="bu-ml-1" :tooltip="card.tooltip"></cly-tooltip-icon>
                    </template>
                    <template v-slot:number>
                        <span :class="card.numberClass || ''">{{ card.value != null ? String(card.value).toUpperCase() : '-' }}</span>
                    </template>
                    <template v-slot:description>
                        <span class="text-small color-cool-gray-600">{{ card.detail }}</span>
                    </template>
                </cly-metric-card>
            </cly-metric-cards>
        </cly-section>

        <cly-section :title="i18n('mutation-status.summary.title')" :tooltip="i18n('mutation-status.summary.tooltip')">
            <cly-chart-bar :option="summaryBarOption" :showToggle="false" :noEmpty="true" v-loading="isLoading"></cly-chart-bar>
        </cly-section>

        <cly-section :title="i18n('mutation-status.table.title')" :tooltip="i18n('mutation-status.table.tooltip')">
            <cly-datatable-n :rows="mutationStatusData" :force-loading="isLoading">
                <template v-slot:header-left>
                    <cly-dropdown ref="filterDropdown" :width="320" @hide="onFilterCancel" @show="onFilterShow">
                        <template v-slot:trigger="dropdown">
                            <cly-input-dropdown-trigger
                                v-tooltip="filterSummaryText"
                                :selected-options="filterSummaryText"
                                :focused="dropdown.focused"
                                :opened="dropdown.visible"
                                :adaptive-length="true">
                            </cly-input-dropdown-trigger>
                        </template>
                        <template>
                            <cly-form
                                :key="filterFormKey"
                                :initial-edited-object="filterForm"
                                ref="filterForm"
                                @submit="onFilterApply">
                                <template v-slot="formScope">
                                    <cly-form-step id="filter-form-step">
                                        <div class="bu-m-4">
                                            <div class="bu-level">
                                                <div class="bu-level-left">
                                                    <div class="bu-level-item">
                                                        <h4>{{ i18n('mutation-status.filters.title') }}</h4>
                                                    </div>
                                                </div>
                                                <div class="bu-level-right">
                                                    <div class="bu-level-item">
                                                        <el-button type="text" class="cly-multi-select__reset" @click="onFilterReset">
                                                            {{ i18n('mutation-status.filters.reset') }}
                                                        </el-button>
                                                    </div>
                                                </div>
                                            </div>
                                            <cly-form-field :label="i18n('mutation-status.filters.status')">
                                                <el-select v-model="formScope.editedObject.status" :placeholder="i18n('mutation-status.filters.status-all')" class="select-full-width" placement="bottom-start" clearable>
                                                    <el-option v-for="option in statusOptions" :key="option.value" :label="option.label" :value="option.value"></el-option>
                                                </el-select>
                                            </cly-form-field>
                                            <cly-form-field :label="i18n('mutation-status.filters.db')">
                                                <el-select v-model="formScope.editedObject.db" clearable :placeholder="i18n('mutation-status.filters.db-all')" class="select-full-width" placement="bottom-start">
                                                    <el-option v-for="value in availableDbs" :key="value" :label="value === 'all' ? i18n('mutation-status.filters.db-all') : value" :value="value"></el-option>
                                                </el-select>
                                            </cly-form-field>
                                            <cly-form-field :label="i18n('mutation-status.filters.collection')">
                                                <el-select v-model="formScope.editedObject.collection" clearable :placeholder="i18n('mutation-status.filters.collection-all')" class="select-full-width" placement="bottom-start">
                                                    <el-option v-for="value in availableCollections" :key="value" :label="value === 'all' ? i18n('mutation-status.filters.collection-all') : value" :value="value"></el-option>
                                                </el-select>
                                            </cly-form-field>
                                            <cly-form-field :label="i18n('mutation-status.filters.type')">
                                                <el-select v-model="formScope.editedObject.type" clearable :placeholder="i18n('mutation-status.filters.type-all')" class="select-full-width" placement="bottom-start">
                                                    <el-option v-for="value in availableTypes" :key="value" :label="value === 'all' ? i18n('mutation-status.filters.type-all') : value" :value="value"></el-option>
                                                </el-select>
                                            </cly-form-field>
                                            <div class="bu-has-text-right bu-pt-3">
                                                <el-button type="secondary" @click="onFilterCancel">{{ i18n('common.cancel') }}</el-button>
                                                <el-button type="success" @click="formScope.submit()">{{ i18n('common.apply') }}</el-button>
                                            </div>
                                        </div>
                                    </cly-form-step>
                                </template>
                            </cly-form>
                        </template>
                    </cly-dropdown>
                </template>
                <template v-slot="scope">
                    <el-table-column fixed="left" width="150" sortable="custom" prop="status" :label="i18n('mutation-status.table.status')">
                        <template v-slot="rowScope">
                            <div v-tooltip="rowScope.row.status === 'completed' ? i18n('mutation-status.table.completed-at', formatDate(rowScope.row.mutation_completion_ts)) : (rowScope.row.status || '').toUpperCase()">
                                <cly-status-tag
                                    :text="(rowScope.row.status || '').toUpperCase()"
                                    :color="rowScope.row.status === 'failed' ? 'red' : (rowScope.row.status === 'completed' ? 'green' : 'yellow')">
                                </cly-status-tag>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="db" :label="i18n('mutation-status.table.database')" min-width="180">
                        <template v-slot="rowScope">
                            <div> {{ rowScope.row.db }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="collection" :label="i18n('mutation-status.table.collection')" min-width="200">
                        <template v-slot="rowScope">
                            <div> {{ rowScope.row.collection }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="query" :label="i18n('mutation-status.table.query')" min-width="320">
                        <template v-slot="rowScope">
                            <div v-tooltip="{content: JSON.stringify(rowScope.row.query)}">
                                <code> {{ rowScope.row.query }} </code>
                            </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="type" :label="i18n('mutation-status.table.type')" min-width="140">
                        <template v-slot="rowScope">
                            <div class="text-medium font-weight-bold"> {{ (rowScope.row.type || '').toUpperCase() }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="ts" :label="i18n('mutation-status.table.timestamp')" min-width="200">
                        <template v-slot="rowScope">
                            <div> {{ formatDate(rowScope.row.ts) }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="running" :label="i18n('mutation-status.table.running')" min-width="140">
                        <template v-slot="rowScope">
                            <div> {{ rowScope.row.running }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="error" :label="i18n('mutation-status.table.error')" min-width="280">
                        <template v-slot="rowScope">
                            <div class="has-ellipsis" v-tooltip="{content: rowScope.row.error}"> {{ rowScope.row.error }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="fail_count" :label="i18n('mutation-status.table.attempts')" min-width="140">
                        <template v-slot="rowScope">
                            <div> {{ rowScope.row.fail_count }} </div>
                        </template>
                    </el-table-column>
                    <el-table-column sortable="custom" prop="retry_at" :label="i18n('mutation-status.table.retry-at')" min-width="200">
                        <template v-slot="rowScope">
                            <div> {{ formatDate(rowScope.row.retry_at) }} </div>
                        </template>
                    </el-table-column>
                </template>
            </cly-datatable-n>
        </cly-section>
    </cly-main>
</div>
