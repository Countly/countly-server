<div v-bind:class="[componentId]" class="app-management-view">
    <cly-header>
        <template v-slot:header-left>
            <h2> {{i18n('management-applications.title')}} </h2>
        </template>
        <template v-if="!firstApp" v-slot:header-right>
            <el-button type="success" icon="el-icon-circle-plus" @click="createNewApp">{{i18n('common.add-new-app-button')}}</el-button>
        </template>
    </cly-header>
    <cly-main class="bu-pt-4">
        <div class="bu-columns bu-is-gapless">
            <div v-if="!firstApp" class="bu-column bu-is-3 bu-mr-5 app-management-list" style="max-height:681px">
                <cly-listbox
                    skin="jumbo"
                    height="624"
                    :searchPlaceholder="i18n('common.search')"
                    :options="appList"
                    :searchable="true"
                    v-model="selectedSearchBar">
                        <template v-slot:option-prefix="option">
                            <div class="cly-vue-sidebar__app-image bu-mt-2" :style="{backgroundImage: 'url(' + apps[option.value].image + ')'}"></div>
                        </template>
                    </cly-listbox>
            </div>
            <div v-if="firstApp" class="bu-column bu-is-1"></div>
            <div v-if="firstApp" class="bu-column bu-is-3 bu-mr-5">
                <h1>{{i18n("management-applications.create-first-app-title")}}</h1>
                <p>{{i18n("management-applications.create-first-app-description")}}</p>
            </div>
            <div v-if="firstApp" class="bu-column bu-is-1"></div>
            <div :class="{'bu-column':true, 'bu-is-6':firstApp}">
                <cly-more-options v-if="!newApp" size="small" class="bu-is-pulled-right" @command="handleMenuCommand">
                    <el-dropdown-item :disabled="isDisabled()" :key="idx" v-for="(item, idx) in topOptions" :divided="item.divided" :command="item.value">
                        <el-link :disabled="isDisabled()" class="bu-ml-1">{{item.label}}</el-link>
                    </el-dropdown-item>
                </cly-more-options>
                <el-switch
                    v-if="!newApp"
                    v-model="apps[selectedApp].locked"
                    :active-text="apps[selectedApp].locked ? i18n('common.locked') : i18n('common.unlocked')"
                    @change="setAppLock"
                    class="bu-is-pulled-right bu-mr-4 bu-mt-2">
                </el-switch>
                <h2 class="bu-mb-4"> {{apps[selectedApp] ? apps[selectedApp].name : i18n('common.add-new-app')}} </h2>
                <cly-section>
                    <div class="bu-columns bu-m-0">
                        <div class="bu-column bu-is-8 bu-mr-4">
                            <cly-form
                                :initial-edited-object="apps[selectedApp] || newApp"
                                @submit="save">
                                <template v-slot="formScope">
                                    <cly-form-step :id="formId">
                                        <cly-inline-form-field rules="required" :label="i18n('management-applications.application-name')" prop="name">
                                            <el-input 
                                                :disabled="isDisabled()"
                                                :placeholder="i18n('management-applications.application-name')" 
                                                v-model="formScope.editedObject.name">
                                            </el-input>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field rules="required" :label="i18n('management-applications.type')" :help="i18n('management-applications.type.hint')" prop="type">
                                            <el-select 
                                                :disabled="isDisabled()"
                                                :placeholder="i18n('management-applications.type')" 
                                                v-model="formScope.editedObject.type" >
                                                <el-option :key="type" :value="type" :label="i18n('management-applications.types.' + type)" v-for="(item, type) in types"></el-option>
                                            </el-select>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field :rules="(!newApp) ? 'required' : ''" :label="i18n('management-applications.app-key')" prop="key" :help="i18n('management-applications.app-key.hint')">
                                            <el-input 
                                                :readonly="isDisabled()"
                                                onclick="select()"
                                                :placeholder="i18n(newApp ? 'management-applications.app-key.generate' : 'management-applications.app-key')" 
                                                v-model="formScope.editedObject.key">
                                            </el-input>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field rules="required" :label="i18n('countries.table.country')" prop="country" :help="i18n('management-applications.country.hint')">
                                            <cly-select-x 
                                                :disabled="isDisabled()"
                                                :placeholder="i18n('countries.table.country')" 
                                                v-model="formScope.editedObject.country" 
                                                :options="countries">
                                            </cly-select-x>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field rules="required" :label="i18n('management-applications.time-zone')" prop="timezone"  :help="i18n('management-applications.time-zone.hint')">
                                            <cly-select-x 
                                                :disabled="isDisabled()"
                                                :placeholder="i18n('management-applications.time-zone')" 
                                                v-model="formScope.editedObject.timezone" 
                                                :options="timezones">
                                            </cly-select-x>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field :label="i18n('management-applications.checksum-salt')" prop="salt"  :help="i18n('management-applications.checksum-salt.hint')">
                                            <el-input 
                                                :disabled="isDisabled()"
                                                :placeholder="i18n('management-applications.checksum-salt')" 
                                                v-model="formScope.editedObject.salt">
                                            </el-input>
                                        </cly-inline-form-field>
                                        <cly-inline-form-field v-if="!newApp" :label="i18n('management-applications.app-id')" prop="_id"  :help="i18n('management-applications.app-id.hint')">
                                            <el-input 
                                                readonly 
                                                onclick="select()"
                                                :placeholder="i18n('management-applications.app-id')" 
                                                v-model="formScope.editedObject._id">
                                            </el-input>
                                        </cly-inline-form-field>
                                    </cly-form-step>
                                    <div class="bu-has-text-right" @mouseenter="formScope.validate()">
                                        <el-button 
                                            :disabled="isDisabled() || !formScope.isSubmissionAllowed" 
                                            @click="formScope.submit()" 
                                            type="primary">{{i18n( newApp ? 'common.create' : 'common.apply')}}</el-button>
                                    </div>
                                </template>
                            </cly-form>
                        </div>
                        <div v-if="!firstApp" class="bu-column bu-is-3 bu-ml-4 bu-px-4 bu-py-0 account-settings-avatar-box">
                            <div v-if="!newApp" class="bu-is-vcentered bu-px-3 bu-ml-4">
                                <el-upload 
                                    v-if="!isDisabled()"
                                    action="apps/icon" 
                                    :on-success="handleUploadSuccess"
                                    :data="uploadData"
                                    :show-file-list="true"
                                    :limit="1"
                                    name="app_image"
                                    accept="image/png, image/jpeg, image/gif"
                                    class="bu-is-pulled-right">
                                    <el-button size="small" type="text" class="bu-p-0">{{i18n('user-settings.upload')}}</el-button>
                                </el-upload>
                                <p class="bu-has-text-weight-medium">{{i18n('management-applications.icon')}}</p>
                                <div>
                                    <div class="account-settings-avatar" :style="app_icon">
                                    </div>
                                </div>
                                <p>&nbsp;</p>
                                <p class="account-upload-instructions">{{i18n('management-applications.icon-error')}}</p>
                            </div>
                        </div>
                    </div>
                </cly-section>
                <cly-section>
                    <el-collapse v-if="!newApp" class="bu-mx-4 app-management-details" @change="loadDetails">
                        <el-collapse-item :title="i18n('management-applications.app-details')" name="1">
                            <div v-if="appDetails">
                                <cly-inline-form-field :label="i18n('management-applications.app-creator')">
                                    <div v-if="appDetails.app.owner === '' || appDetails.app.owner_id === ''">{{i18n("common.unknown")}}</div>
                                    <a v-else :href="'#/manage/users/' + appDetails.app.owner_id">{{appDetails.app.owner}}</a>
                                </cly-inline-form-field>
                                <cly-inline-form-field :label="i18n('management-applications.app-created-at')">
                                    <div v-html="appDetails.app.created"></div>
                                </cly-inline-form-field>
                                <cly-inline-form-field :label="i18n('management-applications.app-edited-at')">
                                    <div v-html="appDetails.app.edited"></div>
                                </cly-inline-form-field>
                                <cly-inline-form-field :label="i18n('management-applications.app-last-data')">
                                    {{appDetails.app.last_data}}
                                </cly-inline-form-field>
                                <h6 class="bu-mt-4">{{i18n("management-applications.app-users")}}</h6>
                                <cly-inline-form-field :label="i18n('management-applications.global_admins')">
                                    <a :href="'#/manage/users/' + user._id" v-for="user in appDetails.global_admin" class="el-button el-button--primary is-plain">
                                    {{user.full_name || user.username || user._id}}
                                    </a>&nbsp;
                                </cly-inline-form-field>
                                <cly-inline-form-field :label="i18n('management-applications.admins')">
                                    <a :href="'#/manage/users/' + user._id" v-for="user in appDetails.admin" class="el-button el-button--primary is-plain">
                                    {{user.full_name || user.username || user._id}}
                                    </a>&nbsp;
                                </cly-inline-form-field>
                                <cly-inline-form-field :label="i18n('management-applications.users')">
                                    <a :href="'#/manage/users/' + user._id" v-for="user in appDetails.user" class="el-button el-button--primary is-plain">
                                    {{user.full_name || user.username || user._id}}
                                    </a>&nbsp;
                                </cly-inline-form-field>
                            </div>
                            <div v-else v-loading="true" style="height: 500px;"></div>
                        </el-collapse-item>
                    </el-collapse>
                </cly-section>
                <h2 class="bu-mb-2" v-if="!newApp" >{{i18n('management-applications.plugins')}} </h2>
                <cly-section v-if="!newApp" >
                    <el-collapse class="bu-mx-4 app-management-details">
                        <el-collapse-item :title="value.title" :name="id" :key="id" v-for="(value, id) in appSettings">
                            <component v-if="value.component" v-bind:is="value.component" @change="onChange"></component>
                            <cly-inline-form-field v-else :key="key" :label="getLabelName(key)" v-for="(conf, key) in value.inputs">
                                    <el-input
                                        v-if="conf.input === 'el-input'" 
                                        @input="onChange(key, $event)"
                                        :value="conf.value"
                                        v-bind="conf.attrs"
                                        >
                                    </el-input>
                                    <el-select 
                                        v-else-if="conf.input === 'el-select'" 
                                        @change="onChange(key, $event)"
                                        :value="conf.value"
                                        v-bind="conf.attrs">
                                        <el-option :key="option.value" :value="option.value" :label="option.label" v-for="option in conf.list"></el-option>
                                    </el-select>
                                    <el-slider 
                                        v-else-if="conf.input === 'el-slider'" 
                                        @change="onChange(key, $event)"
                                        :value="conf.value"
                                        v-bind="conf.attrs">
                                    </el-slider>
                                    <el-button
                                        v-else-if="conf.input === 'el-button'" 
                                        @click="conf.click()"
                                        v-bind="conf.attrs">
                                        {{conf.label}}
                                    </el-button>
                                    <el-switch 
                                        v-else-if="conf.input === 'el-switch'"
                                        @change="onChange(key, $event)"
                                        :value="conf.value"
                                        v-bind="conf.attrs">
                                    </el-switch>
                                    <el-input-number 
                                        v-else-if="conf.input === 'el-input-number'" 
                                        @change="onChange(key, $event)"
                                        :max='2147483647' 
                                        :min='0' 
                                        :value="conf.value"
                                        v-bind="conf.attrs">
                                    </el-input-number>
                                    <el-input 
                                        v-else
                                        @input="onChange(key, $event)"
                                        :value="conf.value">
                                    </el-input>
                                </cly-inline-form-field>
                        </el-collapse-item>
                    </el-collapse>
                </cly-section>
                <el-card class="box-card" v-if="!newApp" >
                    <h3>{{i18n('common.integrate-sdks')}}</h3>
                    <p>{{i18n('common.integrate-sdks-text')}}</p>
                    <p class="select-platforms">{{i18n('common.integrate-sdks-platforms')}}</p>
                    <div v-if="sdks" class="sdks">
                        <a :href="'http://code.count.ly/integration-' + code + '.html?server=' + server + '&app_key=' + apps[selectedApp].key" target='_blank' v-for="(value, code) in sdks" class="el-button el-button--primary is-plain">{{value.name.replace("SDK", "")}}</a>&nbsp;
                    </div>
                </el-card>
            </div>
        </div>
        <cly-diff-helper :diff="Object.keys(changes)" @discard="unpatch" @save="saveSettings"></cly-diff-helper>
    </cly-main>
</div>