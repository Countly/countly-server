<div>
  <cly-drawer
    toggle-transition="stdt-fade"
    ref="userDrawer"
    :title="$props.settings.editMode ? $props.settings.editTitle : $props.settings.createTitle"
    @close="onClose"
    @submit="onSubmit"
    @open="onOpen"
    :requires-async-submit="true"
    :hasCancelButton="$props.settings.hasCancelButton"
    :cancelButtonLabel="$props.settings.cancelButtonLabel"
    :width="$props.settings.drawerWidth"
		:saveButtonLabel="$props.settings.editMode ? $props.settings.saveButtonLabel : $props.settings.createButtonLabel"
		v-bind="$props.controls">
		<template v-slot:default="drawerScope">
      <cly-form-step id="user-main" screen="full">
        <div class="user-management-drawer-content">
          <div class="bu-columns">
            <div class="bu-column">
              <div class="user-management-drawer-content__input-wrapper">
                <div class="user-management-drawer-content__label">
                  <div class="text-small text-heading">{{ i18n('management-users.full-name') }}</div>
                </div>
                <div class="user-management-drawer-content__input">
                  <validation-provider rules="required" v-slot="v">
                    <el-input v-model="drawerScope.editedObject.full_name" :placeholder="i18n('management-users.enter-full-name')"></el-input>
                  </validation-provider>
                </div>
              </div>
              <div class="user-management-drawer-content__input-wrapper">
                <div class="user-management-drawer-content__label">
                  <div class="text-small text-heading">{{ i18n('management-users.username') }}</div>
                </div>
                <div class="user-management-drawer-content__input">
                  <validation-provider rules="required" v-slot="v">
                    <el-input v-model="drawerScope.editedObject.username" :placeholder="i18n('management-users.enter-username')"></el-input>
                  </validation-provider>
                </div>
              </div>
              <div class="user-management-drawer-content__input-wrapper">
                <div class="user-management-drawer-content__label">
                  <div class="text-small text-heading">{{ i18n('management-users.password') }}</div>
                </div>
                <div v-if="!$props.settings.editMode" class="user-management-drawer-content__input">
                  <validation-provider rules="required" v-slot="v">
                    <el-input v-model="drawerScope.editedObject.password" :placeholder="i18n('management-users.enter-password')"></el-input>
                  </validation-provider>
                  <div @click="generatePassword()" class="user-management-drawer-content__under-input-text bu-mt-1 bu-is-size-7">{{ i18n('management-users.generate-password') }}</div>
                </div>
                <div v-if="$props.settings.editMode" class="user-management-drawer-content__input">
                  <validation-provider v-if="changePasswordFlag" rules="required" v-slot="v">
                    <el-input v-model="drawerScope.editedObject.password" :placeholder="i18n('management-users.enter-password')"></el-input>
                  </validation-provider>
                  <div v-if="!changePasswordFlag" @click="changePasswordFlag = !changePasswordFlag" class="user-management-drawer-content__under-input-text bu-mt-1 bu-is-size-7">{{ i18n('management-users.change-password') }}</div>
                </div>
              </div>
              <div class="user-management-drawer-content__input-wrapper">
                <div class="user-management-drawer-content__label">
                  <div class="text-small text-heading">{{ i18n('management-users.email') }}</div>
                  <div class="user-management-drawer-content__help-text">
                    Some short description can be placed here.
                  </div>
                </div>
                <div class="user-management-drawer-content__input">
                  <validation-provider rules="required|email" v-slot="v">
                    <el-input v-model="drawerScope.editedObject.email" :placeholder="i18n('management-users.enter-email')"></el-input>
                  </validation-provider>
                </div>
              </div>
              <component v-if="groupsInput.length > 0" :defaultGroup="group" @group-change="onGroupChange" :is="groupsInput[0].component"></component>
            </div>
            <div class="bu-column user-management-drawer-content__profile-picture-area">
              <div class="user-management-drawer-content__label">
                <div class="text-small text-heading">{{ i18n('management-users.profile-picture') }}</div>
              </div>
              <cly-dropzone 
                @vdropzone-removed-file="onFileRemoved" 
                @vdropzone-file-added="onFileAdded"
                @vdropzone-sending="onSending"
                @vdropzone-thumbnail="thumbnail"
                @vdropzone-complete="onComplete"
                ref="userDrawerDropzone" 
                id="user-drawer-dropzone"
                :useCustomSlot=true 
                :options="dropzoneOptions">
                    <div class="dropzone-custom-content">
                      <img v-if="$props.settings.editMode" :src="'/memberimages/' + user._id + '.png'" class="user-management-drawer-content__profile-picture-area__upload-section__img-box"/>
                      <div v-if="!$props.settings.editMode" class="user-management-drawer-content__profile-picture-area__upload-section__img-box"></div>
                      <div class="user-management-drawer-content__profile-picture-area__upload-section__description-box">
                        <p class="user-management-drawer-content__profile-picture-area__upload-section__description-box--bold">{{ i18n('management-users.drag-and-drop-or') }} <span class="user-management-drawer-content__profile-picture-area__upload-section__description-box--link"> {{ i18n('management-users.browser') }} </span> {{ i18n('management-users.files-to-add-picture') }}</p>
                        <p class="user-management-drawer-content__profile-picture-area__upload-section__size-warning">{{ i18n('management-users.pp-size-warning') }}</p>
                      </div>
                    </div>
              </cly-dropzone>
            </div>
          </div>
          <div v-if="!group._id" class="user-management-drawer-content__bottom-section">
            <div class="user-management-drawer-content__drawer-sub-section">
              <div class="user-management-drawer-content__section-title">
                <div>
                  <span class="user-management-drawer-content__section-header">{{ i18n('management-users.role') }}</span>
                </div>
                <div>
                  <span class="user-management-drawer-content__help-text">
                    Some short description can be placed here.
                  </span>
                </div>
              </div>
              <div class="user-management-drawer-content__section-content user-management-drawer-content__role-section">
                <el-checkbox v-model="drawerScope.editedObject.global_admin">{{ i18n('management-users.global-administrator') }}</el-checkbox>
              </div>
            </div>
            <div v-if="!drawerScope.editedObject.global_admin && !group._id" class="user-management-drawer-content__drawer-sub-title">
              {{ i18n('management-users.permission-settings') }}
            </div>
            <div v-if="!drawerScope.editedObject.global_admin && !group._id" class="user-management-drawer-content__drawer-sub-section">
              <div class="user-management-drawer-content__section-title">
                <div>
                  <span class="user-management-drawer-content__section-header"> {{ i18n('management-users.grant-admin-access-to-apps') }} <cly-tooltip-icon icon="ion ion-help-circled"></cly-tooltip-icon></span>
                </div>
                <div>
                </div>
              </div>
              <div class="user-management-drawer-content__section-content">
                <div class="user-management-drawer-content__label user-management-drawer-content__label--pl-10">
                  <div class="text-small user-management-drawer-content__help-text">{{ i18n('management-users.grant-admin-access-description') }}</div>
                </div>
                <div class="input" v-if="drawerScope.editedObject.permission">
                  <el-select placement="bottom-start" @change="onAdminAppsChanged" class="user-management-drawer-content__app-selector" v-model="drawerScope.editedObject.permission._.a" multiple :placeholder="i18n('token_manager.select-apps')">
                    <el-option
                      v-for="item in apps"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </div>
              </div>
            </div>
            <div v-if="!drawerScope.editedObject.global_admin && !group._id" :key="index" v-for="(set, index) in permissionSets" class="user-management-drawer-content__drawer-sub-section">
              <div class="user-management-drawer-content__section-title">
                <div>
                  <span class="user-management-drawer-content__section-header">{{ i18n('management-users.grant-user-access-to-apps') }} <cly-tooltip-icon icon="ion ion-help-circled"></cly-tooltip-icon></span>
                </div>
                <div>
                  <cly-more-options v-if="index > 0" size="small" @command="handleCommand($event, index)">
                    <el-dropdown-item command="remove-set">{{ i18n('management-users.remove-permission-set') }}</el-dropdown-item>
                  </cly-more-options>
                </div>
              </div>
              <div class="user-management-drawer-content__section-content">
                <div class="user-management-drawer-content__label user-management-drawer-content__label--pl-10">
                  <div class="text-small user-management-drawer-content__help-text">Some app selection related description can be placed here</div>
                </div>
                <div class="user-management-drawer-content__input">
                  <el-select placement="bottom-start" @change="onUserAppsChanged(index)" class="user-management-drawer-content__app-selector" v-model="drawerScope.editedObject.permission._.u[index]"  multiple placeholder="Select apps">
                    <el-option
                      v-for="item in apps"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value">
                    </el-option>
                  </el-select>
                </div>
                <div class="user-management-drawer-content__permission-table-header">
                  <div class="user-management-drawer-content__feature-name-col">
                    {{ i18n('management-users.feature') }}
                  </div>
                  <div class="user-management-drawer-content__permission-type-cols">
                    <div class="user-management-drawer-content__permission-type">
                      <el-checkbox @change="setPermissionByType(index, 'c')" v-model="permissionSets[index].c.all">{{ i18n('management-users.create').toUpperCase() }}</el-checkbox>
                    </div>
                    <div class="user-management-drawer-content__permission-type">
                      <el-checkbox @change="setPermissionByType(index, 'r')" v-model="permissionSets[index].r.all">{{ i18n('management-users.read').toUpperCase() }}</el-checkbox>
                    </div>
                    <div class="user-management-drawer-content__permission-type">
                      <el-checkbox @change="setPermissionByType(index, 'u')" v-model="permissionSets[index].u.all">{{ i18n('management-users.update').toUpperCase() }}</el-checkbox>
                    </div>
                    <div class="user-management-drawer-content__permission-type">
                      <el-checkbox @change="setPermissionByType(index, 'd')" v-model="permissionSets[index].d.all">{{ i18n('management-users.delete').toUpperCase() }}</el-checkbox>
                    </div>
                  </div>
                </div>
                <div class="user-management-drawer-content__permission-table-content">
                  <div class="user-management-drawer-content__permission-row" v-for="feature in features">
                    <div class="user-management-drawer-content__feature-name">{{featureBeautifier(feature)}}</div>
                    <div class="user-management-drawer-content__feature-permissions">
                      <div class="user-management-drawer-content__permission-box">
                        <el-checkbox @change="setPermissionByFeature(index, 'c', feature)" v-model="permissionSets[index].c.allowed[feature]"></el-checkbox>
                      </div>
                      <div class="user-management-drawer-content__permission-box">
                        <el-checkbox :disabled="feature === 'core'" @change="setPermissionByFeature(index, 'r', feature)" v-model="permissionSets[index].r.allowed[feature]"></el-checkbox>
                      </div>
                      <div class="user-management-drawer-content__permission-box">
                        <el-checkbox @change="setPermissionByFeature(index, 'u', feature)" v-model="permissionSets[index].u.allowed[feature]"></el-checkbox>
                      </div>
                      <div class="user-management-drawer-content__permission-box">
                        <el-checkbox @change="setPermissionByFeature(index, 'd', feature)" v-model="permissionSets[index].d.allowed[feature]"></el-checkbox>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div v-if="!drawerScope.editedObject.global_admin && !group._id" class="user-management-drawer-content__add-permission-set" @click="addPermissionSet">
              {{ i18n('management-users.add-permission-set') }}
            </div>
          </div>
        </div>
      </cly-form-step>
		</template>
	</cly-drawer>
</div>