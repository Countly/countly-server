<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>aggregator/usage.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h2><a href="../app/index.html" >App Server</a></h2><h2><a href="../api/index.html" >API Server</a></h2><h2><a href="../browser/index.html" >Browser side</a></h2><h2><a href="../apidoc/index.html" >API Reference</a></h2><h3>Classes</h3><ul><li><a href="AppExpireJob.html">AppExpireJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AppExpireJob.html#getEnabled">getEnabled</a></li><li data-type='method' style='display: none;'><a href="AppExpireJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="AppExpireJob.html#run">run</a></li></ul></li><li><a href="Cache.html">Cache</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Cache.html#cls">cls</a></li><li data-type='method' style='display: none;'><a href="Cache.html#has">has</a></li><li data-type='method' style='display: none;'><a href="Cache.html#init">init</a></li><li data-type='method' style='display: none;'><a href="Cache.html#purge">purge</a></li><li data-type='method' style='display: none;'><a href="Cache.html#purgeAll">purgeAll</a></li><li data-type='method' style='display: none;'><a href="Cache.html#read">read</a></li><li data-type='method' style='display: none;'><a href="Cache.html#remove">remove</a></li><li data-type='method' style='display: none;'><a href="Cache.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Cache.html#write">write</a></li></ul></li><li><a href="Cacher.html">Cacher</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Cacher.html#cache">cache</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#checkAll">checkAll</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#get">get</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#getMany">getMany</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#getOne">getOne</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#invalidate">invalidate</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#keysFromProjectionObject">keysFromProjectionObject</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#schedule">schedule</a></li><li data-type='method' style='display: none;'><a href="Cacher.html#updateCacheOne">updateCacheOne</a></li></ul></li><li><a href="ChangeStreamEventSource.html">ChangeStreamEventSource</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ChangeStreamEventSource.html#acknowledge">acknowledge</a></li><li data-type='method' style='display: none;'><a href="ChangeStreamEventSource.html#getNext">getNext</a></li><li data-type='method' style='display: none;'><a href="ChangeStreamEventSource.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="ChangeStreamEventSource.html#stop">stop</a></li></ul></li><li><a href="CleanTokensJob.html">CleanTokensJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CleanTokensJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="CleanTokensJob.html#run">run</a></li></ul></li><li><a href="ClearAutoTasks.html">ClearAutoTasks</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ClearAutoTasks.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="ClearAutoTasks.html#run">run</a></li></ul></li><li><a href="DataBatchReader.html">DataBatchReader</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataBatchReader.html#acknowledgeToken">acknowledgeToken</a></li><li data-type='method' style='display: none;'><a href="DataBatchReader.html#checkState">checkState</a></li><li data-type='method' style='display: none;'><a href="DataBatchReader.html#close">close</a></li><li data-type='method' style='display: none;'><a href="DataBatchReader.html#processNextDateRange">processNextDateRange</a></li><li data-type='method' style='display: none;'><a href="DataBatchReader.html#setUp">setUp</a></li></ul></li><li><a href="DataStore.html">DataStore</a><ul class='methods'><li data-type='method' style='display: none;'><a href="DataStore.html#iterate">iterate</a></li><li data-type='method' style='display: none;'><a href="DataStore.html#read">read</a></li><li data-type='method' style='display: none;'><a href="DataStore.html#remove">remove</a></li><li data-type='method' style='display: none;'><a href="DataStore.html#update">update</a></li><li data-type='method' style='display: none;'><a href="DataStore.html#write">write</a></li></ul></li><li><a href="EventSinkFactory.html">EventSinkFactory</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventSinkFactory.html#.create">create</a></li></ul></li><li><a href="EventSinkInterface.html">EventSinkInterface</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#_createResult">_createResult</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#_setClosed">_setClosed</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#_setInitialized">_setInitialized</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#_validateEvents">_validateEvents</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#close">close</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#getType">getType</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#isClosed">isClosed</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#isInitialized">isInitialized</a></li><li data-type='method' style='display: none;'><a href="EventSinkInterface.html#write">write</a></li></ul></li><li><a href="EventSourceFactory.html">EventSourceFactory</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventSourceFactory.html#.create">create</a></li></ul></li><li><a href="EventSourceInterface.html">EventSourceInterface</a><ul class='methods'><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#acknowledge">acknowledge</a></li><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#getNext">getNext</a></li><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#markBatchProcessed">markBatchProcessed</a></li><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#processWithAutoAck">processWithAutoAck</a></li><li data-type='method' style='display: none;'><a href="EventSourceInterface.html#stop">stop</a></li></ul></li><li><a href="InsertBatcher.html">InsertBatcher</a><ul class='methods'><li data-type='method' style='display: none;'><a href="InsertBatcher.html#addDb">addDb</a></li><li data-type='method' style='display: none;'><a href="InsertBatcher.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="InsertBatcher.html#flushAll">flushAll</a></li><li data-type='method' style='display: none;'><a href="InsertBatcher.html#insert">insert</a></li><li data-type='method' style='display: none;'><a href="InsertBatcher.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="InsertBatcher.html#schedule">schedule</a></li></ul></li><li><a href="Jsonable.html">Jsonable</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Jsonable.html#setData">setData</a></li><li data-type='method' style='display: none;'><a href="Jsonable.html#toJSON">toJSON</a></li><li data-type='method' style='display: none;'><a href="Jsonable.html#updateData">updateData</a></li></ul></li><li><a href="KafkaEventSink.html">KafkaEventSink</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KafkaEventSink.html#close">close</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSink.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSink.html#isConnected">isConnected</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSink.html#write">write</a></li></ul></li><li><a href="KafkaEventSource.html">KafkaEventSource</a><ul class='methods'><li data-type='method' style='display: none;'><a href="KafkaEventSource.html#acknowledge">acknowledge</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSource.html#getNext">getNext</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSource.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSource.html#markBatchProcessed">markBatchProcessed</a></li><li data-type='method' style='display: none;'><a href="KafkaEventSource.html#stop">stop</a></li></ul></li><li><a href="MongoDbQueryRunner.html">MongoDbQueryRunner</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#aggregatedSessionData">aggregatedSessionData</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#calculateTimezoneFromOffset">calculateTimezoneFromOffset</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#fixTimestampToMilliseconds">fixTimestampToMilliseconds</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getAggregatedData">getAggregatedData</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getDateStringProjection">getDateStringProjection</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getPeriodRange">getPeriodRange</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getUniqueCount">getUniqueCount</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getUniqueGraph">getUniqueGraph</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#getViewsTableData">getViewsTableData</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#segmentValuesForPeriod">segmentValuesForPeriod</a></li><li data-type='method' style='display: none;'><a href="MongoDbQueryRunner.html#timesOfDay">timesOfDay</a></li></ul></li><li><a href="MongoEventSink.html">MongoEventSink</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MongoEventSink.html#close">close</a></li><li data-type='method' style='display: none;'><a href="MongoEventSink.html#initialize">initialize</a></li><li data-type='method' style='display: none;'><a href="MongoEventSink.html#write">write</a></li></ul></li><li><a href="Mongoable.html">Mongoable</a><ul class='members'><li data-type='member' style='display: none;'><a href="Mongoable.html#_id">_id</a></li><li data-type='member' style='display: none;'><a href="Mongoable.html#_id">_id</a></li><li data-type='member' style='display: none;'><a href="Mongoable.html#id">id</a></li><li data-type='member' style='display: none;'><a href="Mongoable.html#.collection">collection</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Mongoable.html#refresh">refresh</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#save">save</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#updateAtomically">updateAtomically</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.batchInsert">batchInsert</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.count">count</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.deleteOne">deleteOne</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.findMany">findMany</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.findOne">findOne</a></li><li data-type='method' style='display: none;'><a href="Mongoable.html#.findOneAndUpdate">findOneAndUpdate</a></li></ul></li><li><a href="MonitorJob.html">MonitorJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MonitorJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="MonitorJob.html#run">run</a></li></ul></li><li><a href="MutationManagerJob.html">MutationManagerJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#deleteClickhouse">deleteClickhouse</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#deleteMongo">deleteMongo</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#ensureTracker">ensureTracker</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#getClickhouseLoadMetrics">getClickhouseLoadMetrics</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#getConcurrency">getConcurrency</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#markFailedOrRetry">markFailedOrRetry</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#processAwaitingValidation">processAwaitingValidation</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#processTask">processTask</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#reportFailureToStats">reportFailureToStats</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#resetStaleTasks">resetStaleTasks</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#run">run</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#shouldDeferDueToClickhousePressure">shouldDeferDueToClickhousePressure</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#updateClickhouse">updateClickhouse</a></li><li data-type='method' style='display: none;'><a href="MutationManagerJob.html#updateMongo">updateMongo</a></li></ul></li><li><a href="PingJob.html">PingJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="PingJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="PingJob.html#run">run</a></li></ul></li><li><a href="ReadBatcher.html">ReadBatcher</a><ul class='methods'><li data-type='method' style='display: none;'><a href="ReadBatcher.html#cache">cache</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#checkAll">checkAll</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#get">get</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#getMany">getMany</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#getOne">getOne</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#invalidate">invalidate</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#keysFromProjectionObject">keysFromProjectionObject</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="ReadBatcher.html#schedule">schedule</a></li></ul></li><li><a href="TTLCleanup.html">TTLCleanup</a><ul class='methods'><li data-type='method' style='display: none;'><a href="TTLCleanup.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="TTLCleanup.html#run">run</a></li></ul></li><li><a href="TestDataClass.html">TestDataClass</a></li><li><a href="TopEventsJob.html">TopEventsJob</a><ul class='members'><li data-type='member' style='display: none;'><a href="TopEventsJob.html#.COLLECTION_NAME">COLLECTION_NAME</a></li><li data-type='member' style='display: none;'><a href="TopEventsJob.html#.PERIODS">PERIODS</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="TopEventsJob.html#encodeEvents">encodeEvents</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#eventsCollentions">eventsCollentions</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#eventsFilter">eventsFilter</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#fetchEventTotalCounts">fetchEventTotalCounts</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#getAllApps">getAllApps</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#getAppEvents">getAppEvents</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#getSessionCount">getSessionCount</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#init">init</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#mutatePeriod">mutatePeriod</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#run">run</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#saveAppEvents">saveAppEvents</a></li><li data-type='method' style='display: none;'><a href="TopEventsJob.html#timeSecond">timeSecond</a></li></ul></li><li><a href="UnifiedEventSink.html">UnifiedEventSink</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UnifiedEventSink.html#close">close</a></li><li data-type='method' style='display: none;'><a href="UnifiedEventSink.html#getSinkTypes">getSinkTypes</a></li><li data-type='method' style='display: none;'><a href="UnifiedEventSink.html#isClosed">isClosed</a></li><li data-type='method' style='display: none;'><a href="UnifiedEventSink.html#isInitialized">isInitialized</a></li><li data-type='method' style='display: none;'><a href="UnifiedEventSink.html#write">write</a></li></ul></li><li><a href="UnifiedEventSource.html">UnifiedEventSource</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UnifiedEventSource.html#markBatchProcessed">markBatchProcessed</a></li><li data-type='method' style='display: none;'><a href="UnifiedEventSource.html#processWithAutoAck">processWithAutoAck</a></li></ul></li><li><a href="UserMergeJob.html">UserMergeJob</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UserMergeJob.html#getSchedule">getSchedule</a></li><li data-type='method' style='display: none;'><a href="UserMergeJob.html#run">run</a></li></ul></li><li><a href="Validatable.html">Validatable</a><ul class='members'><li data-type='member' style='display: none;'><a href="Validatable.html#json">json</a></li><li data-type='member' style='display: none;'><a href="Validatable.html#.scheme">scheme</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="Validatable.html#validate">validate</a></li><li data-type='method' style='display: none;'><a href="Validatable.html#.discriminator">discriminator</a></li><li data-type='method' style='display: none;'><a href="Validatable.html#.validate">validate</a></li></ul></li><li><a href="WriteBatcher.html">WriteBatcher</a><ul class='methods'><li data-type='method' style='display: none;'><a href="WriteBatcher.html#add">add</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#addDb">addDb</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#addFlushCallback">addFlushCallback</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#flush">flush</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#flushAll">flushAll</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#get">get</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#loadConfig">loadConfig</a></li><li data-type='method' style='display: none;'><a href="WriteBatcher.html#schedule">schedule</a></li></ul></li><li><a href="changeStreamReader.html">changeStreamReader</a><ul class='methods'><li data-type='method' style='display: none;'><a href="changeStreamReader.html#acknowledgeToken">acknowledgeToken</a></li><li data-type='method' style='display: none;'><a href="changeStreamReader.html#checkState">checkState</a></li><li data-type='method' style='display: none;'><a href="changeStreamReader.html#close">close</a></li><li data-type='method' style='display: none;'><a href="changeStreamReader.html#processBadRange">processBadRange</a></li><li data-type='method' style='display: none;'><a href="changeStreamReader.html#processNextDateRange">processNextDateRange</a></li><li data-type='method' style='display: none;'><a href="changeStreamReader.html#setUp">setUp</a></li></ul></li><li><a href="module-api_lib_countly.model-countlyMetric.html">countlyMetric</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.fetchValue">countlyMetric.fetchValue</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.clearObject">countlyMetric.clearObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.extendDb">countlyMetric.extendDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getBars">countlyMetric.getBars</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getData">countlyMetric.getData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getDb">countlyMetric.getDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMeta">countlyMetric.getMeta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMetrics">countlyMetric.getMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getNumber">countlyMetric.getNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getPeriod">countlyMetric.getPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getRangeData">countlyMetric.getRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getStackedBarData">countlyMetric.getStackedBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTableData">countlyMetric.getTableData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTimelineData">countlyMetric.getTimelineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTotalUsersObj">countlyMetric.getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getUniqueMetrics">countlyMetric.getUniqueMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.reset">countlyMetric.reset</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setDb">countlyMetric.setDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setMetrics">countlyMetric.setMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setPeriod">countlyMetric.setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setTotalUsersObj">countlyMetric.setTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setUniqueMetrics">countlyMetric.setUniqueMetrics</a></li></ul></li><li><a href="module-api_parts_data_QueryRunner-QueryRunner.html">QueryRunner</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_QueryRunner-QueryRunner.html#executeQuery">executeQuery</a></li></ul></li><li><a href="module-api_utils_common-DataTable.html">DataTable</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common-DataTable.html#_getSearchField">_getSearchField</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common-DataTable.html#getAggregationPipeline">getAggregationPipeline</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common-DataTable.html#getProcessedResult">getProcessedResult</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-api_lib_countly.common.html">api/lib/countly.common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.common.html#.periodObj">periodObj</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.calculatePeriodObject">calculatePeriodObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.calculateUniqueFromMap">calculateUniqueFromMap</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decode">decode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.encode">encode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractBarData">extractBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractChartData">extractChartData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractData">extractData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractMetric">extractMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractRangeData">extractRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractTwoLevelData">extractTwoLevelData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.fixPercentageDelta">fixPercentageDelta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.formatTime">formatTime</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDashboardData">getDashboardData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDateRange">getDateRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPercentChange">getPercentChange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodRange">getPeriodRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getShortNumber">getShortNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getSparklineData">getSparklineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getTimestampRangeQuery">getTimestampRangeQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.isValidPeriodParam">isValidPeriodParam</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.mergeMetricsByName">mergeMetricsByName</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setPeriod">setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setTimezone">setTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.stringIncrement">stringIncrement</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.timeString">timeString</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.union">union</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.validateEmail">validateEmail</a></li></ul></li><li><a href="module-api_lib_countly.countries.html">api/lib/countly.countries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.countries.html#.getLocationData">getLocationData</a></li></ul></li><li><a href="module-api_lib_countly.device_details.html">api/lib/countly.device_details</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.device_details.html#.fixBarSegmentData">fixBarSegmentData</a></li></ul></li><li><a href="module-api_lib_countly.devices.html">api/lib/countly.devices</a></li><li><a href="module-api_lib_countly.event.html">api/lib/countly.event</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.event.html#.getSegmentedData">getSegmentedData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.event.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_lib_countly.model.html">api/lib/countly.model</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.load">load</a></li></ul></li><li><a href="module-api_lib_countly.users.html">api/lib/countly.users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSessionData">getSessionData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_parts_data_events.html">api/parts/data/events</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_events.html#.processEvents">processEvents</a></li></ul></li><li><a href="module-api_parts_data_stats.html">api/parts/data/stats</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_stats.html#.getOverall">getOverall</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_stats.html#.getServer">getServer</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_stats.html#.getUser">getUser</a></li></ul></li><li><a href="module-api_parts_data_usage.html">api/parts/data/usage</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.getPredefinedMetrics">getPredefinedMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.processSessionDuration">processSessionDuration</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.processSessionDurationRange">processSessionDurationRange</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.returnAllProcessedMetrics">returnAllProcessedMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.setLocation">setLocation</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_usage.html#.setUserLocation">setUserLocation</a></li></ul></li><li><a href="module-api_config.html">api/config</a></li><li><a href="module-api_parts_data_QueryRunner.html">api/parts/data/QueryRunner</a></li><li><a href="module-api_parts_data_exports.html">api/parts/data/exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.convertData">convertData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromData">fromData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromDatabase">fromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.output">output</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.stream">stream</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~flattenArray">flattenArray</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~flattenObject">flattenObject</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~getCursorForExport">getCursorForExport</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~getValues">getValues</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~isObjectId">isObjectId</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~preventCSVInjection">preventCSVInjection</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~processCSVvalue">processCSVvalue</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~transformValue">transformValue</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#~transformValuesInObject">transformValuesInObject</a></li></ul></li><li><a href="module-api_parts_data_fetch.html">api/parts/data/fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchAllApps">fetchAllApps</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchCollection">fetchCollection</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchCountries">fetchCountries</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchDashboard">fetchDashboard</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchDataEventsOverview">fetchDataEventsOverview</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchDataTopEvents">fetchDataTopEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchDurations">fetchDurations</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchEventData">fetchEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchEventGroupById">fetchEventGroupById</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchEventGroups">fetchEventGroups</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchEventMetaData">fetchEventMetaData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchEvents">fetchEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchFrequency">fetchFrequency</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchLoyalty">fetchLoyalty</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchMergedEventData">fetchMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchMergedEventGroups">fetchMergedEventGroups</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchMetric">fetchMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchSessions">fetchSessions</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchTimeData">fetchTimeData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchTimeObj">fetchTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchTop">fetchTop</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchTops">fetchTops</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.fetchTotalUsersObj">fetchTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.formatTotalUsersObj">formatTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventData">getMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventGroups">getMergedEventGroups</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetric">getMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetricWithOptions">getMetricWithOptions</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObj">getTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObjForEvents">getTimeObjForEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObj">getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObjWithOptions">getTotalUsersObjWithOptions</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.metricToCollection">metricToCollection</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.prefetchEventData">prefetchEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#~fetchData">fetchData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#~fetchFromGranular">fetchFromGranular</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#~fetchTimeObj">fetchTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#~getDataforTops">getDataforTops</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#~union">union</a></li></ul></li><li><a href="module-api_parts_mgmt_app_users.html">api/parts/mgmt/app_users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.count">count</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.export">export</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.getUid">getUid</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.merge">merge</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.update">update</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#~dataIsRecordedInMongo">dataIsRecordedInMongo</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#~getAggregatedAppUsers">getAggregatedAppUsers</a></li></ul></li><li><a href="module-api_parts_mgmt_apps.html">api/parts/mgmt/apps</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.createApp">createApp</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.deleteApp">deleteApp</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.getAllApps">getAllApps</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.getAppPlugins">getAppPlugins</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.getAppsDetails">getAppsDetails</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.getCurrentUserApps">getCurrentUserApps</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.resetApp">resetApp</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.updateApp">updateApp</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#.updateAppPlugins">updateAppPlugins</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~checkUniqueKey">checkUniqueKey</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~deleteAllAppData">deleteAllAppData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~deleteAppData">deleteAppData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~deleteAppLongTasks">deleteAppLongTasks</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~deletePeriodAppData">deletePeriodAppData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~iconUpload">iconUpload</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~isValidCategory">isValidCategory</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~isValidCountry">isValidCountry</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~isValidTimezone">isValidTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~isValidType">isValidType</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~packApps">packApps</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~processAppProps">processAppProps</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_apps.html#~validateAppUpdateProps">validateAppUpdateProps</a></li></ul></li><li><a href="module-api_parts_mgmt_cms.html">api/parts/mgmt/cms</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#.clearCache">clearCache</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#.getEntries">getEntries</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#.getEntriesWithUpdate">getEntriesWithUpdate</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#~fetchFromCMS">fetchFromCMS</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#~syncCMSDataToDB">syncCMSDataToDB</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_cms.html#~transformAndStoreData">transformAndStoreData</a></li></ul></li><li><a href="module-api_parts_mgmt_date_presets.html">api/parts/mgmt/date_presets</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_date_presets.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_date_presets.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_date_presets.html#.getAll">getAll</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_date_presets.html#.update">update</a></li></ul></li><li><a href="module-api_parts_mgmt_ip.html">api/parts/mgmt/ip</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_ip.html#.getHost">getHost</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_ip.html#~getNetworkIP">getNetworkIP</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_ip.html#~stripTrailingSlash">stripTrailingSlash</a></li></ul></li><li><a href="module-api_parts_mgmt_mail.html">api/parts/mgmt/mail</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.escapedHTMLString">escapedHTMLString</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.getUserFirstName">getUserFirstName</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.lookup">lookup</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendAutomatedMessageError">sendAutomatedMessageError</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendLocalizedMessage">sendLocalizedMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendMail">sendMail</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendMessage">sendMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendPasswordResetInfo">sendPasswordResetInfo</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendToNewMember">sendToNewMember</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendToNewMemberLink">sendToNewMemberLink</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#.sendToUpdatedMember">sendToUpdatedMember</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_mail.html#~getPluginConfig">getPluginConfig</a></li></ul></li><li><a href="module-api_parts_mgmt_tracker.html">api/parts/mgmt/tracker</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.collectServerData">collectServerData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.collectServerStats">collectServerStats</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.enable">enable</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.getAllData">getAllData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.getBulkServer">getBulkServer</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.getBulkUser">getBulkUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.getSDK">getSDK</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.getSDKData">getSDKData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.isEnabled">isEnabled</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.reportEvent">reportEvent</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.reportEventBulk">reportEventBulk</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.reportUserEvent">reportUserEvent</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#.uploadBase64FileFromGridFS">uploadBase64FileFromGridFS</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#~hasDockerCGroup">hasDockerCGroup</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#~hasDockerEnv">hasDockerEnv</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#~hasDockerMountInfo">hasDockerMountInfo</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_tracker.html#~stripTrailingSlash">stripTrailingSlash</a></li></ul></li><li><a href="module-api_parts_mgmt_users.html">api/parts/mgmt/users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.checkNoteEditPermission">checkNoteEditPermission</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.deleteNote">deleteNote</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.deleteUser">deleteUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.deleteUserNotes">deleteUserNotes</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.fetchNotes">fetchNotes</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.fetchUserAppIds">fetchUserAppIds</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.getAllUsers">getAllUsers</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.getCurrentUser">getCurrentUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.getUserById">getUserById</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.resetTimeBan">resetTimeBan</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.saveNote">saveNote</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#.updateUser">updateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~argon2Hash">argon2Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~deleteUserPresets">deleteUserPresets</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~depCheck">depCheck</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~isArgon2Hash">isArgon2Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~killAllSessionForUser">killAllSessionForUser</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~sha1Hash">sha1Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~sha512Hash">sha512Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~updateUserPasswordToArgon2">updateUserPasswordToArgon2</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~verifyArgon2Hash">verifyArgon2Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_users.html#~verifyMemberArgon2Hash">verifyMemberArgon2Hash</a></li></ul></li><li><a href="module-api_utils_authorizer.html">api/utils/authorizer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.check_if_expired">check_if_expired</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.extend_token">extend_token</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.read">read</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify">verify</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify_return">verify_return</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#~verify_token">verify_token</a></li></ul></li><li><a href="module-api_utils_common.html">api/utils/common</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#~escape_html_entities">escape_html_entities</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#~getJSON">getJSON</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#~recordMetric">recordMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#~recordSegmentMetric">recordSegmentMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#~stripPort">stripPort</a></li></ul></li><li><a href="module-api_utils_countlyFs.html">api/utils/countlyFs</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.fs">fs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.gridfs">gridfs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.type">type</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getData">getData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getSize">getSize</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStream">getStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.rename">rename</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveData">saveData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveFile">saveFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveStream">saveStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.setHandler">setHandler</a></li></ul></li><li><a href="module-api_utils_localization.html">api/utils/localization</a></li><li><a href="module-api_utils_pdf.html">api/utils/pdf</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_pdf.html#.renderPDF">renderPDF</a></li></ul></li><li><a href="module-api_utils_random-sfc32.html">api/utils/random-sfc32</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_random-sfc32.html#~random">random</a></li></ul></li><li><a href="module-api_utils_render.html">api/utils/render</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_render.html#.renderView">renderView</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_render.html#~fetchChromeExecutablePath">fetchChromeExecutablePath</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_render.html#~saveScreenshot">saveScreenshot</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_render.html#~timeout">timeout</a></li></ul></li><li><a href="module-api_utils_requestProcessor.html">api/utils/requestProcessor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#.processRequest">processRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~checksumSaltVerification">checksumSaltVerification</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~fetchAppUser">fetchAppUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~ignorePossibleDevices">ignorePossibleDevices</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~loadDbVersionMarks">loadDbVersionMarks</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~loadFsVersionMarks">loadFsVersionMarks</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processFetchRequest">processFetchRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processRequestData">processRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processUser">processUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~restartRequest">restartRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateAppForFetchAPI">validateAppForFetchAPI</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateAppForWriteAPI">validateAppForWriteAPI</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateRedirect">validateRedirect</a></li></ul></li><li><a href="module-api_utils_rights.html">api/utils/rights</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.dbUserHasAccessToCollection">dbUserHasAccessToCollection</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.getBaseAppFilter">getBaseAppFilter</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.hasAdminAccess">hasAdminAccess</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateAppAdmin">validateAppAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateCreate">validateCreate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateDelete">validateDelete</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateGlobalAdmin">validateGlobalAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateRead">validateRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUpdate">validateUpdate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUser">validateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForRead">validateUserForRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForWrite">validateUserForWrite</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#~dbLoadEventsData">dbLoadEventsData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#~loadAndCacheEventsData">loadAndCacheEventsData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#~validateWrite">validateWrite</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#~validate_token_if_exists">validate_token_if_exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#~wrapCallback">wrapCallback</a></li></ul></li><li><a href="module-api_utils_taskmanager.html">api/utils/taskmanager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkIfRunning">checkIfRunning</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkResult">checkResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.createTask">createTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteAdditionalResults">deleteAdditionalResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteResult">deleteResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.editTask">editTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.errorResults">errorResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getCounts">getCounts</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getId">getId</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResult">getResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResultByQuery">getResultByQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResults">getResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getTableQueryResult">getTableQueryResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.nameResult">nameResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.rerunTask">rerunTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.saveResult">saveResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#~getResult">getResult</a></li></ul></li><li></li><li><a href="module-api_utils_utils.html">api/utils/utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt">decrypt</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt_old">decrypt_old</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.encrypt">encrypt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ACCEPTABLE">ACCEPTABLE</a></li><li><a href="global.html#LEVELS">LEVELS</a></li><li><a href="global.html#buildJobConfig">buildJobConfig</a></li><li><a href="global.html#callback">callback</a></li><li><a href="global.html#checksumSaltVerification">checksumSaltVerification</a></li><li><a href="global.html#clearTaskRecord">clearTaskRecord</a></li><li><a href="global.html#common">common</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#createLogFunction">createLogFunction</a></li><li><a href="global.html#createLogger">createLogger</a></li><li><a href="global.html#createLoggingSpan">createLoggingSpan</a></li><li><a href="global.html#d">d</a></li><li><a href="global.html#dig">dig</a></li><li><a href="global.html#dot">dot</a></li><li><a href="global.html#e">e</a></li><li><a href="global.html#f">f</a></li><li><a href="global.html#fetchDataForAggregator">fetchDataForAggregator</a></li><li><a href="global.html#fillUserProperties">fillUserProperties</a></li><li><a href="global.html#flush">flush</a></li><li><a href="global.html#fromCountlyRoot">fromCountlyRoot</a></li><li><a href="global.html#getCountryName">getCountryName</a></li><li><a href="global.html#getId">getId</a></li><li><a href="global.html#getLevel">getLevel</a></li><li><a href="global.html#getTraceContext">getTraceContext</a></li><li><a href="global.html#handleRequest">handleRequest</a></li><li><a href="global.html#hasOpenTelemetry">hasOpenTelemetry</a></li><li><a href="global.html#i">i</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#ignorePossibleDevices">ignorePossibleDevices</a></li><li><a href="global.html#length">length</a></li><li><a href="global.html#levels">levels</a></li><li><a href="global.html#loadMutationManagerJobConfig">loadMutationManagerJobConfig</a></li><li><a href="global.html#locFromGeocoder">locFromGeocoder</a></li><li><a href="global.html#locFromGeoip">locFromGeoip</a></li><li><a href="global.html#logLevel">logLevel</a></li><li><a href="global.html#logdb">logdb</a></li><li><a href="global.html#mongodbHandler">mongodbHandler</a></li><li><a href="global.html#processBulkRequest">processBulkRequest</a></li><li><a href="global.html#processRequest">processRequest</a></li><li><a href="global.html#processRequestData">processRequestData</a></li><li><a href="global.html#processUser">processUser</a></li><li><a href="global.html#promiseOrCallback">promiseOrCallback</a></li><li><a href="global.html#pushAsync">pushAsync</a></li><li><a href="global.html#pushSync">pushSync</a></li><li><a href="global.html#recordMetrics">recordMetrics</a></li><li><a href="global.html#remove">remove</a></li><li><a href="global.html#setDefault">setDefault</a></li><li><a href="global.html#setLevel">setLevel</a></li><li><a href="global.html#setPrettyPrint">setPrettyPrint</a></li><li><a href="global.html#sub">sub</a></li><li><a href="global.html#total">total</a></li><li><a href="global.html#transformToKafkaEventFormat">transformToKafkaEventFormat</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#uploadFormFile">uploadFormFile</a></li><li><a href="global.html#validateAppForWriteAPI">validateAppForWriteAPI</a></li><li><a href="global.html#w">w</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">aggregator/usage.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var usage = {};
var common = require('./../utils/common.js');
var plugins = require('./../../plugins/pluginManager.js');
var async = require('async');
var crypto = require('crypto');
var moment = require('moment-timezone');

usage.processViewCount = async function(writeBatcher, token, vc, did, params) {
    if (plugins.isPluginEnabled("views") &amp;&amp; vc) {
        if (!common.isNumber(vc)) {
            try {
                vc = parseInt(vc, 10);
            }
            catch (ex) {
                return;
            }
        }
        var ranges = [
                [0, 2],
                [3, 5],
                [6, 10],
                [11, 15],
                [16, 30],
                [31, 50],
                [51, 100]
            ],
            rangesMax = 101,
            calculatedRange,
            updateUsers = {},
            updateUsersZero = {},
            dbDateIds = common.getDateIds(params),
            monthObjUpdate = [];

        if (vc >= rangesMax) {
            calculatedRange = (ranges.length) + '';
        }
        else {
            for (var i = 0; i &lt; ranges.length; i++) {
                if (vc &lt;= ranges[i][1] &amp;&amp; vc >= ranges[i][0]) {
                    calculatedRange = i + '';
                    break;
                }
            }
        }

        monthObjUpdate.push('vc.' + calculatedRange);
        common.fillTimeObjectMonth(params, updateUsers, monthObjUpdate);
        common.fillTimeObjectZero(params, updateUsersZero, 'vc.' + calculatedRange);
        var postfix = common.crypto.createHash("md5").update(did).digest('base64')[0];
        writeBatcher.add('users', params.app_id + "_" + dbDateIds.month + "_" + postfix, {'$inc': updateUsers}, "countly", {token: token});
        var update = {'$inc': updateUsersZero, '$set': {}};
        update.$set['meta_v2.v-ranges.' + calculatedRange] = true;
        writeBatcher.add('users', params.app_id + "_" + dbDateIds.zero + "_" + postfix, update, "countly", {token: token});
    }

};
usage.processSessionDurationRange = async function(writeBatcher, token, totalSessionDuration, did, params) {
    var durationRanges = [
            [0, 10],
            [11, 30],
            [31, 60],
            [61, 180],
            [181, 600],
            [601, 1800],
            [1801, 3600]
        ],
        durationMax = 3601,
        calculatedDurationRange,
        updateUsers = {},
        updateUsersZero = {},
        dbDateIds = common.getDateIds(params),
        monthObjUpdate = [];

    if (totalSessionDuration >= durationMax) {
        calculatedDurationRange = (durationRanges.length) + '';
    }
    else {
        for (var i = 0; i &lt; durationRanges.length; i++) {
            if (totalSessionDuration &lt;= durationRanges[i][1] &amp;&amp; totalSessionDuration >= durationRanges[i][0]) {
                calculatedDurationRange = i + '';
                break;
            }
        }
    }
    if (totalSessionDuration > 0) {
        common.fillTimeObjectMonth(params, updateUsers, common.dbMap.duration, totalSessionDuration);
    }
    monthObjUpdate.push(common.dbMap.durations + '.' + calculatedDurationRange);
    common.fillTimeObjectMonth(params, updateUsers, monthObjUpdate);
    common.fillTimeObjectZero(params, updateUsersZero, common.dbMap.durations + '.' + calculatedDurationRange);
    var postfix = common.crypto.createHash("md5").update(did).digest('base64')[0];
    writeBatcher.add("users", params.app_id + "_" + dbDateIds.month + "_" + postfix, {'$inc': updateUsers});
    var update = {
        '$inc': updateUsersZero,
        '$set': {"a": params.app_id + "", "m": dbDateIds.zero}
    };
    update.$set['meta_v2.d-ranges.' + calculatedDurationRange] = true;
    writeBatcher.add("users", params.app_id + "_" + dbDateIds.zero + "_" + postfix, update, "countly", {token: token});
};

usage.processSessionFromStream = async function(token, currEvent, params) {
    currEvent.up = currEvent.up || {};
    var updateUsersZero = {},
        updateUsersMonth = {},
        usersMeta = {},
        sessionFrequency = [
            [0, 24],
            [24, 48],
            [48, 72],
            [72, 96],
            [96, 120],
            [120, 144],
            [144, 168],
            [168, 192],
            [192, 360],
            [360, 744]
        ],
        sessionFrequencyMax = 744,
        calculatedFrequency,
        uniqueLevels = [],
        uniqueLevelsZero = [],
        uniqueLevelsMonth = [],
        zeroObjUpdate = [],
        monthObjUpdate = [],
        dbDateIds = common.getDateIds(params);

    monthObjUpdate.push(common.dbMap.total);
    if (currEvent.up.cc) {
        monthObjUpdate.push(currEvent.up.cc + '.' + common.dbMap.total);
    }
    if (currEvent.sg &amp;&amp; currEvent.sg.prev_session) {
        //user had session before
        if (currEvent.sg.prev_start) {
            var userLastSeenTimestamp = currEvent.sg.prev_start,
                currDate = common.getDate(currEvent.ts, params.appTimezone),
                userLastSeenDate = common.getDate(userLastSeenTimestamp, params.appTimezone),
                secInMin = (60 * (currDate.minutes())) + currDate.seconds(),
                secInHour = (60 * 60 * (currDate.hours())) + secInMin,
                secInMonth = (60 * 60 * 24 * (currDate.date() - 1)) + secInHour,
                secInYear = (60 * 60 * 24 * (common.getDOY(currEvent.ts, params.appTimezone) - 1)) + secInHour;

            /* if (dbAppUser.cc !== params.user.country) {
            monthObjUpdate.push(params.user.country + '.' + common.dbMap.unique);
            zeroObjUpdate.push(params.user.country + '.' + common.dbMap.unique);
        }*/

            // Calculate the frequency range of the user
            var ts_sec = currEvent.ts / 1000;
            if ((ts_sec - userLastSeenTimestamp) >= (sessionFrequencyMax * 60 * 60)) {
                calculatedFrequency = sessionFrequency.length + '';
            }
            else {
                for (let i = 0; i &lt; sessionFrequency.length; i++) {
                    if ((ts_sec - userLastSeenTimestamp) &lt; (sessionFrequency[i][1] * 60 * 60) &amp;&amp;
                        (ts_sec - userLastSeenTimestamp) >= (sessionFrequency[i][0] * 60 * 60)) {
                        calculatedFrequency = (i + 1) + '';
                        break;
                    }
                }
            }

            //if for some reason we received past data lesser than last session timestamp
            //we can't calculate frequency for that part
            if (typeof calculatedFrequency !== "undefined") {
                zeroObjUpdate.push(common.dbMap.frequency + '.' + calculatedFrequency);
                monthObjUpdate.push(common.dbMap.frequency + '.' + calculatedFrequency);
                usersMeta['meta_v2.f-ranges.' + calculatedFrequency] = true;
            }

            if (userLastSeenTimestamp &lt; (ts_sec - secInMin)) {
            // We don't need to put hourly fragment to the unique levels array since
            // we will store hourly data only in sessions collection
                updateUsersMonth['d.' + params.time.day + '.' + params.time.hour + '.' + common.dbMap.unique] = 1;
            }

            if (userLastSeenTimestamp &lt; (ts_sec - secInHour)) {
                uniqueLevels[uniqueLevels.length] = params.time.daily;
                uniqueLevelsMonth.push(params.time.day);
            }

            if ((userLastSeenDate.year() + "") === (params.time.yearly + "") &amp;&amp;
                Math.ceil(userLastSeenDate.format("DDD") / 7) &lt; params.time.weekly) {
                uniqueLevels[uniqueLevels.length] = params.time.yearly + ".w" + params.time.weekly;
                uniqueLevelsZero.push("w" + params.time.weekly);
            }

            if (userLastSeenTimestamp &lt; (ts_sec - secInMonth)) {
                uniqueLevels[uniqueLevels.length] = params.time.monthly;
                uniqueLevelsZero.push(params.time.month);
            }

            if (userLastSeenTimestamp &lt; (ts_sec - secInYear)) {
                uniqueLevels[uniqueLevels.length] = params.time.yearly;
                uniqueLevelsZero.push("Y");
            }
        }
    }
    else {
        zeroObjUpdate.push(common.dbMap.unique);
        monthObjUpdate.push(common.dbMap.new);
        monthObjUpdate.push(common.dbMap.unique);
        if (currEvent.up.cc) {
            zeroObjUpdate.push(currEvent.up.cc + '.' + common.dbMap.unique);
            monthObjUpdate.push(currEvent.up.cc + '.' + common.dbMap.new);
            monthObjUpdate.push(currEvent.up.cc + '.' + common.dbMap.unique);
        }

        // First time user.
        calculatedFrequency = '0';

        zeroObjUpdate.push(common.dbMap.frequency + '.' + calculatedFrequency);
        monthObjUpdate.push(common.dbMap.frequency + '.' + calculatedFrequency);

        usersMeta['meta_v2.f-ranges.' + calculatedFrequency] = true;
        //this was first session for this user
    }
    usersMeta['meta_v2.countries.' + (currEvent.up.cc || "Unknown")] = true;
    common.fillTimeObjectZero(params, updateUsersZero, zeroObjUpdate);
    common.fillTimeObjectMonth(params, updateUsersMonth, monthObjUpdate);

    var postfix = common.crypto.createHash("md5").update(currEvent.did).digest('base64')[0];
    if (Object.keys(updateUsersZero).length || Object.keys(usersMeta).length) {
        usersMeta.m = dbDateIds.zero;
        usersMeta.a = params.app_id + "";
        var updateObjZero = {$set: usersMeta};

        if (Object.keys(updateUsersZero).length) {
            updateObjZero.$inc = updateUsersZero;
        }
        common.writeBatcher.add("users", params.app_id + "_" + dbDateIds.zero + "_" + postfix, updateObjZero, "countly", {token: token});
    }
    if (Object.keys(updateUsersMonth).length) {
        common.writeBatcher.add("users", params.app_id + "_" + dbDateIds.month + "_" + postfix, {
            $set: {
                m: dbDateIds.month,
                a: params.app_id + ""
            },
            '$inc': updateUsersMonth
        }, "countly", {token: token});
    }
    usage.processSessionMetricsFromStream(currEvent, uniqueLevelsZero, uniqueLevelsMonth, params);
};

usage.processEventTotalsFromAggregation = async function(token, currEventArray, writeBatcher) {
    var rootUpdate = {};
    for (var z = 0; z &lt; currEventArray.length; z++) {
        var eventColl = await common.readBatcher.getOne("events", common.db.ObjectID(currEventArray[z].a), {"transformation": "event_object"});
        var appData = await common.readBatcher.getOne("apps", common.db.ObjectID(currEventArray[z].a), {timezone: 1, plugins: 1});
        var conff = plugins.getConfig("api", appData.plugins, true);
        //Get timezone offset in hours from timezone name
        var appTimezone = appData.timezone || "UTC";

        var d = moment();
        if (appTimezone) {
            d.tz(appTimezone);
        }
        var tmpEventObj = {};
        var tmpTotalObj = {};

        var shortEventName = currEventArray[z].e;
        eventColl = eventColl || {};
        if (!eventColl._list || eventColl._list[shortEventName] !== true) {
            eventColl._list = eventColl._list || {};
            eventColl._list_length = eventColl._list_length || 0;
            if (eventColl._list_length &lt;= conff.event_limit) {
                eventColl._list[shortEventName] = true;
                eventColl._list_length++;
                rootUpdate.$addToSet = {list: shortEventName};
            }
            else {
                return; //do not record this event in aggregated data
            }
        }
        var eventCollectionName = crypto.createHash('sha1').update(shortEventName + currEventArray[z].a).digest('hex');
        common.shiftHourlyData(currEventArray[z], Math.floor(d.utcOffset() / 60), "h");
        var date = currEventArray[z].h.split(":");
        var timeObj = {"yearly": date[0], "weekly": 1, "monthly": date[1], "month": date[1], "day": date[2], "hour": date[3]};
        if (currEventArray[z].s &amp;&amp; common.isNumber(currEventArray[z].s)) {
            common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.sum, currEventArray[z].s);
            common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.sum, currEventArray[z].s);
        }
        else {
            currEventArray[z].s = 0;
        }
        if (currEventArray[z].dur &amp;&amp; common.isNumber(currEventArray[z].dur)) {
            common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.dur, currEventArray[z].dur);
            common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.dur, currEventArray[z].dur);
        }
        else {
            currEventArray[z].dur = 0;
        }
        currEventArray[z].c = currEventArray[z].c || 1;
        if (currEventArray[z].c &amp;&amp; common.isNumber(currEventArray[z].c)) {
            currEventArray[z].c = parseInt(currEventArray[z].c, 10);
        }

        common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.count, currEventArray[z].c);
        common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.count, currEventArray[z].c);

        var postfix2 = common.crypto.createHash("md5").update(shortEventName).digest('base64')[0];
        var dateIds = common.getDateIds({"time": timeObj});

        var _id = currEventArray[z].a + "_" + eventCollectionName + "_no-segment_" + dateIds.month;
        //Current event
        writeBatcher.add("events_data", _id, {
            "$set": {
                "m": dateIds.month,
                "s": "no-segment",
                "a": currEventArray[z].a + "",
                "e": shortEventName
            },
            "$inc": tmpEventObj
        }, "countly");

        //Total event
        writeBatcher.add("events_data", currEventArray[z].a + "_all_key_" + dateIds.month + "_" + postfix2, {
            "$set": {
                "m": dateIds.month,
                "s": "key",
                "a": currEventArray[z].a + "",
                "e": "all"
            },
            "$inc": tmpTotalObj
        }, "countly");

        //Meta document for all events:
        writeBatcher.add("events_data", currEventArray[z].a + "_all_" + "no-segment_" + dateIds.zero + "_" + postfix2, {
            $set: {
                m: dateIds.zero,
                s: "no-segment",
                a: currEventArray[z].a + "",
                e: "all",
                ["meta_v2.key." + shortEventName]: true,
                "meta_v2.segments.key": true

            }
        }, "countly",
        {token: token});
        if (Object.keys(rootUpdate).length) {
            await common.db.collection("events").updateOne({_id: common.db.ObjectID(currEventArray[z].a)}, rootUpdate, {upsert: true});
        }
    }
};


usage.processEventTotalsFromStream = async function(token, currEvent, writeBatcher) {
    var rootUpdate = {};
    var eventColl = await common.readBatcher.getOne("events", common.db.ObjectID(currEvent.a), {"transformation": "event_object"});
    var appData = await common.readBatcher.getOne("apps", common.db.ObjectID(currEvent.a), {timezone: 1, plugins: 1});
    var conff = plugins.getConfig("api", appData.plugins, true);
    //Get timezone offset in hours from timezone name
    var appTimezone = appData.timezone || "UTC";

    var tmpEventObj = {};
    var tmpTotalObj = {};

    var shortEventName = currEvent.e;
    eventColl = eventColl || {};
    if (!eventColl._list || eventColl._list[shortEventName] !== true) {
        eventColl._list = eventColl._list || {};
        eventColl._list_length = eventColl._list_length || 0;
        if (eventColl._list_length &lt;= conff.event_limit) {
            eventColl._list[shortEventName] = true;
            eventColl._list_length++;
            rootUpdate.$addToSet = {list: shortEventName};
        }
        else {
            return; //do not record this event in aggregated data
        }
    }
    var eventCollectionName = crypto.createHash('sha1').update(shortEventName + currEvent.a).digest('hex');
    //Calculate h based on ts and app timezone
    currEvent.h = common.getDate(currEvent.ts, appTimezone);
    currEvent.h = currEvent.h.format("YYYY:MM:DD:HH");
    currEvent.h = currEvent.h.replaceAll(":0", ":");
    var date = currEvent.h.split(":");
    var timeObj = {"yearly": date[0], "weekly": 1, "monthly": date[1], "month": date[1], "day": date[2], "hour": date[3]};
    if (currEvent.s &amp;&amp; common.isNumber(currEvent.s)) {
        common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.sum, currEvent.s);
        common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.sum, currEvent.s);
    }
    else {
        currEvent.s = 0;
    }
    if (currEvent.dur &amp;&amp; common.isNumber(currEvent.dur)) {
        common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.dur, currEvent.dur);
        common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.dur, currEvent.dur);
    }
    else {
        currEvent.dur = 0;
    }
    currEvent.c = currEvent.c || 1;
    if (currEvent.c &amp;&amp; common.isNumber(currEvent.c)) {
        currEvent.c = parseInt(currEvent.c, 10);
    }

    common.fillTimeObjectMonth({"time": timeObj}, tmpEventObj, common.dbMap.count, currEvent.c);
    common.fillTimeObjectMonth({"time": timeObj}, tmpTotalObj, shortEventName + '.' + common.dbMap.count, currEvent.c);

    var postfix2 = common.crypto.createHash("md5").update(shortEventName).digest('base64')[0];
    var dateIds = common.getDateIds({"time": timeObj});

    var _id = currEvent.a + "_" + eventCollectionName + "_no-segment_" + dateIds.month;
    //Current event
    writeBatcher.add("events_data", _id, {
        "$set": {
            "m": dateIds.month,
            "s": "no-segment",
            "a": currEvent.a + "",
            "e": shortEventName
        },
        "$inc": tmpEventObj
    }, "countly");

    //Total event
    writeBatcher.add("events_data", currEvent.a + "_all_key_" + dateIds.month + "_" + postfix2, {
        "$set": {
            "m": dateIds.month,
            "s": "key",
            "a": currEvent.a + "",
            "e": "all"
        },
        "$inc": tmpTotalObj
    }, "countly");

    //Meta document for all events:
    writeBatcher.add("events_data", currEvent.a + "_all_" + "no-segment_" + dateIds.zero + "_" + postfix2, {
        $set: {
            m: dateIds.zero,
            s: "no-segment",
            a: currEvent.a + "",
            e: "all",
            ["meta_v2.key." + shortEventName]: true,
            "meta_v2.segments.key": true

        }
    }, "countly",
    {token: token});
    if (Object.keys(rootUpdate).length) {
        await common.db.collection("events").updateOne({_id: common.db.ObjectID(currEvent.a)}, rootUpdate, {upsert: true});
    }


};


usage.processEventFromStream = function(token, currEvent, writeBatcher) {
    writeBatcher = writeBatcher || common.writeBatcher;
    var forbiddenSegValues = [];
    for (let i = 1; i &lt; 32; i++) {
        forbiddenSegValues.push(i + "");
    }

    //Write event totals for aggregated Data

    common.readBatcher.getOne("apps", common.db.ObjectID(currEvent.a), function(err, app) {
        if (err || !app) {
            return;
        }
        else {
            common.readBatcher.getOne("events", common.db.ObjectID(currEvent.a), {"transformation": "event_object"}, async function(err2, eventColl) {
                var tmpEventObj = {};
                var tmpEventColl = {};
                var tmpTotalObj = {};
                var pluginsGetConfig = plugins.getConfig("api", app.plugins, true);

                var time = common.initTimeObj(app.timezone, currEvent.ts);
                var params = {time: time, app_id: currEvent.a, app: app, appTimezone: app.timezone || "UTC"};

                var shortEventName = currEvent.n;
                if (currEvent.e !== "[CLY]_custom") {
                    shortEventName = currEvent.e;
                }
                var rootUpdate = {};
                eventColl = eventColl || {};
                if (!eventColl._list || eventColl._list[shortEventName] !== true) {
                    eventColl._list = eventColl._list || {};
                    eventColl._list_length = eventColl._list_length || 0;
                    if (eventColl._list_length &lt;= 500) {
                        eventColl._list[shortEventName] = true;
                        eventColl._list_length++;
                        rootUpdate.$addToSet = {list: shortEventName};
                    }
                    else {
                        return; //do not record this event in aggregated data
                    }
                }
                eventColl._segments = eventColl._segments || {};
                var eventCollectionName = crypto.createHash('sha1').update(shortEventName + params.app_id).digest('hex');
                var updates = [];

                if (currEvent.s &amp;&amp; common.isNumber(currEvent.s)) {
                    common.fillTimeObjectMonth(params, tmpEventObj, common.dbMap.sum, currEvent.s);
                    common.fillTimeObjectMonth(params, tmpTotalObj, shortEventName + '.' + common.dbMap.sum, currEvent.s);
                }
                else {
                    currEvent.s = 0;
                }

                if (currEvent.dur &amp;&amp; common.isNumber(currEvent.dur)) {
                    common.fillTimeObjectMonth(params, tmpEventObj, common.dbMap.dur, currEvent.dur);
                    common.fillTimeObjectMonth(params, tmpTotalObj, shortEventName + '.' + common.dbMap.dur, currEvent.dur);
                }
                else {
                    currEvent.dur = 0;
                }
                currEvent.c = currEvent.c || 1;
                if (currEvent.c &amp;&amp; common.isNumber(currEvent.c)) {
                    currEvent.count = parseInt(currEvent.c, 10);
                }

                common.fillTimeObjectMonth(params, tmpEventObj, common.dbMap.count, currEvent.count);
                common.fillTimeObjectMonth(params, tmpTotalObj, shortEventName + '.' + common.dbMap.count, currEvent.count);


                for (var seg in currEvent.sg) {
                    if (forbiddenSegValues.indexOf(currEvent.sg[seg] + "") !== -1) {
                        continue;
                    }
                    if (eventColl._omitted_segments &amp;&amp; eventColl._omitted_segments[shortEventName]) {
                        if (eventColl._omitted_segments[shortEventName][seg]) {
                            continue;
                        }
                    }
                    if (eventColl._whitelisted_segments &amp;&amp; eventColl._whitelisted_segments[shortEventName]) {
                        if (!eventColl._whitelisted_segments[shortEventName][seg]) {
                            continue;
                        }
                    }
                    if (Array.isArray(currEvent.sg[seg])) {
                        continue; //Skipping arrays 
                    }

                    //Segment is not registred in meta.
                    if (!eventColl._segments[shortEventName] || !eventColl._segments[shortEventName]._list[seg]) {
                        eventColl._segments[shortEventName] = eventColl._segments[shortEventName] || {_list: {}, _list_length: 0};
                        eventColl._segments[shortEventName]._list[seg] = true;
                        rootUpdate.$addToSet = rootUpdate.$addToSet || {};
                        if (rootUpdate.$addToSet["segments." + shortEventName]) {
                            if (rootUpdate.$addToSet["segments." + shortEventName].$each) {
                                rootUpdate.$addToSet["segments." + shortEventName].$each.push(seg);
                            }
                            else {
                                rootUpdate.$addToSet["segments." + shortEventName] = {$each: [rootUpdate.$addToSet["segments." + shortEventName], seg]};
                            }
                        }
                        else {
                            rootUpdate.$addToSet["segments." + shortEventName] = seg;
                        }
                    }

                    //load meta for this segment in cacher. Add new value if needed

                    var tmpSegVal = currEvent.sg[seg] + "";
                    tmpSegVal = tmpSegVal.replace(/^\$+/, "").replace(/\./g, ":");
                    tmpSegVal = common.encodeCharacters(tmpSegVal);

                    if (forbiddenSegValues.indexOf(tmpSegVal) !== -1) {
                        tmpSegVal = "[CLY]" + tmpSegVal;
                    }

                    var postfix_seg = common.crypto.createHash("md5").update(tmpSegVal).digest('base64')[0];
                    var meta = await common.readBatcher.getOne("events_meta", {"_id": eventCollectionName + "no-segment_" + common.getDateIds(params).zero + "_" + postfix_seg});

                    if (pluginsGetConfig.event_segmentation_value_limit &amp;&amp; meta.meta_v2 &amp;&amp;
                        meta.meta_v2[seg] &amp;&amp;
                        meta.meta_v2[seg].indexOf(tmpSegVal) === -1 &amp;&amp;
                        meta.meta_v2[seg].length >= pluginsGetConfig.event_segmentation_value_limit) {
                        continue;
                    }

                    if (!meta.meta_v2 || !meta.meta_v2[seg] || meta.meta_v2[seg].indexOf(tmpSegVal) === -1) {
                        meta.meta_v2 = meta.meta_v2 || {};
                        meta.meta_v2[seg] = meta.meta_v2[seg] || [];
                        meta.meta_v2[seg].push(tmpSegVal);
                        updates.push({
                            id: currEvent.a + "_" + eventCollectionName + "_no-segment_" + common.getDateIds(params).zero + "_" + postfix_seg,
                            update: {"$set": {["meta_v2." + seg + "." + tmpSegVal]: true, ["meta_v2.segments." + seg]: true, "s": "no-segment", "e": shortEventName, "m": common.getDateIds(params).zero, "a": params.app_id + ""}}
                        });
                    }
                    //record data
                    var tmpObj = {};

                    if (currEvent.s) {
                        common.fillTimeObjectMonth(params, tmpObj, tmpSegVal + '.' + common.dbMap.sum, currEvent.s);
                    }

                    if (currEvent.dur) {
                        common.fillTimeObjectMonth(params, tmpEventObj, tmpSegVal + '.' + common.dbMap.dur, currEvent.dur);
                    }

                    common.fillTimeObjectMonth(params, tmpObj, tmpSegVal + '.' + common.dbMap.count, currEvent.c);
                    updates.push({
                        id: currEvent.a + "_" + eventCollectionName + "_" + seg + "_" + common.getDateIds(params).month + "_" + postfix_seg,
                        update: {$inc: tmpObj, $set: {"s": seg, "e": shortEventName, m: common.getDateIds(params).month, a: params.app_id + ""}}
                    });
                }

                var dateIds = common.getDateIds(params);
                var postfix2 = common.crypto.createHash("md5").update(shortEventName).digest('base64')[0];

                tmpEventColl["no-segment" + "." + dateIds.month] = tmpEventObj;

                for (var z = 0; z &lt; updates.length; z++) {
                    writeBatcher.add("events_data", updates[z].id, updates[z].update, "countly", {token: token});
                }
                //ID is - appID_hash_no-segment_month

                var _id = currEvent.a + "_" + eventCollectionName + "_no-segment_" + dateIds.month;
                //Current event
                writeBatcher.add("events_data", _id, {
                    "$set": {
                        "m": dateIds.month,
                        "s": "no-segment",
                        "a": params.app_id + "",
                        "e": shortEventName
                    },
                    "$inc": tmpEventObj
                }, "countly",
                {token: token});

                //Total event
                writeBatcher.add("events_data", currEvent.a + "_all_key_" + dateIds.month + "_" + postfix2, {
                    "$set": {
                        "m": dateIds.month,
                        "s": "key",
                        "a": params.app_id + "",
                        "e": "all"
                    },
                    "$inc": tmpTotalObj
                }, "countly",
                {token: token});

                //Meta document for all events:
                writeBatcher.add("events_data", params.app_id + "_all_" + "no-segment_" + dateIds.zero + "_" + postfix2, {
                    $set: {
                        m: dateIds.zero,
                        s: "no-segment",
                        a: params.app_id + "",
                        e: "all",
                        ["meta_v2.key." + shortEventName]: true,
                        "meta_v2.segments.key": true

                    }
                }, "countly",
                {token: token});
                //Total event meta data

                if (Object.keys(rootUpdate).length) {
                    common.db.collection("events").updateOne({_id: common.db.ObjectID(currEvent.a)}, rootUpdate, {upsert: true});
                }

            });
        }
    });
};

usage.processSessionMetricsFromStream = function(currEvent, uniqueLevelsZero, uniqueLevelsMonth, params) {
    /**
         * 
         * @param {string} id - document id 
         * @param {function} callback  - calback function
         */
    function fetchMeta(id, callback) {
        common.readBatcher.getOne(metaToFetch[id].coll, {'_id': metaToFetch[id].id}, {meta_v2: 1}, (err, metaDoc) => {
            var retObj = metaDoc || {};
            retObj.coll = metaToFetch[id].coll;
            callback(null, retObj);
        });
    }

    var isNewUser = true;
    var userProps = {};
    if (currEvent.sg &amp;&amp; currEvent.sg.prev_session) {
        isNewUser = false;
        //Not a new user

    }
    /**
 * Gets metric value from drill document based on metric rules
 * @param {object} metricRules  - object drscribing metric rules
 * @param {object} doc  - drill docment
 * @returns {string|number} - metric value
 */
    function getMetricValue(metricRules, doc) {
        if (metricRules.getMetricValue) {
            return metricRules.getMetricValue(doc);
        }
        else {
            return doc.up[metricRules.short_code];
        }
    }
    //We can't do metric changes unless we fetch previous session doc.
    var predefinedMetrics = usage.getPredefinedMetrics(params, userProps);

    var dateIds = common.getDateIds(params);
    var metaToFetch = {};

    if ((plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).metric_limit || 1000) > 0) {
        var postfix;
        for (let i = 0; i &lt; predefinedMetrics.length; i++) {
            for (let j = 0; j &lt; predefinedMetrics[i].metrics.length; j++) {
                let tmpMetric = predefinedMetrics[i].metrics[j],
                    recvMetricValue = getMetricValue(tmpMetric, currEvent);
                postfix = null;

                // We check if country data logging is on and user's country is the configured country of the app
                if (tmpMetric.name === "country" &amp;&amp; (plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).country_data === false)) {
                    continue;
                }
                // We check if city data logging is on and user's country is the configured country of the app
                if (tmpMetric.name === "city" &amp;&amp; (plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).city_data === false)) {
                    continue;
                }

                if (recvMetricValue) {
                    recvMetricValue = (recvMetricValue + "").replace(/^\$/, "").replace(/\./g, ":");
                    postfix = common.crypto.createHash("md5").update(recvMetricValue).digest('base64')[0];
                    metaToFetch[predefinedMetrics[i].db + params.app_id + "_" + dateIds.zero + "_" + postfix] = {
                        coll: predefinedMetrics[i].db,
                        id: params.app_id + "_" + dateIds.zero + "_" + postfix
                    };
                }
            }
        }

        var metas = {};
        async.map(Object.keys(metaToFetch), fetchMeta, function(err, metaDocs) {
            for (let i = 0; i &lt; metaDocs.length; i++) {
                if (metaDocs[i].coll &amp;&amp; metaDocs[i].meta_v2) {
                    metas[metaDocs[i]._id] = metaDocs[i].meta_v2;
                }
            }

            for (let i = 0; i &lt; predefinedMetrics.length; i++) {
                for (let j = 0; j &lt; predefinedMetrics[i].metrics.length; j++) {
                    let tmpTimeObjZero = {},
                        tmpTimeObjMonth = {},
                        tmpSet = {},
                        needsUpdate = false,
                        zeroObjUpdate = [],
                        monthObjUpdate = [],
                        tmpMetric = predefinedMetrics[i].metrics[j],
                        recvMetricValue = "",
                        escapedMetricVal = "";

                    postfix = "";

                    recvMetricValue = getMetricValue(tmpMetric, currEvent);

                    // We check if country data logging is on and user's country is the configured country of the app
                    if (tmpMetric.name === "country" &amp;&amp; (plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).country_data === false)) {
                        continue;
                    }
                    // We check if city data logging is on and user's country is the configured country of the app
                    if (tmpMetric.name === "city" &amp;&amp; (plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).city_data === false)) {
                        continue;
                    }

                    if (recvMetricValue) {
                        escapedMetricVal = (recvMetricValue + "").replace(/^\$/, "").replace(/\./g, ":");
                        postfix = common.crypto.createHash("md5").update(escapedMetricVal).digest('base64')[0];

                        var tmpZeroId = params.app_id + "_" + dateIds.zero + "_" + postfix;
                        var ignore = false;
                        if (metas[tmpZeroId] &amp;&amp;
                                        metas[tmpZeroId][tmpMetric.set] &amp;&amp;
                                        Object.keys(metas[tmpZeroId][tmpMetric.set]).length &amp;&amp;
                                        Object.keys(metas[tmpZeroId][tmpMetric.set]).length >= plugins.getConfig("api", params.app &amp;&amp; params.app.plugins, true).metric_limit &amp;&amp;
                                        typeof metas[tmpZeroId][tmpMetric.set][escapedMetricVal] === "undefined") {
                            ignore = true;
                        }

                        //should metric be ignored for reaching the limit
                        if (!ignore) {
                            //making sure metrics are strings
                            needsUpdate = true;
                            tmpSet["meta_v2." + tmpMetric.set + "." + escapedMetricVal] = true;

                            monthObjUpdate.push(escapedMetricVal + '.' + common.dbMap.total);

                            if (isNewUser) {
                                zeroObjUpdate.push(escapedMetricVal + '.' + common.dbMap.unique);
                                monthObjUpdate.push(escapedMetricVal + '.' + common.dbMap.new);
                                monthObjUpdate.push(escapedMetricVal + '.' + common.dbMap.unique);
                            }
                            else {
                                for (let k = 0; k &lt; uniqueLevelsZero.length; k++) {
                                    if (uniqueLevelsZero[k] === "Y") {
                                        tmpTimeObjZero['d.' + escapedMetricVal + '.' + common.dbMap.unique] = 1;
                                    }
                                    else {
                                        tmpTimeObjZero['d.' + uniqueLevelsZero[k] + '.' + escapedMetricVal + '.' + common.dbMap.unique] = 1;
                                    }
                                }

                                for (let l = 0; l &lt; uniqueLevelsMonth.length; l++) {
                                    tmpTimeObjMonth['d.' + uniqueLevelsMonth[l] + '.' + escapedMetricVal + '.' + common.dbMap.unique] = 1;
                                }
                            }
                        }

                        common.fillTimeObjectZero(params, tmpTimeObjZero, zeroObjUpdate);
                        common.fillTimeObjectMonth(params, tmpTimeObjMonth, monthObjUpdate);

                        if (needsUpdate) {
                            tmpSet.m = dateIds.zero;
                            tmpSet.a = params.app_id + "";
                            var tmpMonthId = params.app_id + "_" + dateIds.month + "_" + postfix,
                                updateObjZero = {$set: tmpSet};

                            if (Object.keys(tmpTimeObjZero).length) {
                                updateObjZero.$inc = tmpTimeObjZero;
                            }

                            if (Object.keys(tmpTimeObjZero).length || Object.keys(tmpSet).length) {
                                common.writeBatcher.add(predefinedMetrics[i].db, tmpZeroId, updateObjZero);
                            }

                            common.writeBatcher.add(predefinedMetrics[i].db, tmpMonthId, {
                                $set: {
                                    m: dateIds.month,
                                    a: params.app_id + ""
                                },
                                '$inc': tmpTimeObjMonth
                            });
                        }
                    }
                }
            }
        });
    }
};


usage.getPredefinedMetrics = function(params, userProps) {
    var predefinedMetrics = [
        {
            db: "carriers",
            metrics: [{
                name: "_carrier",
                set: "carriers",
                short_code: common.dbUserMap.carrier
            }]
        },
        {
            db: "devices",
            metrics: [
                {
                    name: "_device",
                    set: "devices",
                    short_code: common.dbUserMap.device
                },
                {
                    name: "_manufacturer",
                    set: "manufacturers",
                    short_code: common.dbUserMap.manufacturer
                }
            ]
        },
        {
            db: "device_details",
            metrics: [
                {
                    name: "_app_version",
                    set: "app_versions",
                    short_code: common.dbUserMap.app_version
                },
                {
                    name: "_os",
                    set: "os",
                    short_code: common.dbUserMap.platform
                },
                {
                    name: "_device_type",
                    set: "device_type",
                    short_code: common.dbUserMap.device_type
                },
                {
                    name: "_os_version",
                    set: "os_versions",
                    short_code: common.dbUserMap.platform_version
                },
                {
                    name: "_resolution",
                    set: "resolutions",
                    short_code: common.dbUserMap.resolution
                },
                {
                    name: "_has_hinge",
                    set: "has_hinge",
                    short_code: common.dbUserMap.has_hinge
                }
            ]
        },
        {
            db: "cities",
            metrics: [{
                is_user_prop: true,
                name: "city",
                set: "cities",
                short_code: common.dbUserMap.city
            }]
        }
    ];
    var isNewUser = (params.app_user &amp;&amp; params.app_user[common.dbUserMap.first_seen]) ? false : true;
    plugins.dispatch("/session/metrics", {
        params: params,
        predefinedMetrics: predefinedMetrics,
        userProps: userProps,
        user: params.app_user,
        isNewUser: isNewUser
    });

    return predefinedMetrics;
};

module.exports = usage;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> on Sat Dec 13 2025 19:31:24 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
