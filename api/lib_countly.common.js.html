<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>lib/countly.common.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Channel.html">Channel</a></li><li><a href="DefaultRetryPolicy.html">DefaultRetryPolicy</a></li><li><a href="IPCJob.html">IPCJob</a></li><li><a href="IPCRetryPolicy.html">IPCRetryPolicy</a></li><li><a href="Job.html">Job</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Job.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Job.html#divide">divide</a></li><li data-type='method' style='display: none;'><a href="Job.html#getConcurrency">getConcurrency</a></li><li data-type='method' style='display: none;'><a href="Job.html#prepare">prepare</a></li><li data-type='method' style='display: none;'><a href="Job.html#retryPolicy">retryPolicy</a></li><li data-type='method' style='display: none;'><a href="Job.html#run">run</a></li></ul></li><li><a href="Manager.html">Manager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Manager.html#run">run</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runIPC">runIPC</a></li><li data-type='method' style='display: none;'><a href="Manager.html#runLocally">runLocally</a></li></ul></li><li><a href="module-api_lib_countly.model-countlyMetric.html">countlyMetric</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.fetchValue">countlyMetric.fetchValue</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.clearObject">countlyMetric.clearObject</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.extendDb">countlyMetric.extendDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getBars">countlyMetric.getBars</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getData">countlyMetric.getData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getDb">countlyMetric.getDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMeta">countlyMetric.getMeta</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getMetrics">countlyMetric.getMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getNumber">countlyMetric.getNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getRangeData">countlyMetric.getRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTableData">countlyMetric.getTableData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTimelineData">countlyMetric.getTimelineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getTotalUsersObj">countlyMetric.getTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.getUniqueMetrics">countlyMetric.getUniqueMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.reset">countlyMetric.reset</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setDb">countlyMetric.setDb</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setMetrics">countlyMetric.setMetrics</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setTotalUsersObj">countlyMetric.setTotalUsersObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model-countlyMetric.html#.countlyMetric.setUniqueMetrics">countlyMetric.setUniqueMetrics</a></li></ul></li><li><a href="module-api_utils_log-Logger.html">Logger</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.d">d</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.e">e</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.i">i</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_log-Logger.html#.w">w</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.callback">callback</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log-Logger.html#.logdb">logdb</a></li></ul></li><li><a href="MonitorJob.html">MonitorJob</a></li><li><a href="NoRetryPolicy.html">NoRetryPolicy</a></li><li><a href="Resource.html">Resource</a></li><li><a href="ResourceFa%25C3%25A7ade.html">ResourceFaçade</a></li><li><a href="ResourcefulJob.html">ResourcefulJob</a></li><li><a href="ResourceInterface.html">ResourceInterface</a></li></ul><h3>Modules</h3><ul><li><a href="module-api_lib_countly.common.html">api/lib/countly.common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_lib_countly.common.html#.periodObj">periodObj</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decode">decode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.decodeHtml">decodeHtml</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.encode">encode</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractBarData">extractBarData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractChartData">extractChartData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractData">extractData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractMetric">extractMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractRangeData">extractRangeData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.extractTwoLevelData">extractTwoLevelData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDashboardData">getDashboardData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDateRange">getDateRange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPercentChange">getPercentChange</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getPeriodObj">getPeriodObj</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getShortNumber">getShortNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getSparklineData">getSparklineData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.getTimestampRangeQuery">getTimestampRangeQuery</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.mergeMetricsByName">mergeMetricsByName</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setPeriod">setPeriod</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.setTimezone">setTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.timeString">timeString</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.common.html#.union">union</a></li></ul></li><li><a href="module-api_lib_countly.countries.html">api/lib/countly.countries</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.countries.html#.getLocationData">getLocationData</a></li></ul></li><li><a href="module-api_lib_countly.device_details.html">api/lib/countly.device_details</a></li><li><a href="module-api_lib_countly.devices.html">api/lib/countly.devices</a></li><li><a href="module-api_lib_countly.event.html">api/lib/countly.event</a></li><li><a href="module-api_lib_countly.model.html">api/lib/countly.model</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.model.html#.load">load</a></li></ul></li><li><a href="module-api_lib_countly.users.html">api/lib/countly.users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSessionData">getSessionData</a></li><li data-type='method' style='display: none;'><a href="module-api_lib_countly.users.html#.getSubperiodData">getSubperiodData</a></li></ul></li><li><a href="module-api_config.html">api/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.api">api</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.encryption">encryption</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.fileStorage">fileStorage</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.ignoreProxies">ignoreProxies</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.logging">logging</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.mongodb">mongodb</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.path">path</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.reloadConfigAfter">reloadConfigAfter</a></li><li data-type='member' style='display: none;'><a href="module-api_config.html#.reloadConfigAfter">reloadConfigAfter</a></li></ul></li><li><a href="module-api_parts_data_exports.html">api/parts/data/exports</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.convertData">convertData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromData">fromData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromDatabase">fromDatabase</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.fromRequest">fromRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.output">output</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_exports.html#.stream">stream</a></li></ul></li><li><a href="module-api_parts_data_fetch.html">api/parts/data/fetch</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMergedEventData">getMergedEventData</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getMetric">getMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObj">getTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTimeObjForEvents">getTimeObjForEvents</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_data_fetch.html#.getTotalUsersObj">getTotalUsersObj</a></li></ul></li><li><a href="module-api_parts_mgmt_app_users.html">api/parts/mgmt/app_users</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.count">count</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.delete">delete</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.export">export</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.getUid">getUid</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.merge">merge</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.search">search</a></li><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_app_users.html#.update">update</a></li></ul></li><li><a href="module-api_parts_mgmt_ip.html">api/parts/mgmt/ip</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_parts_mgmt_ip.html#.getHost">getHost</a></li></ul></li><li><a href="module-api_utils_authorizer.html">api/utils/authorizer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.check_if_expired">check_if_expired</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.clean">clean</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.extend_token">extend_token</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.read">read</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.save">save</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify">verify</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_authorizer.html#.verify_return">verify_return</a></li></ul></li><li><a href="module-api_utils_common.html">api/utils/common</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.base64">base64</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.config">config</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.crypto">crypto</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbEventMap">dbEventMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbMap">dbMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.dbUserMap">dbUserMap</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.log">log</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.moment">moment</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.os_mapping">os_mapping</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_common.html#.time">time</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.adjustTimestampByTimezone">adjustTimestampByTimezone</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.arrayAddUniq">arrayAddUniq</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.blockResponses">blockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.checkPromise">checkPromise</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.convertToType">convertToType</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.dot">dot</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.equal">equal</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.escape_html">escape_html</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObject">fillTimeObject</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectMonth">fillTimeObjectMonth</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fillTimeObjectZero">fillTimeObjectZero</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.fixEventKey">fixEventKey</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDate">getDate</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDateIds">getDateIds</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDaysInYear">getDaysInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDescendantProp">getDescendantProp</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDiff">getDiff</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getDOY">getDOY</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getIpAddress">getIpAddress</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.getISOWeeksInYear">getISOWeeksInYear</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.indexOf">indexOf</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.initTimeObj">initTimeObj</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.isNumber">isNumber</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.md5Hash">md5Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.o">o</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.optional">optional</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.p">p</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.parseSequence">parseSequence</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.processCarrier">processCarrier</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordCustomMetric">recordCustomMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.recordMetric">recordMetric</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnMessage">returnMessage</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnOutput">returnOutput</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.returnRaw">returnRaw</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.reviver">reviver</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.safeDivision">safeDivision</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha1Hash">sha1Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.sha512Hash">sha512Hash</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.unblockResponses">unblockResponses</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.updateAppUser">updateAppUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.validateArgs">validateArgs</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.versionCompare">versionCompare</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_common.html#.zeroFill">zeroFill</a></li></ul></li><li><a href="module-api_utils_countlyFs.html">api/utils/countlyFs</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.fs">fs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.gridfs">gridfs</a></li><li data-type='member' style='display: none;'><a href="module-api_utils_countlyFs.html#.type">type</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.exists">exists</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getData">getData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getHandler">getHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getSize">getSize</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStats">getStats</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.getStream">getStream</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.rename">rename</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveData">saveData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveFile">saveFile</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_countlyFs.html#.saveStream">saveStream</a></li></ul></li><li><a href="module-api_utils_localization.html">api/utils/localization</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.format">format</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperties">getProperties</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_localization.html#.getProperty">getProperty</a></li></ul></li><li><a href="module-api_utils_log.html">api/utils/log</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.getLevel">getLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.ipcHandler">ipcHandler</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setDefault">setDefault</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#.setLevel">setLevel</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~log">log</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_log.html#~logLevel">logLevel</a></li></ul></li><li><a href="module-api_utils_render.html">api/utils/render</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_render.html#.renderView">renderView</a></li></ul></li><li><a href="module-api_utils_requestProcessor.html">api/utils/requestProcessor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#.processRequest">processRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~continueProcessingRequestData">continueProcessingRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processBulkRequest">processBulkRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~processRequestData">processRequestData</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~restartRequest">restartRequest</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_requestProcessor.html#~validateAppForWriteAPI">validateAppForWriteAPI</a></li></ul></li><li><a href="module-api_utils_rights.html">api/utils/rights</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateGlobalAdmin">validateGlobalAdmin</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUser">validateUser</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForRead">validateUserForRead</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_rights.html#.validateUserForWrite">validateUserForWrite</a></li></ul></li><li><a href="module-api_utils_taskmanager.html">api/utils/taskmanager</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkIfRunning">checkIfRunning</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.checkResult">checkResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.createTask">createTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.deleteResult">deleteResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.editTask">editTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.errorResults">errorResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getId">getId</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResult">getResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.getResults">getResults</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.longtask">longtask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.nameResult">nameResult</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.rerunTask">rerunTask</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_taskmanager.html#.saveResult">saveResult</a></li></ul></li><li><a href="module-api_utils_utils.html">api/utils/utils</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.decrypt">decrypt</a></li><li data-type='method' style='display: none;'><a href="module-api_utils_utils.html#.encrypt">encrypt</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#APICallback">APICallback</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#IPC">IPC</a></li><li><a href="global.html#params">params</a></li><li><a href="global.html#passToMaster">passToMaster</a></li><li><a href="global.html#timeObject">timeObject</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/countly.common.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* This module defines default model to handle users collection data
* @module "api/lib/countly.common"
*/

/** @lends module:api/lib/countly.common */
var countlyCommon = {},
    time = require('time')(Date),
    moment = require('moment-timezone'),
    underscore = require('underscore');

(function (countlyCommon) {

    // Private Properties
    var _period = "hour",
        _appTimezone = "UTC",
        _currMoment = moment();

    // Public Properties
    /**
    * Currently selected period
    * @property {number} start - period start timestamp in miliseconds
    * @property {number} end - period end timestamp in miliseconds
    * @property {array} currentPeriodArr - array with ticks for current period (available only for special periods), example ["2016.12.22","2016.12.23","2016.12.24", ...]
    * @property {array} previousPeriodArr - array with ticks for previous period (available only for special periods), example ["2016.12.22","2016.12.23","2016.12.24", ...]
    * @property {string} dateString - date format to use when outputting date in graphs, example D MMM, YYYY
    * @property {boolean} isSpecialPeriod - true if current period is special period, false if it is not
    * @property {number} daysInPeriod - amount of full days in selected period, example 30
    * @property {boolean} periodContainsToday - true if period contains today, false if not
    * @property {array} uniquePeriodArr - array with ticks for current period which contains data for unique values, like unique users, example ["2016.12.22","2016.w52","2016.12.30", ...]
    * @property {array} uniquePeriodCheckArr - array with ticks for higher buckets to current period unique value estimation, example ["2016.w51","2016.w52","2016.w53","2017.1",...]
    * @property {array} previousUniquePeriodArr - array with ticks for previous period which contains data for unique values, like unique users, example ["2016.12.22","2016.w52","2016.12.30"]
    * @property {array} previousUniquePeriodCheckArr - array with ticks for higher buckets to previous period unique value estimation, example ["2016.w47","2016.w48","2016.12"]
    * @property {string} activePeriod - period name formatted in dateString (available in non-special periods)
    * @property {string} previousPeriod - previous period name formatted in dateString (available in non-special periods)
    * @property {number} periodMax - max value of current period tick (available in non-special periods)
    * @property {number} periodMin - min value of current period tick (available in non-special periods)
    * @property {array} reqMonthDbDateIds - metric model month document ids to query for this period
    * @property {array} reqZeroDbDateIds - metric model year document ids to query for this period
    * @example &lt;caption>Special period object (7days)&lt;/caption>
    * {
    *    "start":1487721600000,
    *    "end":1488326399000,
    *    "activePeriod":"NA",
    *    "periodMax":"NA",
    *    "periodMin":"NA",
    *    "previousPeriod":"NA",
    *    "currentPeriodArr":["2017.2.22","2017.2.23","2017.2.24","2017.2.25","2017.2.26","2017.2.27","2017.2.28"],
    *    "previousPeriodArr":["2017.2.15","2017.2.16","2017.2.17","2017.2.18","2017.2.19","2017.2.20","2017.2.21"],
    *    "uniquePeriodArr":["2017.2.22","2017.2.23","2017.2.24","2017.2.25","2017.w9"],
    *    "uniquePeriodCheckArr":["2017.w8","2017.w9"],
    *    "previousUniquePeriodArr":["2017.2.15","2017.2.16","2017.2.17","2017.2.18","2017.2.19","2017.2.20","2017.2.21"],
    *    "previousUniquePeriodCheckArr":["2017.w7","2017.w8"],
    *    "dateString":"D MMM",
    *    "daysInPeriod":7,
    *    "isSpecialPeriod":true,
    *    "reqMonthDbDateIds":["2017:2"],
    *    "reqZeroDbDateIds":["2017:0"],
    *    "periodContainsToday":true
    * }
    * @example &lt;caption>Simple period object (today period - hour)&lt;/caption>
    * {
    *    "start":1488240000000,
    *    "end":1488326399000,
    *    "activePeriod":"2017.2.28",
    *    "periodMax":11,
    *    "periodMin":0,
    *    "previousPeriod":"2017.2.27",
    *    "currentPeriodArr":["2017.2.28"],
    *    "previousPeriodArr":["2017.2.27"],
    *    "uniquePeriodArr":[],
    *    "uniquePeriodCheckArr":[],
    *    "previousUniquePeriodArr":[],
    *    "previousUniquePeriodCheckArr":[],
    *    "dateString":"HH:mm",
    *    "daysInPeriod":1,
    *    "isSpecialPeriod":false,
    *    "reqMonthDbDateIds":["2017:2"],
    *    "reqZeroDbDateIds":["2017:0"],
    *    "periodContainsToday":true
    * }
    */
    countlyCommon.periodObj = getPeriodObj();

    // Public Methods

    /**
    * Change timezone of internal Date object
    * @param {string} appTimezone - name of the timezone
    */
    countlyCommon.setTimezone = function(appTimezone) {
        if(appTimezone &amp;&amp; appTimezone.length){
            _appTimezone = appTimezone;
        
            var currTime = new Date();
            currTime.setTimezone(appTimezone);
            
            _currMoment = moment(currTime);
            _currMoment.tz(appTimezone);
            countlyCommon.periodObj = getPeriodObj();
        }
    };

    /**
    * Change currently selected period
    * @param {string|array} period - new period, supported values are (month, 60days, 30days, 7days, yesterday, hour or [startMiliseconds, endMiliseconds] as [1417730400000,1420149600000])
    */
    countlyCommon.setPeriod = function(period) {
        _period = period;
        countlyCommon.periodObj = getPeriodObj();
    };

    /**
    * Calculates the percent change between previous and current values.
    * @param {number} previous - data for previous period
    * @param {number} current - data for current period
    * @returns {object} in the following format {"percent": "20%", "trend": "u"}
    * @example
    *   //outputs {"percent":"100%","trend":"u"}
    *   countlyCommon.getPercentChange(100, 200);
    */
    countlyCommon.getPercentChange = function (previous, current) {
        var pChange = 0,
            trend = "";

        if (previous == 0) {
            pChange = "NA";
            trend = "u"; //upward
        } else if (current == 0) {
            pChange = "∞";
            trend = "d"; //downward
        } else {
            var change = (((current - previous) / previous) * 100).toFixed(1);
            pChange = countlyCommon.getShortNumber(change) + "%";

            if (change &lt; 0) {
                trend = "d";
            } else {
                trend = "u";
            }
        }

        return {"percent":pChange, "trend":trend};
    };

    /**
    * Fetches nested property values from an obj.
    * @param {object} obj - standard countly metric object
    * @param {string} desc - dot separate path to fetch from object
    * @returns {object} fetched object from provided path
    * @example &lt;caption>Path found&lt;/caption>
    * //outputs {"u":20,"t":20,"n":5}
    * countlyCommon.getDescendantProp({"2017":{"1":{"2":{"u":20,"t":20,"n":5}}}}, "2017.1.2");
    */
    countlyCommon.getDescendantProp = function (obj, desc) {
        desc = String(desc);

        if (desc.indexOf(".") === -1) {
            return obj[desc];
        }

        var arr = desc.split(".");
        while (arr.length &amp;&amp; (obj = obj[arr.shift()]));

        return obj;
    };

    /**
    * Extract range data from standard countly metric data model
    * @param {object} db - countly standard metric data object
    * @param {string} propertyName - name of the property to extract
    * @param {object} rangeArray - array of all metrics/segments to extract (usually what is contained in meta)
    * @param {function} explainRange - function to convert range/bucket index to meaningful label
    * @returns {array} array containing extracted ranged data as [{"f":"First session","t":352,"percent":"88.4"},{"f":"2 days","t":46,"percent":"11.6"}]
    * @example &lt;caption>Extracting session frequency from users collection&lt;/caption>
    *    //outputs [{"f":"First session","t":352,"percent":"88.4"},{"f":"2 days","t":46,"percent":"11.6"}]
    *    countlyCommon.extractRangeData(_userDb, "f", _frequencies, countlySession.explainFrequencyRange);
    */
    countlyCommon.extractRangeData = function (db, propertyName, rangeArray, explainRange) {

        countlyCommon.periodObj = getPeriodObj();

        var dataArr = [],
            dataArrCounter = 0,
            rangeTotal,
            total = 0;

        if (!rangeArray) {
            return dataArr;
        }

        for (var j = 0; j &lt; rangeArray.length; j++) {

            rangeTotal = 0;

            if (!countlyCommon.periodObj.isSpecialPeriod) {
                var tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.activePeriod + "." + propertyName);

                if (tmp_x &amp;&amp; tmp_x[rangeArray[j]]) {
                    rangeTotal += tmp_x[rangeArray[j]];
                }

                if (rangeTotal != 0) {
                    dataArr[dataArrCounter] = {};
                    dataArr[dataArrCounter][propertyName] = (explainRange) ? explainRange(rangeArray[j]) : rangeArray[j];
                    dataArr[dataArrCounter]["t"] = rangeTotal;

                    total += rangeTotal;
                    dataArrCounter++;
                }
            } else {
                var tmpRangeTotal = 0;

                for (var i = 0; i &lt; (countlyCommon.periodObj.uniquePeriodArr.length); i++) {
                    var tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodArr[i] + "." + propertyName);

                    if (tmp_x &amp;&amp; tmp_x[rangeArray[j]]) {
                        rangeTotal += tmp_x[rangeArray[j]];
                    }
                }

                for (var i = 0; i &lt; (countlyCommon.periodObj.uniquePeriodCheckArr.length); i++) {
                    var tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodCheckArr[i] + "." + propertyName);

                    if (tmp_x &amp;&amp; tmp_x[rangeArray[j]]) {
                        tmpRangeTotal += tmp_x[rangeArray[j]];
                    }
                }

                if (rangeTotal > tmpRangeTotal) {
                    rangeTotal = tmpRangeTotal;
                }

                if (rangeTotal != 0) {
                    dataArr[dataArrCounter] = {};
                    dataArr[dataArrCounter][propertyName] = (explainRange) ? explainRange(rangeArray[j]) : rangeArray[j];
                    dataArr[dataArrCounter]["t"] = rangeTotal;

                    total += rangeTotal;
                    dataArrCounter++;
                }
            }
        }

        for (var j = 0; j &lt; dataArr.length; j++) {
            dataArr[j].percent = ((dataArr[j]["t"] / total) * 100).toFixed(1);
        }

        dataArr.sort(function (a, b) {
            return -(a["t"] - b["t"]);
        });

        return dataArr;
    };

    /**
    * Extract single level data without metrics/segments, like total user data from users collection
    * @param {object} db - countly standard metric data object
    * @param {function} clearFunction - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @param {object} chartData - prefill chart data with labels, colors, etc
    * @param {object} dataProperties - describing which properties and how to extract
    * @returns {object} object to use in timeline graph with {"chartDP":chartData, "chartData":_.compact(tableData), "keyEvents":keyEvents}
    * @example &lt;caption>Extracting total users data from users collection&lt;/caption>
    * countlyCommon.extractChartData(_sessionDb, countlySession.clearObject, [
    *      { data:[], label:"Total Users" }
    *  ], [
    *      {
    *          name:"t",
    *          func:function (dataObj) {
    *              return dataObj["u"]
    *          }
    *      }
    *  ]);
    *  @example &lt;caption>Returned data&lt;/caption>
    * {"chartDP":[
    *    {
    *        "data":[[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0],[9,0],[10,0],[11,0],[12,0],[13,0],[14,0],[15,12]],
    *        "label":"Total Sessions",
    *        "color":"#DDDDDD",
    *        "mode":"ghost"
    *    },
    *    {
    *        "data":[[0,6],[1,14],[2,11],[3,18],[4,10],[5,32],[6,53],[7,55],[8,71],[9,82],[10,74],[11,69],[12,60],[13,17],[14,6],[15,3]],
    *        "label":"Total Sessions",
    *        "color":"#333933"
    *    }
    *  ],
    *  "chartData":[
    *    {"date":"22 Dec, 2016","pt":0,"t":6},
    *    {"date":"23 Dec, 2016","pt":0,"t":14},
    *    {"date":"24 Dec, 2016","pt":0,"t":11},
    *    {"date":"25 Dec, 2016","pt":0,"t":18},
    *    {"date":"26 Dec, 2016","pt":0,"t":10},
    *    {"date":"27 Dec, 2016","pt":0,"t":32},
    *    {"date":"28 Dec, 2016","pt":0,"t":53},
    *    {"date":"29 Dec, 2016","pt":0,"t":55},
    *    {"date":"30 Dec, 2016","pt":0,"t":71},
    *    {"date":"31 Dec, 2016","pt":0,"t":82},
    *    {"date":"1 Jan, 2017","pt":0,"t":74},
    *    {"date":"2 Jan, 2017","pt":0,"t":69},
    *    {"date":"3 Jan, 2017","pt":0,"t":60},
    *    {"date":"4 Jan, 2017","pt":0,"t":17},
    *    {"date":"5 Jan, 2017","pt":0,"t":6},
    *    {"date":"6 Jan, 2017","pt":12,"t":3}
    *  ],
    *  "keyEvents":[{"min":0,"max":12},{"min":0,"max":82}]
    * }
    */
    countlyCommon.extractChartData = function (db, clearFunction, chartData, dataProperties) {

        countlyCommon.periodObj = getPeriodObj();

        var periodMin = countlyCommon.periodObj.periodMin,
            periodMax = (countlyCommon.periodObj.periodMax + 1),
            dataObj = {},
            formattedDate = "",
            tableData = [],
            propertyNames = underscore.pluck(dataProperties, "name"),
            propertyFunctions = underscore.pluck(dataProperties, "func"),
            currOrPrevious = underscore.pluck(dataProperties, "period"),
            activeDate,
            activeDateArr;

        for (var j = 0; j &lt; propertyNames.length; j++) {
            if (currOrPrevious[j] === "previous") {
                if (countlyCommon.periodObj.isSpecialPeriod) {
                    periodMin = 0;
                    periodMax = countlyCommon.periodObj.previousPeriodArr.length;
                    activeDateArr = countlyCommon.periodObj.previousPeriodArr;
                } else {
                    activeDate = countlyCommon.periodObj.previousPeriod;
                }
            } else {
                if (countlyCommon.periodObj.isSpecialPeriod) {
                    periodMin = 0;
                    periodMax = countlyCommon.periodObj.currentPeriodArr.length;
                    activeDateArr = countlyCommon.periodObj.currentPeriodArr;
                } else {
                    activeDate = countlyCommon.periodObj.activePeriod;
                }
            }

            for (var i = periodMin; i &lt; periodMax; i++) {

                if (!countlyCommon.periodObj.isSpecialPeriod) {

                    if (countlyCommon.periodObj.periodMin == 0) {
                        formattedDate = moment((activeDate + " " + i + ":00:00").replace(/\./g, "/"), "YYYY/MM/DD HH:mm:ss");
                    } else if (("" + activeDate).indexOf(".") == -1) {
                        formattedDate = moment((activeDate + "/" + i + "/1").replace(/\./g, "/"), "YYYY/MM/DD");
                    } else {
                        formattedDate = moment((activeDate + "/" + i).replace(/\./g, "/"), "YYYY/MM/DD");
                    }

                    dataObj = countlyCommon.getDescendantProp(db, activeDate + "." + i);
                } else {
                    formattedDate = moment((activeDateArr[i]).replace(/\./g, "/"), "YYYY/MM/DD");
                    dataObj = countlyCommon.getDescendantProp(db, activeDateArr[i]);
                }

                dataObj = clearFunction(dataObj);

                if (!tableData[i]) {
                    tableData[i] = {};
                }

                tableData[i]["date"] = formattedDate.format(countlyCommon.periodObj.dateString);

                if (propertyFunctions[j]) {
                    propertyValue = propertyFunctions[j](dataObj);
                } else {
                    propertyValue = dataObj[propertyNames[j]];
                }

                chartData[j]["data"][chartData[j]["data"].length] = [i, propertyValue];
                tableData[i][propertyNames[j]] = propertyValue;
            }
        }

        var keyEvents = [];

        for (var k = 0; k &lt; chartData.length; k++) {
            var flatChartData = underscore.flatten(chartData[k]["data"]);
            var chartVals = underscore.reject(flatChartData, function (context, value, index, list) {
                return value % 2 == 0;
            });
            var chartIndexes = underscore.filter(flatChartData, function (context, value, index, list) {
                return value % 2 == 0;
            });

            keyEvents[k] = {};
            keyEvents[k].min = underscore.min(chartVals);
            keyEvents[k].max = underscore.max(chartVals);
        }

        return {"chartDP":chartData, "chartData":underscore.compact(tableData), "keyEvents":keyEvents};
    };
    
    /**
    * Get total data for period's each time bucket as comma separated string to generate sparkle/small bar lines
    * @param {object} data - countly metric model data
    * @param {object} props - object where key is output property name and value could be string as key from data object or function to create new value based on existing ones
    * @param {function} clearObject - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @returns {object} object with sparkleline data for each property
    * @example
    * var sparkLines = countlyCommon.getSparklineData(countlySession.getDb(), {
    *     "total-sessions": "t",
    *     "new-users": "n",
    *     "total-users": "u",
    *     "total-duration": "d",
    *     "events": "e",
    *     "returning-users": function(tmp_x){return Math.max(tmp_x["u"] - tmp_x["n"], 0);},
    *     "avg-duration-per-session": function(tmp_x){return (tmp_x["t"] == 0) ? 0 : (tmp_x["d"] / tmp_x["t"]);},
    *     "avg-events": function(tmp_x){return (tmp_x["u"] == 0) ? 0 : (tmp_x["e"] / tmp_x["u"]);}
    * }, countlySession.clearObject);
    * //outputs
    * {
    *   "total-sessions":"73,84,80,72,61,18,11,7,17,27,66,39,41,36,39,36,6,11,6,16,22,30,33,34,32,41,29,9,2,2",
    *   "new-users":"24,30,25,20,16,18,11,7,17,18,20,18,17,11,15,15,6,11,6,16,13,14,12,10,7,4,8,9,2,2",
    *   "total-users":"45,54,50,44,37,18,11,7,17,27,36,39,41,36,39,36,6,11,6,16,22,30,33,34,32,29,29,9,2,2",
    *   "total-duration":"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0",
    *   "events":"73,84,80,72,61,18,11,7,17,27,66,39,41,36,39,36,6,11,6,16,22,30,33,34,32,41,29,9,2,2",
    *   "returning-users":"21,24,25,24,21,0,0,0,0,9,16,21,24,25,24,21,0,0,0,0,9,16,21,24,25,25,21,0,0,0",
    *   "avg-duration-per-session":"0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0",
    *   "avg-events":"1.6222222222222222,1.5555555555555556,1.6,1.6363636363636365,1.6486486486486487,1,1,1,1,1,1.8333333333333333,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1.4137931034482758,1,1,1,1"
    * }
    */
    countlyCommon.getSparklineData = function(data, props, clearObject) {
        var _periodObj = countlyCommon.periodObj
        var sparkLines = {};
        for(var p in props){
            sparkLines[p] = [];
        }

        if (!_periodObj.isSpecialPeriod) {
            for (var i = _periodObj.periodMin; i &lt; (_periodObj.periodMax + 1); i++) {
                var tmp_x = countlyCommon.getDescendantProp(data, _periodObj.activePeriod + "." + i);
                tmp_x = clearObject(tmp_x);
                
                for(var p in props){
                    if(typeof props[p] === "string")
                        sparkLines[p].push(tmp_x[props[p]]);
                    else if(typeof props[p] === "function")
                        sparkLines[p].push(props[p](tmp_x));
                }
            }
        } else {
            for (var i = 0; i &lt; (_periodObj.currentPeriodArr.length); i++) {
                var tmp_x = countlyCommon.getDescendantProp(data, _periodObj.currentPeriodArr[i]);
                tmp_x = clearObject(tmp_x);

                for(var p in props){
                    if(typeof props[p] === "string")
                        sparkLines[p].push(tmp_x[props[p]]);
                    else if(typeof props[p] === "function")
                        sparkLines[p].push(props[p](tmp_x));
                }
            }
        }

        for (var key in sparkLines) {
            sparkLines[key] = sparkLines[key].join(",");
        }

        return sparkLines;
    }

    /**
    * Extract two level data with metrics/segments, like total user data from carriers collection
    * @param {object} db - countly standard metric data object
    * @param {object} rangeArray - array of all metrics/segments to extract (usually what is contained in meta)
    * @param {function} clearFunction - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @param {object} dataProperties - describing which properties and how to extract
    * @param {object=} totalUserOverrideObj - data from total users api request to correct unique user values
    * @returns {object} object to use in bar and pie charts with {"chartData":_.compact(tableData)}
    * @example &lt;caption>Extracting carriers data from carriers collection&lt;/caption>
    * var chartData = countlyCommon.extractTwoLevelData(_carrierDb, ["At&amp;t", "Verizon"], countlyCarrier.clearObject, [
    *      {
    *          name:"carrier",
    *          func:function (rangeArr, dataObj) {
    *              return rangeArr;
    *          }
    *      },
    *      { "name":"t" },
    *      { "name":"u" },
    *      { "name":"n" }
    * ]);
    * @example &lt;caption>Return data&lt;/caption>
    * {"chartData":['
    *    {"carrier":"At&amp;t","t":71,"u":62,"n":36},
    *    {"carrier":"Verizon","t":66,"u":60,"n":30}
    * ]}
    */
    countlyCommon.extractTwoLevelData = function (db, rangeArray, clearFunction, dataProperties, totalUserOverrideObj) {

        countlyCommon.periodObj = getPeriodObj();

        if (!rangeArray) {
            return {"chartData":tableData};
        }
        var periodMin = 0,
            periodMax = 0,
            dataObj = {},
            formattedDate = "",
            tableData = [],
            chartData = [],
            propertyNames = underscore.pluck(dataProperties, "name"),
            propertyFunctions = underscore.pluck(dataProperties, "func"),
            propertyValue = 0;

        if (!countlyCommon.periodObj.isSpecialPeriod) {
            periodMin = countlyCommon.periodObj.periodMin;
            periodMax = (countlyCommon.periodObj.periodMax + 1);
        } else {
            periodMin = 0;
            periodMax = countlyCommon.periodObj.currentPeriodArr.length;
        }

        var tableCounter = 0;

        if (!countlyCommon.periodObj.isSpecialPeriod) {
            for (var j = 0; j &lt; rangeArray.length; j++) {
                dataObj = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.activePeriod + "." + rangeArray[j]);

                if (!dataObj) {
                    continue;
                }

                dataObj = clearFunction(dataObj);

                var propertySum = 0,
                    tmpPropertyObj = {};

                for (var k = 0; k &lt; propertyNames.length; k++) {

                    if (propertyFunctions[k]) {
                        propertyValue = propertyFunctions[k](rangeArray[j], dataObj);
                    } else {
                        propertyValue = dataObj[propertyNames[k]];
                    }

                    if (typeof propertyValue !== 'string') {
                        propertySum += propertyValue;
                    }

                    tmpPropertyObj[propertyNames[k]] = propertyValue;
                }

                if (propertySum > 0) {
                    tableData[tableCounter] = {};
                    tableData[tableCounter] = tmpPropertyObj;
                    tableCounter++;
                }
            }
        } else {

            for (var j = 0; j &lt; rangeArray.length; j++) {

                var propertySum = 0,
                    tmpPropertyObj = {},
                    tmp_x = {};

                for (var i = periodMin; i &lt; periodMax; i++) {
                    dataObj = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.currentPeriodArr[i] + "." + rangeArray[j]);

                    if (!dataObj) {
                        continue;
                    }

                    dataObj = clearFunction(dataObj);

                    for (var k = 0; k &lt; propertyNames.length; k++) {

                        if (propertyNames[k] == "u") {
                            propertyValue = 0;
                        } else if (propertyFunctions[k]) {
                            propertyValue = propertyFunctions[k](rangeArray[j], dataObj);
                        } else {
                            propertyValue = dataObj[propertyNames[k]];
                        }

                        if (!tmpPropertyObj[propertyNames[k]]) {
                            tmpPropertyObj[propertyNames[k]] = 0;
                        }

                        if (typeof propertyValue === 'string') {
                            tmpPropertyObj[propertyNames[k]] = propertyValue;
                        } else {
                            propertySum += propertyValue;
                            tmpPropertyObj[propertyNames[k]] += propertyValue;
                        }
                    }
                }

                if (propertyNames.indexOf("u") !== -1 &amp;&amp; Object.keys(tmpPropertyObj).length) {
                    if (countlyCommon.periodObj.periodContainsToday &amp;&amp; totalUserOverrideObj &amp;&amp; totalUserOverrideObj[rangeArray[j]]) {

                        tmpPropertyObj["u"] = totalUserOverrideObj[rangeArray[j]];

                    } else {
                        var tmpUniqVal = 0,
                            tmpUniqValCheck = 0,
                            tmpCheckVal = 0;

                        for (var l = 0; l &lt; (countlyCommon.periodObj.uniquePeriodArr.length); l++) {
                            tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodArr[l] + "." + rangeArray[j]);
                            if (!tmp_x) {
                                continue;
                            }
                            tmp_x = clearFunction(tmp_x);
                            propertyValue = tmp_x["u"];

                            if (typeof propertyValue === 'string') {
                                tmpPropertyObj["u"] = propertyValue;
                            } else {
                                propertySum += propertyValue;
                                tmpUniqVal += propertyValue;
                                tmpPropertyObj["u"] += propertyValue;
                            }
                        }

                        for (var l = 0; l &lt; (countlyCommon.periodObj.uniquePeriodCheckArr.length); l++) {
                            tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodCheckArr[l] + "." + rangeArray[j]);
                            if (!tmp_x) {
                                continue;
                            }
                            tmp_x = clearFunction(tmp_x);
                            tmpCheckVal = tmp_x["u"];

                            if (typeof tmpCheckVal !== 'string') {
                                propertySum += tmpCheckVal;
                                tmpUniqValCheck += tmpCheckVal;
                            }
                        }

                        if (tmpUniqVal > tmpUniqValCheck) {
                            tmpPropertyObj["u"] = tmpUniqValCheck;
                        }
                    }

                    // Total users can't be less than new users
                    if (tmpPropertyObj.u &lt; tmpPropertyObj.n) {
                        tmpPropertyObj.u = tmpPropertyObj.n;
                    }

                    // Total users can't be more than total sessions
                    if (tmpPropertyObj.u > tmpPropertyObj.t) {
                        tmpPropertyObj.u = tmpPropertyObj.t;
                    }
                }

                tableData[tableCounter] = {};
                tableData[tableCounter] = tmpPropertyObj;
                tableCounter++;
            }
        }

        if (propertyNames.indexOf("u") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["u"];
            });
        } else if (propertyNames.indexOf("t") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["t"];
            });
        } else if (propertyNames.indexOf("c") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["c"];
            });
        }

        for (var i = 0; i &lt; tableData.length; i++) {
            if (underscore.isEmpty(tableData[i])) {
                tableData[i] = null;
            }
        }

        return {"chartData":underscore.compact(tableData)};
    };

    /**
    * Extracts top three items (from rangeArray) that have the biggest total session counts from the db object.
    * @param {object} db - countly standard metric data object
    * @param {object} rangeArray - array of all metrics/segments to extract (usually what is contained in meta)
    * @param {function} clearFunction - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @param {function} fetchFunction - function to fetch property, default used is function (rangeArr, dataObj) {return rangeArr;}
    * @param {number} maxItems - amount of items to return, default 3
    * @param {string=} metric - metric to output and use in sorting, default "t"
    * @param {object=} totalUserOverrideObj - data from total users api request to correct unique user values
    * @returns {array} array with top 3 values
    * @example &lt;caption>Return data&lt;/caption>
    * [
    *    {"name":"iOS","percent":35},
    *    {"name":"Android","percent":33},
    *    {"name":"Windows Phone","percent":32}
    * ]
    */
    countlyCommon.extractBarData = function (db, rangeArray, clearFunction, fetchFunction, maxItems, metric, totalUserOverrideObj) {
        metric =  metric || "t";
        maxItems = maxItems || 3;
        fetchFunction = fetchFunction || function (rangeArr, dataObj) {return rangeArr;};
        var dataProps = [
            {
                name:"range",
                func:fetchFunction
            },
            { "name":metric }
        ];
        //include other default metrics for data correction
        if(metric === "u"){
            dataProps.push({name:"n"});
            dataProps.push({name:"t"});
        }
        var rangeData = countlyCommon.extractTwoLevelData(db, rangeArray, clearFunction, dataProps, totalUserOverrideObj);
        var rangeNames = underscore.pluck(rangeData.chartData, 'range'),
            rangeTotal = underscore.pluck(rangeData.chartData, metric),
            barData = [],
            sum = 0,
            totalPercent = 0;

        if (rangeNames.length &lt; maxItems) {
            maxItems = rangeNames.length;
        }

        for (var i = 0; i &lt; maxItems; i++) {
            sum += rangeTotal[i];
        }

        for (var i = 0; i &lt; maxItems; i++) {
            var percent = Math.floor((rangeTotal[i] / sum) * 100);
            totalPercent += percent;

            if (i == (maxItems - 1)) {
                percent += 100 - totalPercent;
            }

            barData[i] = { "name":rangeNames[i], value:rangeTotal[i], "percent":percent };
        }

        return underscore.sortBy(barData, function(obj) { return -obj.value; });
    };

    /**
    * Shortens the given number by adding K (thousand) or M (million) postfix. K is added only if the number is bigger than 10000, etc.
    * @param {number} number - number to shorten
    * @returns {string} shorter representation of number
    * @example
    * //outputs 10K
    * countlyCommon.getShortNumber(10000);
    */
    countlyCommon.getShortNumber = function (number) {

        var tmpNumber = "";

        if (number >= 1000000 || number &lt;= -1000000) {
            tmpNumber = ((number / 1000000).toFixed(1).replace(".0", "")) + "M";
        } else if (number >= 10000 || number &lt;= -10000) {
            tmpNumber = ((number / 1000).toFixed(1).replace(".0", "")) + "K";
        } else {
            number += "";
            tmpNumber = number.replace(".0", "");
        }

        return tmpNumber;
    };

    /**
    * Getting the date range shown on the dashboard like 1 Aug - 30 Aug, using {@link countlyCommon.periodObj) dateString property which holds the date format.
    * @returns {string} string with  formatted date range as 1 Aug - 30 Aug
    */
    countlyCommon.getDateRange = function () {

        countlyCommon.periodObj = getPeriodObj();

        if (!countlyCommon.periodObj.isSpecialPeriod) {
            if (countlyCommon.periodObj.dateString == "HH:mm") {
                formattedDateStart = moment(countlyCommon.periodObj.activePeriod + " " + countlyCommon.periodObj.periodMin + ":00", "YYYY.M.D HH:mm");
                formattedDateEnd = moment(countlyCommon.periodObj.activePeriod + " " + countlyCommon.periodObj.periodMax + ":00", "YYYY.M.D HH:mm");

                var nowMin = _currMoment.format("mm");
                formattedDateEnd.add(nowMin, "minutes");

            } else if (countlyCommon.periodObj.dateString == "D MMM, HH:mm") {
                formattedDateStart = moment(countlyCommon.periodObj.activePeriod, "YYYY.M.D");
                formattedDateEnd = moment(countlyCommon.periodObj.activePeriod, "YYYY.M.D").add(23, "hours").add(59, "minutes");
            } else {
                formattedDateStart = moment(countlyCommon.periodObj.activePeriod + "." + countlyCommon.periodObj.periodMin, "YYYY.M.D");
                formattedDateEnd = moment(countlyCommon.periodObj.activePeriod + "." + countlyCommon.periodObj.periodMax, "YYYY.M.D");
            }
        } else {
            formattedDateStart = moment(countlyCommon.periodObj.currentPeriodArr[0], "YYYY.M.D");
            formattedDateEnd = moment(countlyCommon.periodObj.currentPeriodArr[(countlyCommon.periodObj.currentPeriodArr.length - 1)], "YYYY.M.D");
        }

        return formattedDateStart.format(countlyCommon.periodObj.dateString) + " - " + formattedDateEnd.format(countlyCommon.periodObj.dateString);
    };
	
    /**
    * Extract single level data without metrics/segments, like total user data from users collection
    * @param {object} db - countly standard metric data object
    * @param {function} clearFunction - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @param {object} dataProperties - describing which properties and how to extract
    * @returns {array} object to use in timeline graph
    * @example &lt;caption>Extracting total users data from users collection&lt;/caption>
    * countlyCommon.extractData(_sessionDb, countlySession.clearObject, [
    *     { name:"t" },
    *     { name:"n" },
    *     { name:"u" },
    *     { name:"d" },
    *     { name:"e" }
    * ]);
    * @example &lt;caption>Returned data&lt;/caption>
    * [
    *    {"_id":"2017-1-30","t":6,"n":6,"u":6,"d":0,"e":6},
    *    {"_id":"2017-1-31","t":2,"n":2,"u":2,"d":0,"e":2},
    *    {"_id":"2017-2-1","t":5,"n":5,"u":5,"d":0,"e":5},
    *    {"_id":"2017-2-2","t":5,"n":5,"u":5,"d":0,"e":5},
    *    {"_id":"2017-2-3","t":8,"n":8,"u":8,"d":0,"e":8},
    *    {"_id":"2017-2-4","t":7,"n":7,"u":7,"d":0,"e":7},
    *    {"_id":"2017-2-5","t":6,"n":6,"u":6,"d":0,"e":6},
    *    {"_id":"2017-2-6","t":5,"n":5,"u":5,"d":0,"e":5},
    *    {"_id":"2017-2-7","t":6,"n":6,"u":6,"d":0,"e":6},
    *    {"_id":"2017-2-8","t":5,"n":5,"u":5,"d":0,"e":5},
    *    {"_id":"2017-2-9","t":4,"n":4,"u":4,"d":0,"e":4},
    *    {"_id":"2017-2-10","t":6,"n":6,"u":6,"d":0,"e":6},
    *    {"_id":"2017-2-11","t":8,"n":8,"u":8,"d":0,"e":8},
    *    {"_id":"2017-2-12","t":3,"n":3,"u":3,"d":0,"e":3},
    *    {"_id":"2017-2-13","t":8,"n":6,"u":7,"d":0,"e":8},
    *    {"_id":"2017-2-14","t":7,"n":7,"u":7,"d":0,"e":7},
    *    {"_id":"2017-2-15","t":4,"n":4,"u":4,"d":0,"e":4},
    *    {"_id":"2017-2-16","t":2,"n":2,"u":2,"d":0,"e":2},
    *    {"_id":"2017-2-17","t":4,"n":4,"u":4,"d":0,"e":4},
    *    {"_id":"2017-2-18","t":14,"n":14,"u":14,"d":0,"e":14},
    *    {"_id":"2017-2-19","t":20,"n":11,"u":20,"d":0,"e":20},
    *    {"_id":"2017-2-20","t":25,"n":9,"u":25,"d":0,"e":25},
    *    {"_id":"2017-2-21","t":33,"n":12,"u":33,"d":0,"e":33},
    *    {"_id":"2017-2-22","t":36,"n":12,"u":36,"d":0,"e":36},
    *    {"_id":"2017-2-23","t":37,"n":12,"u":37,"d":0,"e":37},
    *    {"_id":"2017-2-24","t":29,"n":5,"u":29,"d":0,"e":29},
    *    {"_id":"2017-2-25","t":28,"n":7,"u":28,"d":0,"e":28},
    *    {"_id":"2017-2-26","t":3,"n":3,"u":3,"d":0,"e":3},
    *    {"_id":"2017-2-27","t":3,"n":3,"u":3,"d":0,"e":3},
    *    {"_id":"2017-2-28","t":7,"n":7,"u":7,"d":0,"e":7}
    * ]
    */
	countlyCommon.extractData = function (db, clearFunction, dataProperties) {

        countlyCommon.periodObj = getPeriodObj();

        var periodMin = countlyCommon.periodObj.periodMin,
            periodMax = (countlyCommon.periodObj.periodMax + 1),
            dataObj = {},
            formattedDate = "",
            tableData = [],
            propertyNames = underscore.pluck(dataProperties, "name"),
            propertyFunctions = underscore.pluck(dataProperties, "func"),
            currOrPrevious = underscore.pluck(dataProperties, "period"),
            activeDate,
            activeDateArr;

        for (var j = 0; j &lt; propertyNames.length; j++) {
            if (currOrPrevious[j] === "previous") {
                if (countlyCommon.periodObj.isSpecialPeriod) {
                    periodMin = 0;
                    periodMax = countlyCommon.periodObj.previousPeriodArr.length;
                    activeDateArr = countlyCommon.periodObj.previousPeriodArr;
                } else {
                    activeDate = countlyCommon.periodObj.previousPeriod;
                }
            } else {
                if (countlyCommon.periodObj.isSpecialPeriod) {
                    periodMin = 0;
                    periodMax = countlyCommon.periodObj.currentPeriodArr.length;
                    activeDateArr = countlyCommon.periodObj.currentPeriodArr;
                } else {
                    activeDate = countlyCommon.periodObj.activePeriod;
                }
            }
			var dateString = "";
            for (var i = periodMin; i &lt; periodMax; i++) {

                if (!countlyCommon.periodObj.isSpecialPeriod) {

                    if (countlyCommon.periodObj.periodMin == 0) {
						dateString = "YYYY-M-D H:00";
                        formattedDate = moment((activeDate + " " + i + ":00:00").replace(/\./g, "/"), "YYYY/MM/DD HH:mm:ss");
                    } else if (("" + activeDate).indexOf(".") == -1) {
						dateString = "YYYY-M";
                        formattedDate = moment((activeDate + "/" + i + "/1").replace(/\./g, "/"), "YYYY/MM/DD");
                    } else {
						dateString = "YYYY-M-D";
                        formattedDate = moment((activeDate + "/" + i).replace(/\./g, "/"), "YYYY/MM/DD");
                    }

                    dataObj = countlyCommon.getDescendantProp(db, activeDate + "." + i);
                } else {
					dateString = "YYYY-M-D";
                    formattedDate = moment((activeDateArr[i]).replace(/\./g, "/"), "YYYY/MM/DD");
                    dataObj = countlyCommon.getDescendantProp(db, activeDateArr[i]);
                }

                dataObj = clearFunction(dataObj);

                if (!tableData[i]) {
                    tableData[i] = {};
                }

                tableData[i]["_id"] = formattedDate.format(dateString);

                if (propertyFunctions[j]) {
                    propertyValue = propertyFunctions[j](dataObj);
                } else {
                    propertyValue = dataObj[propertyNames[j]];
                }
                tableData[i][propertyNames[j]] = propertyValue;
            }
        }

        return underscore.compact(tableData);
    };
	
    /**
    * Extract metrics data break down by segments, like total user by carriers
    * @param {object} db - countly standard metric data object
    * @param {object} rangeArray - array of all metrics/segments to extract (usually what is contained in meta)
    * @param {function} clearFunction - function to prefill all expected properties as u, t, n, etc with 0, so you would not have null in the result which won't work when drawing graphs
    * @param {object} dataProperties - describing which properties and how to extract
    * @param {object=} totalUserOverrideObj - data from total users api request to correct unique user values
    * @returns {array} object to use in timeline graph
    * @example &lt;caption>Extracting total users data from users collection&lt;/caption>
    * countlyCommon.extractData(countlyCarriers.getDb(), countlyCarriers.getMeta(), countlyCarriers.clearObject, [
    *     {
    *         name:"carriers",
    *         func:function (rangeArr, dataObj) {
    *             return rangeArr;
    *         }
    *     },
    *     { "name":"t" },
    *     { "name":"n" },
    *     { "name":"u" }
    * ]);
    * @example &lt;caption>Returned data&lt;/caption>
    * [
    *    {"_id":"Cricket Communications","t":37,"n":21,"u":34},
    *    {"_id":"Tele2","t":32,"n":19,"u":31},
    *    {"_id":"\tAt&amp;amp;t","t":32,"n":20,"u":31},
    *    {"_id":"O2","t":26,"n":19,"u":26},
    *    {"_id":"Metro Pcs","t":28,"n":13,"u":26},
    *    {"_id":"Turkcell","t":23,"n":11,"u":23},
    *    {"_id":"Telus","t":22,"n":15,"u":22},
    *    {"_id":"Rogers Wireless","t":21,"n":13,"u":21},
    *    {"_id":"Verizon","t":21,"n":11,"u":21},
    *    {"_id":"Sprint","t":21,"n":11,"u":20},
    *    {"_id":"Vodafone","t":22,"n":12,"u":19},
    *    {"_id":"Orange","t":18,"n":12,"u":18},
    *    {"_id":"T-mobile","t":17,"n":9,"u":17},
    *    {"_id":"Bell Canada","t":12,"n":6,"u":12}
    * ]
    */
	countlyCommon.extractMetric = function (db, rangeArray, clearFunction, dataProperties, totalUserOverrideObj) {

        countlyCommon.periodObj = getPeriodObj();

        if (!rangeArray) {
            return tableData;
        }
        var periodMin = 0,
            periodMax = 0,
            dataObj = {},
            formattedDate = "",
            tableData = [],
            chartData = [],
            propertyNames = underscore.pluck(dataProperties, "name"),
            propertyFunctions = underscore.pluck(dataProperties, "func"),
            propertyValue = 0;

        if (!countlyCommon.periodObj.isSpecialPeriod) {
            periodMin = countlyCommon.periodObj.periodMin;
            periodMax = (countlyCommon.periodObj.periodMax + 1);
        } else {
            periodMin = 0;
            periodMax = countlyCommon.periodObj.currentPeriodArr.length;
        }

        var tableCounter = 0;

        if (!countlyCommon.periodObj.isSpecialPeriod) {
            for (var j = 0; j &lt; rangeArray.length; j++) {
                dataObj = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.activePeriod + "." + rangeArray[j]);

                if (!dataObj) {
                    continue;
                }

                dataObj = clearFunction(dataObj);

                var propertySum = 0,
                    tmpPropertyObj = {};

                for (var k = 0; k &lt; propertyNames.length; k++) {

                    if (propertyFunctions[k]) {
                        propertyValue = propertyFunctions[k](rangeArray[j], dataObj);
                    } else {
                        propertyValue = dataObj[propertyNames[k]];
                    }

                    if (typeof propertyValue !== 'string') {
                        propertySum += propertyValue;
                    }
					if (propertyFunctions[k])
						tmpPropertyObj["_id"] = propertyValue;
					else
						tmpPropertyObj[propertyNames[k]] = propertyValue;
                }

                if (propertySum > 0) {
                    tableData[tableCounter] = {};
                    tableData[tableCounter] = tmpPropertyObj;
                    tableCounter++;
                }
            }
        } else {

            for (var j = 0; j &lt; rangeArray.length; j++) {

                var propertySum = 0,
                    tmpPropertyObj = {},
                    tmp_x = {};

                for (var i = periodMin; i &lt; periodMax; i++) {
                    dataObj = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.currentPeriodArr[i] + "." + rangeArray[j]);

                    if (!dataObj) {
                        continue;
                    }

                    dataObj = clearFunction(dataObj);

                    for (var k = 0; k &lt; propertyNames.length; k++) {

                        if (propertyNames[k] == "u") {
                            propertyValue = 0;
                        } else if (propertyFunctions[k]) {
                            propertyValue = propertyFunctions[k](rangeArray[j], dataObj);
                        } else {
                            propertyValue = dataObj[propertyNames[k]];
                        }
						
						if (propertyFunctions[k])
							tmpPropertyObj["_id"] = propertyValue;
						else
						{
							if (!tmpPropertyObj[propertyNames[k]]) {
								tmpPropertyObj[propertyNames[k]] = 0;
							}
	
							if (typeof propertyValue === 'string') {
								tmpPropertyObj[propertyNames[k]] = propertyValue;
							} else {
								propertySum += propertyValue;
								tmpPropertyObj[propertyNames[k]] += propertyValue;
							}
						}
                    }
                }

                if (propertyNames.indexOf("u") !== -1 &amp;&amp; Object.keys(tmpPropertyObj).length) {
                    if (countlyCommon.periodObj.periodContainsToday &amp;&amp; totalUserOverrideObj &amp;&amp; totalUserOverrideObj[rangeArray[j]]) {

                        tmpPropertyObj["u"] = totalUserOverrideObj[rangeArray[j]];

                    } else {
                        var tmpUniqVal = 0,
                            tmpUniqValCheck = 0,
                            tmpCheckVal = 0;

                        for (var l = 0; l &lt; (countlyCommon.periodObj.uniquePeriodArr.length); l++) {
                            tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodArr[l] + "." + rangeArray[j]);
                            if (!tmp_x) {
                                continue;
                            }
                            tmp_x = clearFunction(tmp_x);
                            propertyValue = tmp_x["u"];

                            if (typeof propertyValue === 'string') {
                                tmpPropertyObj["u"] = propertyValue;
                            } else {
                                propertySum += propertyValue;
                                tmpUniqVal += propertyValue;
                                tmpPropertyObj["u"] += propertyValue;
                            }
                        }

                        for (var l = 0; l &lt; (countlyCommon.periodObj.uniquePeriodCheckArr.length); l++) {
                            tmp_x = countlyCommon.getDescendantProp(db, countlyCommon.periodObj.uniquePeriodCheckArr[l] + "." + rangeArray[j]);
                            if (!tmp_x) {
                                continue;
                            }
                            tmp_x = clearFunction(tmp_x);
                            tmpCheckVal = tmp_x["u"];

                            if (typeof tmpCheckVal !== 'string') {
                                propertySum += tmpCheckVal;
                                tmpUniqValCheck += tmpCheckVal;
                            }
                        }

                        if (tmpUniqVal > tmpUniqValCheck) {
                            tmpPropertyObj["u"] = tmpUniqValCheck;
                        }
                    }

                    // Total users can't be less than new users
                    if (tmpPropertyObj.u &lt; tmpPropertyObj.n) {
                        tmpPropertyObj.u = tmpPropertyObj.n;
                    }

                    // Total users can't be more than total sessions
                    if (tmpPropertyObj.u > tmpPropertyObj.t) {
                        tmpPropertyObj.u = tmpPropertyObj.t;
                    }
                }

                tableData[tableCounter] = {};
                tableData[tableCounter] = tmpPropertyObj;
                tableCounter++;
            }
        }

        if (propertyNames.indexOf("u") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["u"];
            });
        } else if (propertyNames.indexOf("t") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["t"]
            });
        } else if (propertyNames.indexOf("c") !== -1) {
            tableData = underscore.sortBy(tableData, function (obj) {
                return -obj["c"]
            });
        }

        for (var i = 0; i &lt; tableData.length; i++) {
            if (underscore.isEmpty(tableData[i])) {
                tableData[i] = null;
            }
        }

        return underscore.compact(tableData);
    };
    
    /**
    * Format duration into highest unit of how much time have passed. Used in big numbers
    * @param {number} timestamp - amount in seconds or miliseconds passed since some reference point
    * @returns {string} formated time with how much highest units passed
    * @example
    * //outputs 2824.7 yrs
    * countlyCommon.timeString(1484654066);
    */
    countlyCommon.timeString = function(timespent){
        if(timespent.toString().length === 13)
            timespent = Math.round(timespent/1000);
        var timeSpentString = (timespent.toFixed(1)) + " min";

        if (timespent >= 142560) {
            timeSpentString = (timespent / 525600).toFixed(1) + " years";
        } else if (timespent >= 1440) {
            timeSpentString = (timespent / 1440).toFixed(1) + " days";
        } else if (timespent >= 60) {
            timeSpentString = (timespent / 60).toFixed(1) + " hours";
        }
        return timeSpentString;
    };
    
    /**
    * Get calculated totals for each property, usualy used as main dashboard data timeline data without metric segments
    * @param {object} data - countly metric model data
    * @param {array} properties - array of all properties to extract
    * @param {array} unique - array of all properties that are unique from properties array. We need to apply estimation to them
    * @param {object} totalUserOverrideObj - using unique property as key and total_users estimation property as value for all unique metrics that we want to have total user estimation overridden
    * @returns {object} dashboard data object
    * @example
    * countlyCommon.getDashboardData(countlySession.getDb(), ["t", "n", "u", "d", "e", "p", "m"], ["u", "p", "m"], {u:"users"});
    * //outputs
    * {
    *      "t":{"total":980,"prev-total":332,"change":"195.2%","trend":"u"},
    *      "n":{"total":402,"prev-total":255,"change":"57.6%","trend":"u"},
    *      "u":{"total":423,"prev-total":255,"change":"75.7%","trend":"u","isEstimate":false},
    *      "d":{"total":0,"prev-total":0,"change":"NA","trend":"u"},
    *      "e":{"total":980,"prev-total":332,"change":"195.2%","trend":"u"},
    *      "p":{"total":103,"prev-total":29,"change":"255.2%","trend":"u","isEstimate":true},
    *      "m":{"total":86,"prev-total":0,"change":"NA","trend":"u","isEstimate":true}
    * }
    */
    countlyCommon.getDashboardData = function(data, properties, unique, totalUserOverrideObj){
        function clearObject(obj){
            if (obj) {
                for(var i = 0; i &lt; properties.length; i++){
                    if (!obj[properties[i]]) obj[properties[i]] = 0;
                }
            }
            else {
                obj = {}
                for(var i = 0; i &lt; properties.length; i++){
                    obj[properties[i]] = 0;
                }
            }
    
            return obj;
        };

        var _periodObj = countlyCommon.periodObj,
            dataArr = {},
            tmp_x,
            tmp_y,
            tmpUniqObj,
            tmpPrevUniqObj,
            current = {},
            previous = {},
            currentCheck = {},
            previousCheck = {},
            sparkLines = {},
            change = {},
            isEstimate = false;

            for(var i = 0; i &lt; properties.length; i++){
                current[properties[i]] = 0;
                previous[properties[i]] = 0;
                currentCheck[properties[i]] = 0;
                previousCheck[properties[i]] = 0;
            }

        if (_periodObj.isSpecialPeriod) {
            isEstimate = true;
            for (var j = 0; j &lt; (_periodObj.currentPeriodArr.length); j++) {
                tmp_x = countlyCommon.getDescendantProp(data, _periodObj.currentPeriodArr[j]);
                tmp_x = clearObject(tmp_x);
                for(var i = 0; i &lt; properties.length; i++){
                    if(unique.indexOf(properties[i]) === -1)
                        current[properties[i]] += tmp_x[properties[i]];
                }
            }

            for (var j = 0; j &lt; (_periodObj.previousPeriodArr.length); j++) {
                tmp_y = countlyCommon.getDescendantProp(data, _periodObj.previousPeriodArr[j]);
                tmp_y = clearObject(tmp_y);
                for(var i = 0; i &lt; properties.length; i++){
                    if(unique.indexOf(properties[i]) === -1)
                        previous[properties[i]] += tmp_y[properties[i]];
                }
            }
            
            //deal with unique values separately
            for (var j = 0; j &lt; (_periodObj.uniquePeriodArr.length); j++) {
                tmp_x = countlyCommon.getDescendantProp(data, _periodObj.uniquePeriodArr[j]);
                tmp_x = clearObject(tmp_x);
                for(var i = 0; i &lt; unique.length; i++){
                    current[unique[i]] += tmp_x[unique[i]];
                }
            }

            for (var j = 0; j &lt; (_periodObj.previousUniquePeriodArr.length); j++) {
                tmp_y = countlyCommon.getDescendantProp(data, _periodObj.previousUniquePeriodArr[j]);
                tmp_y = clearObject(tmp_y);
                for(var i = 0; i &lt; unique.length; i++){
                    previous[unique[i]] += tmp_y[unique[i]];
                }
            }
            
            //recheck unique values with larger buckets
            for (var j = 0; j &lt; (_periodObj.uniquePeriodCheckArr.length); j++) {
                tmpUniqObj = countlyCommon.getDescendantProp(data, _periodObj.uniquePeriodCheckArr[j]);
                tmpUniqObj = clearObject(tmpUniqObj);
                for(var i = 0; i &lt; unique.length; i++){
                    currentCheck[unique[i]] += tmpUniqObj[unique[i]];
                }
            }
            
            for (var j = 0; j &lt; (_periodObj.previousUniquePeriodCheckArr.length); j++) {
                tmpPrevUniqObj = countlyCommon.getDescendantProp(data, _periodObj.previousUniquePeriodCheckArr[j]);
                tmpPrevUniqObj = clearObject(tmpPrevUniqObj);
                for(var i = 0; i &lt; unique.length; i++){
                    previousCheck[unique[i]] += tmpPrevUniqObj[unique[i]];
                }
            }
            
            //check if we should overwrite uniques
            for(var i = 0; i &lt; unique.length; i++){
                if (current[unique[i]] > currentCheck[unique[i]]) {
                    current[unique[i]] = currentCheck[unique[i]];
                }
                
                if (previous[unique[i]] > previousCheck[unique[i]]) {
                    previous[unique[i]] = previousCheck[unique[i]];
                }
            }
            
        } else {
            tmp_x = countlyCommon.getDescendantProp(data, _periodObj.activePeriod);
            tmp_y = countlyCommon.getDescendantProp(data, _periodObj.previousPeriod);
            tmp_x = clearObject(tmp_x);
            tmp_y = clearObject(tmp_y);

            for(var i = 0; i &lt; properties.length; i++){
                current[properties[i]] = tmp_x[properties[i]];
                previous[properties[i]] = tmp_y[properties[i]];
            }
        }
        
        //check if we can correct data using total users correction
        if (_periodObj.periodContainsToday &amp;&amp; totalUserOverrideObj) {
            for(var i = 0; i &lt; unique.length; i++){
                if(current[unique[i]] &amp;&amp; typeof totalUserOverrideObj[unique[i]] !== "undefined" &amp;&amp; totalUserOverrideObj[unique[i]]){
                    current[unique[i]] = totalUserOverrideObj[unique[i]];
                }
            }
        }
        
        // Total users can't be less than new users
        if (typeof current.u !== "undefined" &amp;&amp; typeof current.n !== "undefined" &amp;&amp; current.u &lt; current.n) {
            if(_periodObj.periodContainsToday &amp;&amp; totalUserOverrideObj &amp;&amp; typeof totalUserOverrideObj.u !== "undefined" &amp;&amp; totalUserOverrideObj.u){
                current.n = current.u;
            }
            else{
                current.u = current.n;
            }
        }

        // Total users can't be more than total sessions
        if (typeof current.u !== "undefined" &amp;&amp; typeof current.t !== "undefined" &amp;&amp; current.u > current.t) {
            current.u = current.t;
        }

        for(var i = 0; i &lt; properties.length; i++){
            change[properties[i]] = countlyCommon.getPercentChange(previous[properties[i]], current[properties[i]]);
            dataArr[properties[i]] = {
                "total":current[properties[i]],
                "prev-total":previous[properties[i]],
                "change":change[properties[i]].percent,
                "trend":change[properties[i]].trend
            };
            if(unique.indexOf(properties[i]) !== -1){
                dataArr[properties[i]].is_estimate = isEstimate;
            }
        }
        
        //check if we can correct data using total users correction
        if (_periodObj.periodContainsToday &amp;&amp; totalUserOverrideObj) {
            for(var i = 0; i &lt; unique.length; i++){
                if(dataArr[unique[i]] &amp;&amp; typeof totalUserOverrideObj[unique[i]] !== "undefined" &amp;&amp; totalUserOverrideObj[unique[i]]){
                    dataArr[unique[i]].is_estimate = false;
                }
            }
        }

        return dataArr;
    }

    /**
    * Get timestamp query range based on request data using period and app's timezone
    * @param {params} params - params object
    * @param {boolean} inSeconds - if true will output result in seconds, else in miliseconds
    * @returns {object} mongodb query object with preset ts field to be queried
    * @example
    * countlyCommon.getTimestampRangeQuery(params, true)
    * //outputs
    * {
    *      ts:{$gte:1488259482, $lte:1488279482},
    * }
    */
    countlyCommon.getTimestampRangeQuery = function(params, inSeconds){
        var periodObj = countlyCommon.periodObj;
        //create current period array if it does not exist
        if (!periodObj.currentPeriodArr || periodObj.currentPeriodArr.length == 0) {
            periodObj.currentPeriodArr = [];

            //create a period array that starts from the beginning of the current year until today
            if (params.qstring.period == "month") {
                for (var i = 0; i &lt; (now.getMonth() + 1); i++) {
                    var daysInMonth = moment().month(i).daysInMonth();

                    for (var j = 0; j &lt; daysInMonth; j++) {
                        periodObj.currentPeriodArr.push(periodObj.activePeriod + "." + (i + 1) + "." + (j + 1));

                        // If current day of current month, just break
                        if ((i == now.getMonth()) &amp;&amp; (j == (now.getDate() - 1))) {
                            break;
                        }
                    }
                }
            }
            //create a period array that starts from the beginning of the current month until today
            else if(params.qstring.period == "day") {
                for(var i = 0; i &lt; now.getDate(); i++) {
                    periodObj.currentPeriodArr.push(periodObj.activePeriod + "." + (i + 1));
                }
            }
            //create one day period array
            else{
                periodObj.currentPeriodArr.push(periodObj.activePeriod);
            }
        }
        var tmpArr;
        var ts = {};

        tmpArr = periodObj.currentPeriodArr[0].split(".");
        ts.$gte = new Date(Date.UTC(parseInt( tmpArr[0]),parseInt(tmpArr[1])-1,parseInt(tmpArr[2]) ));
        ts.$gte.setTimezone(params.appTimezone);
        if(inSeconds)
            ts.$gte = ts.$gte.getTime() / 1000 + ts.$gte.getTimezoneOffset()*60;
        else
            ts.$gte = ts.$gte.getTime() + ts.$gte.getTimezoneOffset()*60000;

        tmpArr = periodObj.currentPeriodArr[periodObj.currentPeriodArr.length - 1].split(".");
        ts.$lt = new Date(Date.UTC(parseInt( tmpArr[0]),parseInt(tmpArr[1])-1,parseInt(tmpArr[2]) ));
        ts.$lt.setDate(ts.$lt.getDate() + 1);
        ts.$lt.setTimezone(params.appTimezone);
        if(inSeconds)
            ts.$lt = ts.$lt.getTime() / 1000 + ts.$lt.getTimezoneOffset()*60;
        else
            ts.$lt = ts.$lt.getTime() + ts.$lt.getTimezoneOffset()*60000;
        return ts;
    };
    
    /**
    * Merge metric data in chartData returned by @{link countlyCommon.extractChartData} or @{link countlyCommon.extractTwoLevelData }, just in case if after data transformation of countly standard metric data model, resulting chartData contains duplicated values, as for example converting null, undefined and unknown values to unknown
    * @param {object} chartData - chartData returned by @{link countlyCommon.extractChartData} or @{link countlyCommon.extractTwoLevelData }
    * @param {string} metric - metric name to merge
    * @returns {object} chartData object with same metrics summed up
    * @example &lt;caption>Sample input&lt;/caption>
    *    {"chartData":[
    *        {"metric":"Test","t":71,"u":62,"n":36},
    *        {"metric":"Test1","t":66,"u":60,"n":30},
    *        {"metric":"Test","t":2,"u":3,"n":4}
    *    ]}
    * @example &lt;caption>Sample output&lt;/caption>
    *    {"chartData":[
    *        {"metric":"Test","t":73,"u":65,"n":40},
    *        {"metric":"Test1","t":66,"u":60,"n":30}
    *    ]}
    */
    countlyCommon.mergeMetricsByName = function(chartData, metric){
        var uniqueNames = {},
            data;
        for(var i = 0; i &lt; chartData.length; i++){
            data = chartData[i];
            if(data[metric] &amp;&amp; !uniqueNames[data[metric]]){
                uniqueNames[data[metric]] = data
            }
            else{
                for(var key in data){
                    if(typeof data[key] == "string")
                       uniqueNames[data[metric]][key] = data[key];
                    else if(typeof data[key] == "number"){
                        if(!uniqueNames[data[metric]][key])
                            uniqueNames[data[metric]][key] = 0;
                        uniqueNames[data[metric]][key] += data[key];
                    }
                }
            }
        }

        return underscore.values(uniqueNames);
    };
    
    /**
    * Joined 2 arrays into one removing all duplicated values
    * @param {array} x - first array
    * @param {array} y - second array
    * @returns {array} new array with only unique values from x and y
    * @example
    * //outputs [1,2,3]
    * countlyCommon.union([1,2],[2,3]);
    */
    countlyCommon.union = function(x, y) {
        if (!x) {
            return y;
        } else if (!y) {
            return x;
        }

        var obj = {};
        for (var i = x.length-1; i >= 0; -- i) {
            obj[x[i]] = true;
        }

        for (var i = y.length-1; i >= 0; -- i) {
            obj[y[i]] = true;
        }

        var res = [];

        for (var k in obj) {
            res.push(k);
        }

        return res;
    };
    
    /**
    * Encode value to be passed to db as key, encoding $ symbol to &amp;#36; if it is first and all . (dot) symbols to &amp;#46; in the string
    * @param {string} str - value to encode
    * @returns {string} encoded string
    */
    countlyCommon.encode = function(str){
        return str.replace(/^\$/g, "&amp;#36;").replace(/\./g, '&amp;#46;');
    };
    
    /**
    * Decode value from db, decoding first &amp;#36; to $ and all &amp;#46; to . (dots). Decodes also url encoded values as &amp;amp;#36;.
    * @param {string} str - value to decode
    * @returns {string} decoded string
    */
    countlyCommon.decode = function(str){
        return str.replace(/^&amp;#36;/g, "$").replace(/^&amp;amp;#36;/g, '$').replace(/&amp;#46;/g, '.').replace(/&amp;amp;#46;/g, '.');
    };

    /**
    * Decode escaped HTML from db
    * @param {string} str - value to decode
    * @returns {string} decoded string
    */
    countlyCommon.decodeHtml = function(html) {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
    };
    
    /**
    * Get period object in atomic way from params, 
    * getting params.qstring.period for period
    * and params.appTimezone for timezone
    * @param {params} params - parans object with app timezone and period
    * @returns {module:api/lib/countly.common.periodObj} period object
    */
    countlyCommon.getPeriodObj = function(params) {
		params.qstring.period = params.qstring.period || "month";
        if (params.qstring.period &amp;&amp; params.qstring.period.indexOf(",") !== -1) {
            try {
                params.qstring.period = JSON.parse(params.qstring.period);
            } catch (SyntaxError) {
				console.log('Parse period JSON failed');
                return false;
            }
        }

        countlyCommon.setPeriod(params.qstring.period);
        countlyCommon.setTimezone(params.appTimezone || (params.app &amp;&amp; params.app.timezone));

        return countlyCommon.periodObj;
    }

    // Private Methods

    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    // Returns a period object used by all time related data calculation functions.
    function getPeriodObj() {
        var year = _currMoment.year(),
            month = _currMoment.month() + 1,
            day = _currMoment.date(),
            hour = _currMoment.hours(),
            endTimestamp = moment(_currMoment).utc().hours(23).minutes(59).seconds(59).unix(),
            startTimestamp = moment(_currMoment).utc().hours(0).minutes(0).seconds(0).unix(),
            activePeriod = "NA",
            previousPeriod = "NA",
            periodMax = "NA",
            periodMin = "NA",
            isSpecialPeriod = false,
            daysInPeriod = 0,
            rangeEndDay = null,
            dateString  = "NA",
            currWeeksArr = [],
            currWeekCounts = {},
            currMonthsArr = [],
            currMonthCounts = {},
            currPeriodArr = [],
            prevWeeksArr = [],
            prevWeekCounts = {},
            prevMonthsArr = [],
            prevMonthCounts = {},
            prevPeriodArr = [],
            periodContainsToday = true;

        switch (_period) {
            case "month": {
                activePeriod = year;
                previousPeriod = year - 1;
                periodMax = 12;
                periodMin = 1;
                dateString = "MMM";
                daysInPeriod = parseInt(_currMoment.format("DDD"),10);
                startTimestamp = moment(_currMoment).utc().month(1).date(1).hours(0).minutes(0).seconds(0).unix();

                _currMoment.subtract(daysInPeriod, 'days');
                for (var i = 0; i &lt; daysInPeriod; i++) {
                    _currMoment.add(1, 'days');
                    currPeriodArr.push(_currMoment.format("YYYY.M.D"));
                }

                _currMoment.subtract(daysInPeriod + 365, 'days');
                for (var i = 0; i &lt; daysInPeriod; i++) {
                    prevPeriodArr.push(_currMoment.format("YYYY.M.D"));
                    _currMoment.add(1, 'days');
                }
                _currMoment.add(365, 'days');

                break;
            }
            case "day": {
                activePeriod = _currMoment.format("YYYY.M");
                startTimestamp = moment(_currMoment).utc().date(1).hours(0).minutes(0).seconds(0).unix();
                _currMoment.subtract(day, 'days');
                previousPeriod = _currMoment.format("YYYY.M");
                _currMoment.add(day, 'days');

                periodMax = new Date(year, month, 0).getDate();
                periodMin = 1;
                dateString = "D MMM";
                daysInPeriod = day;

                for (var i = periodMin; i &lt;= periodMax; i++) {
                    currPeriodArr.push(activePeriod + "." + i);
                }

                _currMoment.subtract(day + 1, 'days');
                var daysInMonth = _currMoment.daysInMonth();
                _currMoment.subtract(daysInMonth - 1, 'days');
                for (var i = 0; i &lt; day; i++) {
                    _currMoment.add(1, 'days');
                    prevPeriodArr.push(_currMoment.format("YYYY.M.D"));
                }
                _currMoment.add(daysInMonth, 'days');

                break;
            }
            case "hour": {
                activePeriod = _currMoment.format("YYYY.M.D");
                _currMoment.subtract(1, 'days');
                previousPeriod = _currMoment.format("YYYY.M.D");
                _currMoment.add(1, 'days');

                periodMax = 23;
                periodMin = 0;
                dateString = "HH:mm";
                daysInPeriod = 1;

                currPeriodArr.push(activePeriod);
                prevPeriodArr.push(previousPeriod);
                break;
            }
            case "yesterday": {
                _currMoment.subtract(1, 'days');
                endTimestamp = moment(_currMoment).utc().hours(23).minutes(59).seconds(59).unix();
                startTimestamp = moment(_currMoment).utc().hours(0).minutes(0).seconds(0).unix();
                activePeriod = _currMoment.format("YYYY.M.D");
                _currMoment.add(1, 'days');
                _currMoment.subtract(2, 'days');
                previousPeriod = _currMoment.format("YYYY.M.D");
                _currMoment.add(2, 'days');

                periodMax = 23;
                periodMin = 0;
                dateString = "D MMM, HH:mm";
                daysInPeriod = 1;

                currPeriodArr.push(activePeriod);
                prevPeriodArr.push(previousPeriod);
                periodContainsToday = false;
                break;
            }
            default: {
                if(/([0-9]+)days/.test(_period)){
                    var match = /([0-9]+)days/.exec(_period);
                    if(match[1]){
                        daysInPeriod = parseInt(match[1]);
                        isSpecialPeriod = true;
                    }
                }
                break;
            }
        }
        
        if(isSpecialPeriod){
            _currMoment.subtract(daysInPeriod-1, 'days');
            startTimestamp = moment(_currMoment).utc().hours(0).minutes(0).seconds(0).unix();
            _currMoment.add(daysInPeriod-1, 'days');
        }

        // Check whether period object is array
        if (Object.prototype.toString.call(_period) === '[object Array]' &amp;&amp; _period.length == 2) {
            var fromDate = new Date(_period[0]),
                toDate = new Date(_period[1]);

            startTimestamp = moment(fromDate).utc().hours(0).minutes(0).seconds(0).unix();
            endTimestamp = moment(toDate).utc().hours(23).minutes(59).seconds(59).unix();
            fromDate.setTimezone(_appTimezone);
            toDate.setTimezone(_appTimezone);

            // One day is selected from the datepicker
            if (_period[0] == _period[1]) {
                var selectedDate = moment(fromDate);
                selectedDate.tz(_appTimezone);

                activePeriod = selectedDate.format("YYYY.M.D");
                selectedDate.subtract(1, 'days');
                previousPeriod = selectedDate.format("YYYY.M.D");
                selectedDate.add(1, 'days');

                periodMax = 23;
                periodMin = 0;
                dateString = "D MMM, HH:mm";
                currPeriodArr.push(activePeriod);
                prevPeriodArr.push(previousPeriod);
                periodContainsToday = (moment(_period[0]).utc().format("YYYYMMDD") == _currMoment.utc().format("YYYYMMDD"));
            } else {
                var a = moment(fromDate),
                    b = moment(toDate);
                a.tz(_appTimezone);
                b.tz(_appTimezone);

                daysInPeriod = b.diff(a, 'days') + 1;
                isSpecialPeriod = true;
                rangeEndDay = _period[1];
                periodContainsToday = (b.utc().format("YYYYMMDD") == _currMoment.utc().format("YYYYMMDD"));
            }
        }

        if (isSpecialPeriod) {
            var yearChanged = false,
                currentYear = 0;

            for (var i = (daysInPeriod - 1); i > -1; i--) {

                var currTime = new Date();
                currTime.setTimezone(_appTimezone);

                var currTime2 = new Date();
                currTime2.setTimezone(_appTimezone);

                var momentOne = moment(currTime),
                    momentTwo = moment(currTime2);
                momentOne.tz(_appTimezone);
                momentTwo.tz(_appTimezone);

                var currRangeEndDate = new Date(rangeEndDay);
                currRangeEndDate.setTimezone(_appTimezone);

                var prevRangeEndDate = new Date(rangeEndDay);
                prevRangeEndDate.setTimezone(_appTimezone);

                var currIndex = (!rangeEndDay) ? momentOne.subtract(i, 'days') : moment(currRangeEndDate).tz(_appTimezone).subtract(i, 'days'),
                    currIndexYear = currIndex.year(),
                    prevIndex = (!rangeEndDay) ? momentTwo.subtract((daysInPeriod + i), 'days') : moment(prevRangeEndDate).tz(_appTimezone).subtract((daysInPeriod + i), 'days'),
                    prevYear = prevIndex.year();

                if (i != (daysInPeriod - 1) &amp;&amp; currentYear != currIndexYear) {
                    yearChanged = true;
                }
                currentYear = currIndexYear;

                // Current period variables

                var currWeek = currentYear + "." + "w" + Math.ceil(currIndex.format("DDD") / 7);
                currWeeksArr[currWeeksArr.length] = currWeek;
                currWeekCounts[currWeek] = (currWeekCounts[currWeek]) ? (currWeekCounts[currWeek] + 1) : 1;

                var currMonth = currIndex.format("YYYY.M");
                currMonthsArr[currMonthsArr.length] = currMonth;
                currMonthCounts[currMonth] = (currMonthCounts[currMonth]) ? (currMonthCounts[currMonth] + 1) : 1;

                currPeriodArr[currPeriodArr.length] = currIndex.format("YYYY.M.D");

                // Previous period variables

                var prevWeek = prevYear + "." + "w" + Math.ceil(prevIndex.format("DDD") / 7);
                prevWeeksArr[prevWeeksArr.length] = prevWeek;
                prevWeekCounts[prevWeek] = (prevWeekCounts[prevWeek]) ? (prevWeekCounts[prevWeek] + 1) : 1;

                var prevMonth = prevIndex.format("YYYY.M");
                prevMonthsArr[prevMonthsArr.length] = prevMonth;
                prevMonthCounts[prevMonth] = (prevMonthCounts[prevMonth]) ? (prevMonthCounts[prevMonth] + 1) : 1;

                prevPeriodArr[prevPeriodArr.length] = prevIndex.format("YYYY.M.D");
            }

            dateString = (yearChanged) ? "D MMM, YYYY" : "D MMM";
        }

        var requiredDbDateIds = [],
            requiredZeroDbDateIds = [],
            dateIdSplits;

        for (var i = 0; i &lt; prevPeriodArr.length; i++) {
            dateIdSplits = prevPeriodArr[i].split(".");
            arrayAddUniq(requiredZeroDbDateIds, dateIdSplits[0] + ":0");
            arrayAddUniq(requiredDbDateIds, dateIdSplits[0] + ":" + dateIdSplits[1]);
        }

        for (var i = 0; i &lt; currPeriodArr.length; i++) {
            dateIdSplits = currPeriodArr[i].split(".");
            arrayAddUniq(requiredZeroDbDateIds, dateIdSplits[0] + ":0");
            arrayAddUniq(requiredDbDateIds, dateIdSplits[0] + ":" + dateIdSplits[1]);
        }

        return {
            "start":startTimestamp*1000,
            "end":endTimestamp*1000,
            "activePeriod":activePeriod,
            "periodMax":periodMax,
            "periodMin":periodMin,
            "previousPeriod":previousPeriod,
            "currentPeriodArr":currPeriodArr,
            "previousPeriodArr":prevPeriodArr,
            "uniquePeriodArr":getUniqArray(currWeeksArr, currWeekCounts, currMonthsArr, currMonthCounts, currPeriodArr),
            "uniquePeriodCheckArr":getUniqCheckArray(currWeeksArr, currWeekCounts, currMonthsArr, currMonthCounts),
            "previousUniquePeriodArr":getUniqArray(prevWeeksArr, prevWeekCounts, prevMonthsArr, prevMonthCounts, prevPeriodArr),
            "previousUniquePeriodCheckArr":getUniqCheckArray(prevWeeksArr, prevWeekCounts, prevMonthsArr, prevMonthCounts),
            "dateString":dateString,
            "daysInPeriod":daysInPeriod,
            "isSpecialPeriod":isSpecialPeriod,
            "reqMonthDbDateIds":requiredDbDateIds,
            "reqZeroDbDateIds":requiredZeroDbDateIds,
            "periodContainsToday": periodContainsToday
        };
    }

    function getUniqArray(weeksArray, weekCounts, monthsArray, monthCounts, periodArr) {
        if (_period == "month" || _period == "day" || _period == "hour" || _period == "yesterday") {
            return [];
        }

        if (Object.prototype.toString.call(_period) === '[object Array]' &amp;&amp; _period.length == 2) {
            if (_period[0] == _period[1]) {
                return [];
            }
        }

        var weeksArray = clone(weeksArray),
            weekCounts = clone(weekCounts),
            monthsArray = clone(monthsArray),
            monthCounts = clone(monthCounts),
            periodArr = clone(periodArr);

        var uniquePeriods = [],
            tmpDaysInMonth = -1,
            tmpPrevKey = -1,
            rejectedWeeks = [],
            rejectedWeekDayCounts = {};

        for (var key in weekCounts) {

            // If this is the current week we can use it
            if (key === _currMoment.format("YYYY.\\w w").replace(" ", "")) {
                continue;
            }

            if (weekCounts[key] &lt; 7) {
                for (var i = 0; i &lt; weeksArray.length; i++) {
                    weeksArray[i] = weeksArray[i].replace(key, 0);
                }
            }
        }

        for (var key in monthCounts) {
            if (tmpPrevKey != key) {
                if (_currMoment.format("YYYY.M") === key) {
                    tmpDaysInMonth = _currMoment.format("D");
                } else {
                    tmpDaysInMonth = moment(key, "YYYY.M").daysInMonth();
                }

                tmpPrevKey = key;
            }

            if (monthCounts[key] &lt; tmpDaysInMonth) {
                for (var i = 0; i &lt; monthsArray.length; i++) {
                    monthsArray[i] = monthsArray[i].replace(key, 0);
                }
            }
        }

        for (var i = 0; i &lt; monthsArray.length; i++) {
            if (monthsArray[i] == 0) {
                if (weeksArray[i] == 0 || (rejectedWeeks.indexOf(weeksArray[i]) != -1)) {
                    uniquePeriods[i] = periodArr[i];
                } else {
                    uniquePeriods[i] = weeksArray[i];
                }
            } else {
                rejectedWeeks[rejectedWeeks.length] = weeksArray[i];
                uniquePeriods[i] = monthsArray[i];

                if (rejectedWeekDayCounts[weeksArray[i]]) {
                    rejectedWeekDayCounts[weeksArray[i]].count++;
                } else {
                    rejectedWeekDayCounts[weeksArray[i]] = {
                        count:1,
                        index:i
                    };
                }
            }
        }

        var totalWeekCounts = underscore.countBy(weeksArray, function (per) {
            return per;
        });

        for (var weekDayCount in rejectedWeekDayCounts) {

            // If the whole week is rejected continue
            if (rejectedWeekDayCounts[weekDayCount].count == 7) {
                continue;
            }

            // If its the current week continue
            if (_currMoment.format("YYYY.\\w w").replace(" ", "") == weekDayCount &amp;&amp; totalWeekCounts[weekDayCount] == rejectedWeekDayCounts[weekDayCount].count) {
                continue;
            }

            // If only some part of the week is rejected we should add back daily buckets

            var startIndex = rejectedWeekDayCounts[weekDayCount].index - (totalWeekCounts[weekDayCount] - rejectedWeekDayCounts[weekDayCount].count),
                limit = startIndex + (totalWeekCounts[weekDayCount] - rejectedWeekDayCounts[weekDayCount].count);

            for (var i = startIndex; i &lt; limit; i++) {
                // If there isn't already a monthly bucket for that day
                if (monthsArray[i] == 0) {
                    uniquePeriods[i] = periodArr[i];
                }
            }
        }

        rejectedWeeks = underscore.uniq(rejectedWeeks);
        uniquePeriods = underscore.uniq(underscore.difference(uniquePeriods, rejectedWeeks));

        return uniquePeriods;
    }

    function getUniqCheckArray(weeksArray, weekCounts, monthsArray, monthCounts) {

        if (_period == "month" || _period == "day" || _period == "hour" || _period == "yesterday") {
            return [];
        }

        if (Object.prototype.toString.call(_period) === '[object Array]' &amp;&amp; _period.length == 2) {
            if (_period[0] == _period[1]) {
                return [];
            }
        }

        var weeksArray = clone(weeksArray),
            weekCounts = clone(weekCounts),
            monthsArray = clone(monthsArray),
            monthCounts = clone(monthCounts);

        var uniquePeriods = [],
            tmpDaysInMonth = -1,
            tmpPrevKey = -1;

        for (var key in weekCounts) {
            if (key === _currMoment.format("YYYY.\\w w").replace(" ", "")) {
                continue;
            }

            if (weekCounts[key] &lt; 1) {
                for (var i = 0; i &lt; weeksArray.length; i++) {
                    weeksArray[i] = weeksArray[i].replace(key, 0);
                }
            }
        }

        for (var key in monthCounts) {
            if (tmpPrevKey != key) {
                if (_currMoment.format("YYYY.M") === key) {
                    tmpDaysInMonth = _currMoment.format("D");
                } else {
                    tmpDaysInMonth = moment(key, "YYYY.M").daysInMonth();
                }

                tmpPrevKey = key;
            }

            if (monthCounts[key] &lt; (tmpDaysInMonth * 0.5)) {
                for (var i = 0; i &lt; monthsArray.length; i++) {
                    monthsArray[i] = monthsArray[i].replace(key, 0);
                }
            }
        }

        for (var i = 0; i &lt; monthsArray.length; i++) {
            if (monthsArray[i] == 0) {
                if (weeksArray[i] == 0) {

                } else {
                    uniquePeriods[i] = weeksArray[i];
                }
            } else {
                uniquePeriods[i] = monthsArray[i];
            }
        }

        uniquePeriods = underscore.uniq(uniquePeriods);

        return uniquePeriods;
    }

    function clone(obj) {
        if (null == obj || "object" != typeof obj) return obj;

        if (obj instanceof Date) {
            var copy = new Date();
            copy.setTime(obj.getTime());
            return copy;
        }

        if (obj instanceof Array) {
            var copy = [];
            for (var i = 0, len = obj.length; i &lt; len; ++i) {
                copy[i] = clone(obj[i]);
            }
            return copy;
        }

        if (obj instanceof Object) {
            var copy = {};
            for (var attr in obj) {
                if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
            }
            return copy;
        }
    }

    function arrayAddUniq(arr, item) {
        if (!arr) {
            arr = [];
        }

        if (toString.call(item) === "[object Array]") {
            for (var i = 0; i &lt; item.length; i++) {
                if (arr.indexOf(item[i]) === -1) {
                    arr[arr.length] = item[i];
                }
            }
        } else {
            if (arr.indexOf(item) === -1) {
                arr[arr.length] = item;
            }
        }
    }

}(countlyCommon));

module.exports = countlyCommon;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Aug 20 2018 12:24:26 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
