# Dockerfile-kafka-connect-clickhouse
# Pinned to Strimzi 0.47.0 + Apache Kafka 4.0.0
FROM gcr.io/countly-dev-313620/strimzi/kafka:0.47.0-kafka-4.0.0

USER root:root

ARG CH_SINK_VERSION=1.3.2
ARG PLUGINS_DIR=/opt/kafka/plugins

# Install only unzip (curl-minimal is already present), then add ClickHouse Kafka Connect Sink
RUN microdnf -y install unzip && microdnf clean all && \
    mkdir -p ${PLUGINS_DIR}/clickhouse && \
    curl -fSL \
      https://github.com/ClickHouse/clickhouse-kafka-connect/releases/download/v${CH_SINK_VERSION}/clickhouse-kafka-connect-v${CH_SINK_VERSION}.zip \
      -o /tmp/ch-sink.zip && \
    unzip -q /tmp/ch-sink.zip -d ${PLUGINS_DIR}/clickhouse && \
    rm -f /tmp/ch-sink.zip

# Show what got installed (optional)
RUN ls -l ${PLUGINS_DIR}/clickhouse

# Strimzi images expect to run as 1001
USER 1001