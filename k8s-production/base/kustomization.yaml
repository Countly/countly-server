apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: countly

resources:
# Custom headers for ingress
- custom-headers-configmap.yaml
# Countly resources
- namespace-and-secrets.yaml
- docker-registry-secret.yaml
- nginx-ingress-config.yaml
- countly-api.yaml
- countly-frontend.yaml
- countly-ingestor.yaml
- countly-aggregator.yaml
- countly-jobserver.yaml
- countly-clickhouse-writer.yaml
- countly-clickhouse-updater.yaml
- countly-ingress.yaml

labels:
- includeSelectors: true
  pairs:
    branch: newarchitecture

# Dynamic image replacement handled by workflow
images:
  - name: countly-unified
    newName: gcr.io/countly-01/countly-unified
    digest: sha256:444704d699af9179c1e4f0f53b37fab92cdba1e6ad3a725dd4b52fca677e86dc

# Generator options  
generatorOptions:
  labels:
    app: countly
    managed-by: kustomize

configMapGenerator:
- envs:
  - configs/common.env
  name: countly-config
- envs:
  - configs/api.env
  name: countly-api-config
- envs:
  - configs/frontend.env
  name: countly-frontend-config
- envs:
  - configs/ingestor.env
  name: countly-ingestor-config
- envs:
  - configs/aggregator.env
  name: countly-aggregator-config
- envs:
  - configs/jobserver.env
  name: countly-jobserver-config
- envs:
  - configs/clickhouse-writer.env
  name: countly-clickhouse-writer-config
- envs:
  - configs/clickhouse-updater.env
  name: countly-clickhouse-updater-config
- envs:
  - configs/mongodb.env
  name: countly-mongodb-config
- envs:
  - configs/clickhouse.env
  name: countly-clickhouse-config

# Secrets with fixed names (no suffixes) so they persist across deployments
# ConfigMaps keep suffixes for automatic deployment restarts
# NOTE: Uncomment the secretGenerator section on the first run.
#       after the first run, they will not auto update deployments because disableNameSuffixHash is set to true.
#       this is by design to manage sensitive secrets manually/other strategy and not in plain text.
#       Refer to README.md for more details on secret management.
#secretGenerator:
#- name: common-config
#  envs:
#  - secrets/common.env
#  options:
#    disableNameSuffixHash: true
#- name: mongodb-config
#  envs:
#  - secrets/mongodb.env
#  options:
#    disableNameSuffixHash: true
#- name: clickhouse-config
#  envs:
#  - secrets/clickhouse.env
#  options:
#    disableNameSuffixHash: true
#- name: docker-pull-secret
#  type: kubernetes.io/dockerconfigjson
#  envs:
#  - secrets/docker-registry.env
#  options:
#    disableNameSuffixHash: true