<script type="text/x-template" id="reports-home">
<div id="reports-view" v-bind:class="[componentId]">
    <cly-header>
        <template v-slot:header-left>
            <h2> {{i18n('reports.title')}}
            </h2><span class="cly-vue-tooltip-icon ion-help-circled color-cool-gray-50" style="margin-left:10px;" v-tooltip.top-center="i18n('reports.tips')"/>
        </template>
        <template v-slot:header-right>
            <el-button type="success" icon="el-icon-circle-plus" v-on:click="createReport()">{{i18n('reports.create')}}</el-button>
        </template>
    </cly-header>

    <cly-main>
        <table-view v-on:open-drawer="openDrawer"></table-view>
    </cly-main>
    <drawer @close="closeDrawer" :controls="drawers.home"></drawer>
</div>
</script>


<script  type="text/x-template" id="reports-table">
<cly-section>
    <cly-datatable-n
        :available-dynamic-cols="tableDynamicCols" 
        class="cly-vue-reports-table"
        :tracked-fields="localTableTrackedFields"
        :rows="tableRows" :resizable="false" >
       
        <template v-slot="scope">
            <el-table-column fixed="left" width="100" label="">
                <template v-slot="rowScope">
                    <el-switch :value="rowScope.row.enabled"
                        @input="scope.patch(rowScope.row, {enabled: !rowScope.row.enabled})">
                    </el-switch>
                </template>
            </el-table-column>
           
            <el-table-column fixed :label="i18n('report.report-title')"  min-width="200" sortable="true">
                <template slot-scope="scope">
                    <div v-html="scope.row.title"></div>
                </template>
            </el-table-column> 

            <el-table-column min-width="230" :label="(i18n('reports.emails'))" sortable="true">
            <template slot-scope="scope" sortable="true">
                <div class="email-column" v-html="scope.row.emails.join(' ')"></div>
            </template>
                
            </el-table-column>

            <el-table-column  min-width="230" sortable="true"  prop="dataColumn" :label="i18n('reports.metrics')">
                
            </el-table-column>

            <el-table-column  min-width="140" sortable="true" :label="i18n('reports.frequency')">
                <template slot-scope="scope" sortable="true">
                    <span>{{i18n("reports." + scope.row.frequency)}}</span>
                </template>
            </el-table-column>
<!-- 
            <el-table-column sortable="true" align="center" prop="timeColumn"  :label="i18n('reports.time')">
    
            </el-table-column> -->

            <el-table-column  min-width="450" :label="i18n('reports.time')" sortable="true">
                <template slot-scope="scope">
                    <div class="bu-is-flex">
                        <div class="bu-is-flex-grow-1">
                            <div class="is-created-by-col">
                                {{scope.row.timeColumn}}
                             </div>

                        </div> 
                      <div class="is-option-button">
                         <cly-more-options size="small" @command="handleReportEditCommand($event, scope)">
                            <el-dropdown-item  icon="el-icon-document-copy" command="edit-comment">
                                Edit
                            </el-dropdown-item>
                            <el-dropdown-item  icon="el-icon-position" command="send-comment">
                                Send Now
                            </el-dropdown-item>
                            <el-dropdown-item  icon="el-icon-chat-dot-square" command="preview-comment">
                                Preview
                            </el-dropdown-item>
                            <el-dropdown-item icon="el-icon-delete" command="delete-comment">
                                Delete
                            </el-dropdown-item>
                        </cly-more-options>
                      </div>
                    </div>
                </template>
            </el-table-column>
        </template>
        <template v-slot:bottomline="scope">
            <cly-diff-helper :diff="scope.diff" @discard="scope.unpatch()" @save="updateStatus(scope)">
            </cly-diff-helper>
        </template>
    </cly-datatable-n>
</cly-section>
</script>



<script  type="text/x-template" id="reports-drawer">
<cly-drawer
    class="cly-vue-report-drawer"
    @submit="onSubmit"
    @close="onClose"
    @copy="onCopy"
    :title="title"
    :saveButtonLabel="saveButtonLabel"
    v-bind="$props.controls">
    <template v-slot:default="drawerScope">
        <cly-form-step id="reports-drawer-main">
        <div class="bu-py-4">
            <div class="text-small bu-pb-1 title text-heading">
                {{i18n('reports.report_name')}}
            </div>
            <validation-provider name="title" rules="required" v-slot="v">
                <el-input
                    v-model="drawerScope.editedObject.title"
                    :class="{'is-error': v.errors.length > 0}"
                    :placeholder="i18n('reports.report-name')">
                </el-input>
            </validation-provider>
        </div>
        <div class="bu-py-4">
            <div class="text-small bu-pb-1 title text-heading">
               {{i18n('reports.email-to-receive')}} 
            </div>
                <validation-provider name="emails" rules="required" v-slot="v">
                    <el-select
                        :class="{'bu-is-flex': true}"
                        v-model="drawerScope.editedObject.emails"
                        multiple
                        filterable
                        remote
                        default-first-option
                        no-data-text="Please input full email address"
                        :remote-method="emailInputFilter"
                        :placeholder="i18n('reports.email-placeholder')">
                        <el-option
                            v-for="item in emailOptions"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value">
                        </el-option>
                    </el-select>
                </validation-provider>
            </div>
        </div> 

        <div class="bu-py-4 report-type-block">
            <div class="cly-vue-drawer-step__line cly-vue-drawer-step__line--aligned">
                <div class="text-big text-heading bu-mb-3">
                    {{i18n('reports.report-type')}} <span class="ion-help-circled color-cool-gray-50" v-tooltip.top-center="i18n('reports.type-tips')"/>
                </div>
            </div>
            <div class="cly-vue-drawer-step__line cly-vue-drawer-step__line--aligned">
                <el-radio
                    v-on:change="reportTypeChange" 
                    class="is-autosized "
                    v-model="drawerScope.editedObject.report_type"
                    :label="item.value"
                    :key="idx"
                    v-for="(item, idx) in reportTypeOptions"
                    border
                    >
                    {{item.label}}
                    <div class="text-small">
                        {{item.description}}
                    </div>
                </el-radio>
            </div>
        </div>

        <div class="bu-py-4" v-if="showApps">
            <div class="text-small bu-pb-1 title text-heading">
                {{i18n('reports.select-apps')}} 
            </div>
            <validation-provider name="apps" rules="required" v-slot="v">
                <cly-select-x
                   :placeholder="i18n('reports.Select_apps')"
                   mode="multi-check"
                   v-on:change="appsChange"
                   v-model="drawerScope.editedObject.apps"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="appsSelectorOption">
                </cly-select-x>
            </validation-provider>
        </div>


        <div class="bu-py-4"  v-if="showMetrics">
            <div class="text-small bu-pb-1 title text-heading">
                {{i18n('reports.include-metrics')}} 
            </div>
            <validation-provider name="metrics" rules="required" v-slot="v">
                <cly-select-x
                   :placeholder="i18n('reports.Select_metrics')"
                   mode="multi-check"
                   v-model="drawerScope.editedObject.metricsArray"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="metricOptions">
                </cly-select-x>
            </validation-provider>
        </div>

        <div class="bu-py-4"  v-if="showDashboards">
            <div class="text-small bu-pb-2 title text-heading">
                {{i18n('dashboards.select_dashboards')}} 
            </div>
            <validation-provider name="select_dashboards" rules="required" v-slot="v">
                <cly-select-x
                   :placeholder="i18n('dashboards.select')"
                   mode="single-list"
                   v-model="drawerScope.editedObject.dashboards"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="dashboardsOptions">
                </cly-select-x>
            </validation-provider>
        </div>


        <div class="bu-py-4" v-if="drawerScope.editedObject.metricsArray && drawerScope.editedObject.metricsArray.indexOf('events') > -1">
            <div class="text-small bu-pb-1 title text-heading">
                {{i18n('reports.select-events')}} 
            </div>
            <validation-provider name="events" rules="required" v-slot="v">
                <cly-select-x
                   mode="multi-check"
                   v-model="drawerScope.editedObject.selectedEvents"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="eventOptions">
                </cly-select-x>
            </validation-provider>
        </div>


        <div class="bu-py-4 frequency-block">
            <div class="text-big bu-pb-1 title bu-has-text-weight-medium ">
                {{i18n('reports.frequency')}}
            </div>
            <div class="cly-vue-report-drawer__report_description bu-mb-4 text-small  colors-cool-gray-50">
                {{i18n('reports.frequency-desc')}}
            </div>
            <el-radio
                v-on:change="reportFrequencyChange" 
                class="is-autosized"
                v-model="drawerScope.editedObject.frequency"
                :label="item.value"
                :key="idx"
                v-for="(item, idx) in frequencyOptions"
            border>
                {{item.label}}
                <div class="text-small">
                    {{item.description}}
                </div>
            </el-radio>
        </div>

        <div class="bu-py-4"  v-if="showDashboards">
            <div class="text-medium bu-pb-1 bu-has-text-weight-medium">
                {{i18n('dashboards.select-report-date-range')}} 
            </div>
            <validation-provider name="select-date-range" rules="required" v-slot="v">
                <cly-select-x
                   :placeholder="i18n('dashboards.select-date-range')"
                   mode="single-list"
                   v-model="drawerScope.editedObject.date_range"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="reportDateRangesOptions">
                </cly-select-x>
            </validation-provider>
        </div>

        <div class="bu-py-4" v-if="drawerScope.editedObject.frequency === 'weekly'">
            <div class="text-medium bu-pb-1 bu-has-text-weight-medium">
                {{i18n('reports.dow')}}
            </div>
            <!-- <div class="cly-vue-report-drawer__report_description bu-mb-2 text-small  colors-cool-gray-50">
                Some frequency related description can be placed here
            </div> -->
            <validation-provider name="metrics" rules="required" v-slot="v">
                <cly-select-x
                   mode="single-list"
                   v-model="drawerScope.editedObject.day"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="dayOfWeekOptions">
                </cly-select-x>
            </validation-provider>
        </div>


        <div class="bu-py-4">
            <div class="text-medium bu-pb-1 bu-has-text-weight-medium">
                {{i18n('reports.select-time')}}
            </div>
            <div class="cly-vue-report-drawer__report_description bu-mb-2 text-small  color-cool-gray-50">
                {{i18n('reports.time-desc')}}
            </div>
            <validation-provider name="metrics" rules="required" v-slot="v">
                <cly-select-x
                   mode="single-list"
                   v-model="drawerScope.editedObject.hour"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="timeListOptions">
                </cly-select-x>
            </validation-provider>
        </div>


        <div class="bu-py-4">
            <div class="text-medium bu-pb-1  bu-has-text-weight-medium">
                {{i18n('reports.timezone')}}
            </div>
            <div class="cly-vue-report-drawer__report_description bu-mb-2 text-small  colors-cool-gray-50">
                {{i18n('reports.timezone-desc')}}
            </div>
            <validation-provider name="metrics" rules="required" v-slot="v">
                <cly-select-x
                   mode="single-list"
                   v-model="drawerScope.editedObject.timezone"
                   :class="{'is-error': v.errors.length > 0, 'bu-is-flex':true}"
                   :options="timezoneOptions">
                </cly-select-x>
            </validation-provider>
        </div>
            <pre v-if="0">
                {{drawerScope.editedObject}}
            </pre>

        </cly-form-step>
    </template>
</cly-drawer>



</script>