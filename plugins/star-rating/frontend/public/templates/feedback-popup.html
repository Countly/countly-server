<!DOCTYPE html>
<html>
<head>
	<title>Countly Feedback Popup</title>
	<link rel="stylesheet" href="./star-rating/stylesheets/countly-feedback.css"/>
  <link rel="stylesheet" href="stylesheets/font-awesome/css/font-awesome.min.css"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<div class="modal-content">
  <div class="emotions-area">
    <p id="question-area">What is your opinion <br>of this page?</p>
    <span class="emotion-first">
      <img class="grow rating-emotion" title="Very dissatisfied" data-score="1" src="/star-rating/images/star-rating/0_gray.svg">
    </span>
    <span class="emotion">
      <img title="Somewhat dissatisfied" class="grow rating-emotion" data-score="2" src="/star-rating/images/star-rating/1_gray.svg">
    </span>
    <span class="emotion">
      <img title="Neither satisfied nor dissatisfied" class="grow rating-emotion" data-score="3" src="/star-rating/images/star-rating/2_gray.svg">
    </span>
    <span class="emotion">
      <img title="Somewhat satisfied" class="grow rating-emotion" data-score="4" src="/star-rating/images/star-rating/3_gray.svg">
    </span>
    <span class="emotion">
      <img title="Very satisfied" class="grow rating-emotion" data-score="5" src="/star-rating/images/star-rating/4_gray.svg">
    </span> 
  </div>
  <div class="comment-area">
    <div class="input-wrapper"> 
      <label class="countly-feedback-checkbox-container"> 
        <input id="countly-feedback-show-comment" data-state="0" type="checkbox"> 
        <span class="countly-feedback-show-comment-checkbox fa fa-square-o countly-feedback-check-green"></span> 
        <span class="countly-feedback-checkbox-title" id="cf-comment-text">Add comment</span> 
      </label> 
      <textarea id="countly-feedback-comment-textarea"></textarea>
    </div>
    <div class="input-wrapper">
      <label class="countly-feedback-checkbox-container"> 
        <input id="countly-feedback-show-email" data-state="0" type="checkbox"> 
        <span class="countly-feedback-show-email-checkbox fa fa-square-o countly-feedback-check-green"></span> 
        <span class="countly-feedback-checkbox-title" id="cf-email-text">Contact me by email</span>
      </label> 
      <input type="text" id="contact-me-email">
    </div>
  </div>
  <div class="buttons-area">
    <button disabled class="disabled-send-button" id="cf-submit-button">Submit Feedback</button> 
  </div>
  <div class="modal-footer">
    <a href="https://count.ly" target="_new">
      <img src="/star-rating/images/star-rating/powered-by-countly.svg" id="powered-by-countly">
    </a>
  </div>
  </div>
  <div class="success-modal-content">
    <div class="success-icon-area"> 
      <i class="fa fa-check fa-2x"></i> 
    </div>
    <div class="success-emotions-area">
      <p class="question-area" id="thanks-area">Thank you.<br>We received your message.</p>
    </div>
    <div class="buttons-area-on-success"> 
    </div>
    <div class="modal-footer"> 
      <a href="https://count.ly" target="_new">
        <img src="./star-rating/images/star-rating/powered-by-countly.svg" id="powered-by-countly">
      </a>
    </div>
  </div>
<script src="/star-rating/javascripts/tippy.all.min.js"></script>   
<script src="/javascripts/dom/jquery/jquery-1.8.3.min.js"></script>
<script>
  // Some default pre init
  var Countly = Countly || {};
  
  Countly.url = "http://localhost:3001"; 
  Countly.onload = Countly.onload || [];

  (function() {
    var cly = document.createElement('script'); cly.type = 'text/javascript'; 
    cly.async = true;
    // Enter url of script here (see below for other option)
    cly.src = '/javascripts/min/countly.min.js';
    cly.onload = function(){Countly.init()};
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(cly, s);
  })();
  
  Countly.onload.push(function() {
    /*
    Helper methods which we need 
    */
    function hasClass(ele,cls) {
      return !!ele.className.match(new RegExp('(\\s|^)'+cls+'(\\s|$)'));
    }
    function addClass(ele,cls) {
      if (!hasClass(ele,cls)) ele.className += " "+cls;
    }
    function removeClass(ele,cls) {
      if (hasClass(ele,cls)) {
        var reg = new RegExp('(\\s|^)'+cls+'(\\s|$)');
        ele.className=ele.className.replace(reg,' ');
      }
    }
    function asyncForeach(array, fn, atEnd) {
      var at = -1;
      function next(shouldBreak) {
        if (shouldBreak || ++at == array.length) {
          if (atEnd) {
            setTimeout(atEnd);
          }
        } else {
          setTimeout(fn, 0, array[at], next);
        }
      }
      next();
    }
    function isValidEmail(email) { 
      return /^.+@.+\..+$/.test(email); 
    }
    function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    Countly.app_id = getParameterByName('app_id');
    Countly.url = getParameterByName('url');
    Countly.app_key = getParameterByName('app_key');
    var widget_id = getParameterByName('widget_id');
    
    $.ajax({
      "type":"GET",
      // TODO: fix that url after development
      // because of proxy things
      "url":Countly.url+"/o/web-feedback/widget",
      "data": {
        "widget_id":widget_id,
        "app_id":Countly.app_id
      },
      "success": function(response) {
        // replace widget specific strings
        $('#question-area').html(response.popup_header_text);
        $('#cf-comment-text').text(response.popup_comment_callout);
        $('#cf-email-text').text(response.popup_email_callout);
        $('#cf-submit-button').text(response.popup_button_callout);
        $('#thanks-area').html(response.popup_thanks_message);
        if (response.is_suppress) {
          $('#contact-me-email').attr('type','password');
        }
      }
    })
   
    var eventObject = {
      "key":"[CLY]_star_rating",
      "count": 1,
      "segmentation": {
        "widget_id":widget_id,
        "contactMe":false, 
        "platform":"Web", 
        "app_version":1, 
        "platform_version_rate":"",
        "rating":0,
        "email":"",
        "comment":"",
        "app_id":Countly.app_id
      }
    }
   
    tippy('.rating-emotion', { delay: 100, arrow: true, arrowType: 'round', duration: 250, animation: 'scale'});
    // countly feedback elements 
    var contactMeCheckbox = document.getElementById('contact-me-checkbox');
    var contactMeEmailInput = document.getElementById('contact-me-email');
    var modalEmotionImages = document.getElementsByClassName('rating-emotion');
    var sendButton = document.getElementsByClassName('disabled-send-button')[0];
    var showCommentCheckbox = document.getElementById('countly-feedback-show-comment');
    var showEmailCheckbox = document.getElementById('countly-feedback-show-email');
    var showCommentCheckboxMask = document.getElementsByClassName('countly-feedback-show-comment-checkbox')[0];
    var showEmailCheckboxMask = document.getElementsByClassName('countly-feedback-show-email-checkbox')[0];
   
   
    function hideFeedbackPopup() {
      document.getElementsByClassName("modal-content")[0].style.display = "none";  
    }
    function hideSuccessPopup() {
      document.getElementsByClassName("success-modal-content")[0].style.display = "none";      
    }
    function rate(e) {
      var index = parseInt(e.target.dataset.score) - 1;
      eventObject["segmentation"].rating = parseInt(modalEmotionImages[index].getAttribute('data-score'));
      for (var i = 0; i < modalEmotionImages.length; i++) {
         removeClass(modalEmotionImages[i], 'grow');
         modalEmotionImages[i].src = '/star-rating/images/star-rating/' + i + '_gray.svg';
         modalEmotionImages[i].style.transform = "scale(1)";   
         addClass(modalEmotionImages[i], 'grow');
      }
      modalEmotionImages[index].src = '/star-rating/images/star-rating/' + index + '_color.svg'; 
      modalEmotionImages[index].style.transform = "scale(1.2)";
      modalEmotionImages[index].classList.remove("grow");
      removeClass(sendButton, 'disabled-send-button');
      addClass(sendButton, 'send-button');
      sendButton.removeAttribute('disabled');
    }
    function showHideCommentArea() {
      if (showCommentCheckbox.getAttribute('data-state') == 0) {
         document.getElementById('countly-feedback-comment-textarea').style.display = "block";  
         showCommentCheckbox.setAttribute('data-state', 1);
         removeClass(showCommentCheckboxMask, 'fa-square-o');
         addClass(showCommentCheckboxMask, 'fa-check-square');
      } else {
         showCommentCheckbox.setAttribute('data-state', 0);
         removeClass(showCommentCheckboxMask, 'fa-check-square');
         addClass(showCommentCheckboxMask, 'fa-square-o');
         document.getElementById('countly-feedback-comment-textarea').style.display = "none";
      }
    }
    function showHideEmailArea() {
      if (showEmailCheckbox.getAttribute('data-state') == 0) {
         document.getElementById('contact-me-email').style.display = "block"; 
         showEmailCheckbox.setAttribute('data-state', 1);
         removeClass(showEmailCheckboxMask, 'fa-square-o');
         addClass(showEmailCheckboxMask, 'fa-check-square');
      } else {
         showEmailCheckbox.setAttribute('data-state', 0);
         document.getElementById('contact-me-email').style.display = "none";  
         removeClass(showEmailCheckboxMask, 'fa-check-square');
         addClass(showEmailCheckboxMask, 'fa-square-o');
      } 
    }
    // TODO: verification for comment box like email 
    function sendFeedback() {
      if (showEmailCheckbox.getAttribute('data-state') == 1) {
        if(isValidEmail(document.getElementById('contact-me-email').value.trim())) {
          removeClass(document.getElementById('contact-me-email'), 'countly-feedback-verification-fail');
          eventObject["segmentation"].comment = document.getElementById('countly-feedback-comment-textarea').value;
          eventObject["segmentation"].email = document.getElementById('contact-me-email').value;
          Countly._internals.add_cly_events(eventObject);
          document.getElementsByClassName("success-modal-content")[0].style.display = "block";   
          document.getElementsByClassName("modal-content")[0].style.display = "none";      
        } else {
          addClass(document.getElementById('contact-me-email'), 'countly-feedback-verification-fail');
        }
      } else {
        eventObject["segmentation"].comment = document.getElementById('countly-feedback-comment-textarea').value;
        eventObject["segmentation"].email = document.getElementById('contact-me-email').value;
        Countly._internals.add_cly_events(eventObject);
        document.getElementsByClassName("success-modal-content")[0].style.display = "block";   
        document.getElementsByClassName("modal-content")[0].style.display = "none";      
      }
    }
    document.onkeydown = function(evt) {
      evt = evt || window.event;
      var isEscape = false;
      if ("key" in evt) {
         isEscape = (evt.key == "Escape" || evt.key == "Esc");
      } else {
         isEscape = (evt.keyCode == 27);
      }
      if (isEscape) {
         hideFeedbackPopup();
      }
    };
    // event handler for countly feedback show comment area checkbox
    // show hide comment area
    Countly._internals.add_event(showCommentCheckbox, 'change', showHideCommentArea);
     
    // event handler for countly feedback show comment area checkbox
    // show hide comment area
    Countly._internals.add_event(showEmailCheckbox, 'change', showHideEmailArea);

    // event handler for countly feedback sender
    // send feedback
    Countly._internals.add_event(sendButton, 'click', sendFeedback);

    // event handler for countly feedback emotion img
    // rate for feedback
    asyncForeach(modalEmotionImages, function(item, done) {
         Countly._internals.add_event(item, "click", function(e) {
            rate(e);
         })
         done();
      });
    });
</script>
</div>
</body>
</html>