FROM eclipse-temurin:21-jre

ARG SCALA_VERSION=2.13
ARG KAFKA_VERSION=4.0.0
ARG CH_SINK_VERSION=1.3.5

# Install Kafka (includes connect-distributed.sh)
RUN mkdir -p /opt && \
    curl -fSL https://dlcdn.apache.org/kafka/${KAFKA_VERSION}/kafka_${SCALA_VERSION}-${KAFKA_VERSION}.tgz \
      -o /tmp/kafka.tgz && \
    tar -xzf /tmp/kafka.tgz -C /opt && \
    ln -s /opt/kafka_${SCALA_VERSION}-${KAFKA_VERSION} /opt/kafka && \
    rm /tmp/kafka.tgz

# Plugins
RUN mkdir -p /opt/kafka/plugins/clickhouse
# Pull the ClickHouse Sink (Apache-2.0) release ZIP and extract jars
RUN apt-get update && apt-get install -y unzip ca-certificates curl && \
    curl -fSL \
      https://github.com/ClickHouse/clickhouse-kafka-connect/releases/download/v${CH_SINK_VERSION}/clickhouse-kafka-connect-v${CH_SINK_VERSION}.zip \
    -o /tmp/ch-sink.zip && \
    unzip -q /tmp/ch-sink.zip -d /opt/kafka/plugins/clickhouse && \
    rm -rf /var/lib/apt/lists/* /tmp/ch-sink.zip

# Copy minimal config (environment variables will override)
COPY connect-distributed.properties /opt/kafka/config/connect-distributed.properties
COPY clickhouse-connector.json /opt/kafka/config/clickhouse-connector.json

EXPOSE 8083
WORKDIR /opt/kafka
CMD ["bin/connect-distributed.sh", "config/connect-distributed.properties"]